<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematiktr√§nare - Praktiska Gymnasiet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?v=3" async></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        praktiska: {
                            red: '#E3004F', // Praktiskas rosa/r√∂da f√§rg
                            dark: '#1F2937', // M√∂rkgr√• f√∂r text
                            light: '#F9FAFB', // Ljus bakgrund
                            hover: '#C10042'  // M√∂rkare nyans f√∂r hover
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        mjx-container { display: inline-block; margin: 0; padding: 0; font-size: 1.1rem; text-align: left; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        #progressBar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Stil f√∂r kalkylatorn */
        .calculator {
            width: 100%;
            max-width: 300px;
            background-color: #1f2937; /* M√∂rkgr√• */
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .calc-display {
            color: white;
            font-size: 3.5rem;
            font-weight: 300;
            text-align: right;
            padding: 30px 20px 10px;
            overflow: hidden;
            white-space: nowrap;
        }
        .calc-button {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 65px;
            width: 65px;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            margin: 6px;
            color: white;
        }
        .calc-button:active { transform: scale(0.95); }

        /* Funktioner (Ljusgr√•) */
        .calc-func { background-color: #9CA3AF; color: black; }
        /* Operat√∂rer (Praktiska Rosa) */
        .calc-op { background-color: #E3004F; }
        /* NY STIL: MARKERAD OPERAT√ñR (Vit med rosa text) */
        .calc-op-active { 
            background-color: #ffffff !important; 
            color: #E3004F !important; 
        }
        /* Siffror (M√∂rkare gr√•) */
        .calc-num { background-color: #374151; }
        /* Stor noll-knapp */
        .calc-zero { width: 142px; border-radius: 35px; justify-content: start; padding-left: 25px; }

        /* Responsiv layout */
        #mainContainer {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            width: 100%;
            max-width: 1100px;
        }
        @media (max-width: 1024px) {
            #mainContainer {
                flex-direction: column;
                align-items: center;
            }
            .calculator-wrapper {
                order: -1;
                margin-bottom: 20px;
            }
        }
        .calculator-wrapper { transition: opacity 0.3s, transform 0.3s; }

        /* Custom Scrollbar f√∂r snyggare look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #E3004F; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #C10042; }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- Header / Meny (Liknar Praktiska.se) -->
    <nav class="bg-white shadow-md w-full z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20">
                <div class="flex-shrink-0 flex items-center">
                    <!-- Logotyp / Text -->
                    <div class="flex flex-col">
                        <span class="text-2xl font-extrabold text-gray-900 tracking-tight">PRAKTISKA</span>
                        <span class="text-xs font-semibold text-praktiska-red tracking-widest uppercase">Gymnasiet</span>
                    </div>
                </div>
                <div class="flex items-center">
                     <button id="toggleCalculatorBtn" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-full transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        <span class="hidden sm:inline">Kalkylator</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Huvudinneh√•ll -->
    <div class="flex-grow flex justify-center p-4 pt-8">
        <div id="mainContainer">

            <!-- Kalkylatorn -->
            <div id="calculatorWrapper" class="calculator-wrapper w-full max-w-sm lg:w-[300px]" style="display: none;">
                <div class="calculator">
                    <div id="calcDisplay" class="calc-display">0</div>
                    <div id="calcButtons" class="grid grid-cols-4 p-3 gap-1">
                        <div class="calc-button calc-func" data-value="AC">AC</div>
                        <div class="calc-button calc-func" data-value="¬±">¬±</div>
                        <div class="calc-button calc-func" data-value="%">%</div>
                        <div class="calc-button calc-op" data-value="√∑">√∑</div>
                        <div class="calc-button calc-num" data-value="7">7</div>
                        <div class="calc-button calc-num" data-value="8">8</div>
                        <div class="calc-button calc-num" data-value="9">9</div>
                        <div class="calc-button calc-op" data-value="√ó">√ó</div>
                        <div class="calc-button calc-num" data-value="4">4</div>
                        <div class="calc-button calc-num" data-value="5">5</div>
                        <div class="calc-button calc-num" data-value="6">6</div>
                        <div class="calc-button calc-op" data-value="-">-</div>
                        <div class="calc-button calc-num" data-value="1">1</div>
                        <div class="calc-button calc-num" data-value="2">2</div>
                        <div class="calc-button calc-num" data-value="3">3</div>
                        <div class="calc-button calc-op" data-value="+">+</div>
                        <div class="calc-button calc-num calc-zero col-span-2" data-value="0">0</div>
                        <div class="calc-button calc-num" data-value=".">.</div>
                        <div class="calc-button calc-op" data-value="=">=</div>
                    </div>
                </div>
            </div>
            
            <!-- Applikationskort -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 w-full max-w-3xl overflow-hidden">
                
                <!-- Toppdel med Rubrik -->
                <div class="bg-white p-8 pb-4 border-b border-gray-100">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Matematiktr√§nare</h1>
                    <p class="text-gray-500">Tr√§na inf√∂r de nationella proven</p>
                </div>

                <div class="p-6 md:p-8">
                    
                    <!-- L√§gesv√§ljare -->
                    <div id="modeSelector" class="mb-8">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">V√§lj L√§ge</label>
                        <div class="relative">
                            <select id="trainingMode" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-2 focus:ring-praktiska-red focus:border-praktiska-red sm:text-sm rounded-lg bg-gray-50">
                                <option value="campaign">üöÄ Kapiteltr√§ning (Strukturerad)</option>
                                <option value="free">üéØ Typuppgifter nationella proven</option>
                            </select>
                        </div>
                        <p id="modeDescription" class="text-sm text-gray-500 mt-3 ml-1 italic">
                            V√§lj ett kapitel och tr√§na strukturerat.
                        </p>
                    </div>

                    <!-- Po√§ng & Progress -->
                    <div class="flex items-center justify-between mb-2 px-1">
                        <div class="text-sm font-medium text-gray-500">Dina framsteg</div>
                        <div class="flex gap-4 text-sm font-bold">
                            <span class="text-praktiska-red">R√§tt: <span id="scoreDisplay">0</span></span>
                            <span class="text-gray-400">Totalt: <span id="totalDisplay">0</span></span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-3 mb-8 overflow-hidden">
                        <div id="progressBar" class="bg-praktiska-red h-3 rounded-full" style="width: 0%"></div>
                    </div>

                    <!-- Streak-box (Endast kampanj) -->
                    <div id="streakSection" class="mb-8 hidden animate-fade-in">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 flex items-center justify-center gap-3">
                            <span class="text-yellow-600 font-semibold">Nuvarande Streak:</span>
                            <span id="streakDisplay" class="text-2xl font-black text-praktiska-red">0/7 üî•</span>
                            <span id="trophyDisplay" class="text-2xl"></span>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div id="filtersContainer" class="bg-gray-50 p-6 rounded-xl border border-gray-100 mb-8">
                        
                        <!-- Typuppgifter Filters (Utan Sv√•righetsgrad) -->
                        <div id="freeTrainingFilters" class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Niv√•</label>
                                <select id="levelFilter" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-praktiska-red focus:border-praktiska-red"><option value="Alla">Alla Niv√•er</option><option value="√Ök 9">√Ök 9</option><option value="Ma 1">Ma 1</option><option value="Ma 2">Ma 2</option></select>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">√Ñmne</label>
                                <select id="topicFilter" disabled class="w-full p-2.5 border border-gray-300 rounded-md bg-gray-100"><option value="Alla">Alla √Ñmnen</option></select>
                            </div>
                        </div>

                        <!-- Kampanj Filters -->
                        <div id="campaignFilters" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="md:col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kampanj</label>
                                <select id="campaignNameFilter" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-praktiska-red focus:border-praktiska-red">
                                    <option value="Procent">Procent</option>
                                    <option value="Sannolikhet">Sannolikhet</option>
                                    <option value="FunktionerSamband">Funktioner</option>
                                    <option value="Geometri">Geometri</option>
                                    <option value="Algebra">Algebra</option>
                                    <option value="Taluppfattning">Taluppfattning</option>
                                    <option value="Statistik">Statistik</option>
                                </select>
                            </div>
                            <div class="md:col-span-1"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">√Örskurs</label>
                                <select id="campaignLevelFilter" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-praktiska-red focus:border-praktiska-red">
                                    <option value="√Ök 9">√Ök 9</option>
                                    <option value="Ma 1">Ma 1</option>
                                    <option value="Ma 2">Ma 2</option>
                                </select>
                            </div>
                            <div class="md:col-span-3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kapitel Del</label>
                                <select id="chapterPartFilter" class="w-full p-2.5 border border-gray-300 rounded-md focus:ring-praktiska-red focus:border-praktiska-red"></select>
                            </div>
                        </div>
                    </div>

                    <!-- Status & Laddare -->
                    <div id="statusMessage" class="text-center py-12 hidden">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-praktiska-red mb-2"></div>
                        <p class="text-gray-500">Laddar uppgifter...</p>
                    </div>

                    <!-- UPPGIFTSKORT -->
                    <div id="problemCard" class="hidden animate-fade-in">
                        
                        <div class="mb-6">
                            <img id="problemImage" src="" alt="Uppgift" class="max-w-full h-auto mx-auto rounded-lg shadow-sm mb-6" style="display: none;" onerror="this.style.display='none'; this.src='';">
                            <div id="problemText" class="text-xl md:text-2xl font-medium text-gray-800 text-center leading-relaxed"></div>
                        </div>

                        <div id="answerContainer" class="mb-8"></div>

                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="checkAnswerBtn" class="flex-1 bg-praktiska-red text-white text-lg font-bold py-4 px-6 rounded-xl shadow-md hover:bg-praktiska-hover transform hover:-translate-y-0.5 transition duration-200">
                                R√§tta Svar
                            </button>
                            <button id="nextProblemBtn" class="flex-1 bg-gray-800 text-white text-lg font-bold py-4 px-6 rounded-xl shadow-md hover:bg-gray-900 transform hover:-translate-y-0.5 transition duration-200" style="display: none;">
                                N√§sta Uppgift
                            </button>
                        </div>

                        <!-- Feedback -->
                        <div id="feedback" class="mt-6 text-center font-medium p-4 rounded-xl hidden"></div>
                    
                        <!-- L√∂sning Toggle -->
                        <div class="text-center mt-6">
                            <button id="showSolutionBtn" class="text-praktiska-red hover:text-gray-900 font-semibold border-b-2 border-transparent hover:border-praktiska-red transition" style="display: none;">
                                Visa hur man g√∂r
                            </button>
                        </div>

                        <!-- L√∂sningsruta -->
                        <div id="solutionInline" class="mt-6 bg-gray-50 rounded-xl p-6 border border-gray-200 hidden">
                            <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
                                üí° L√∂sning & F√∂rklaring
                            </h3>
                            <div id="solutionText" class="text-gray-700 prose prose-sm max-w-none"></div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="text-center text-xs text-gray-400 mt-12 pt-6 border-t border-gray-100">
                        ID: <span id="userIdDisplay" class="font-mono">...</span>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script type="module">
        console.log("Laddar math_trainer.html (Praktiska Design + Single Count)...");
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD9wbtUB4MUFq1BF00upHxIS6DQK9aS0vQ",
            authDomain: "praktiska-np.firebaseapp.com",
            projectId: "praktiska-np",
            storageBucket: "praktiska-np.firebasestorage.app",
            messagingSenderId: "239785866823",
            appId: "1:239785866823:web:55ffb3a3485d32984ca362"
        };
        
        const appId = 'default-app-id'; 
        
        const COLLECTION_PATHS = {
            FREE_TRAINING: `artifacts/${appId}/public/data/math_tasks`,
            CAMPAIGN_ROOT: `artifacts/${appId}/public/data/campaigns`,
            USER_SCORE: `artifacts/${appId}/users/`
        };
        
        const CAMPAIGN_LEVELS = {
            "Procent": [
                { value: 1, label: "1. Grundl√§ggande procent" },
                { value: 2, label: "2. F√∂r√§ndring & f√∂r√§ndringsfaktor" },
                { value: 3, label: "3. Procentenheter & j√§mf√∂relser" },
                { value: 4, label: "4. Promille & ppm" },
                { value: 5, label: "5. R√§nta & r√§nta p√• r√§nta" },
                { value: 6, label: "6. Flera procentuella f√∂r√§ndringar i rad" },
                { value: 7, label: "7. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Sannolikhet": [
                { value: 1, label: "1. Grundl√§ggande begrepp: utfall, h√§ndelse, chans" },
                { value: 2, label: "2. Enkla sannolikheter" },
                { value: 3, label: "3. Flera utfall & kombinatorik" },
                { value: 4, label: "4. Medelv√§rde, median & typv√§rde" },
                { value: 5, label: "5. Frekvenstabeller & diagram" },
                { value: 6, label: "6. Sammansatta sannolikheter" },
                { value: 7, label: "7. Komplementh√§ndelser" },
                { value: 8, label: "8. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "FunktionerSamband": [
                { value: 1, label: "1. Proportionalitet & grundl√§ggande funktioner" },
                { value: 2, label: "2. Tolka grafer & samband" },
                { value: 3, label: "3. R√§t linje: lutning & m-v√§rde" },
                { value: 4, label: "4. S√§tta in och r√§kna med funktioner" },
                { value: 5, label: "5. Sk√§rningspunkter & j√§mf√∂relser mellan grafer" },
                { value: 6, label: "6. Funktioners f√∂r√§ndring (√∂kning/minskning)" },
                { value: 7, label: "7. f(x)-uppgifter av olika karakt√§r" },
                { value: 8, label: "8. Till√§mpningar & textuppgifter" },
                { value: 9, label: "9. GeoGebra & Nationella provet-niv√• (linj√§ra)" }
            ],
            "Geometri": [
                { value: 1, label: "1. Area och omkrets (kvadrat, rektangel, triangel)" },
                { value: 2, label: "2. Cirkelns area och omkrets" },
                { value: 3, label: "3. Volym & rymdgeometri" },
                { value: 4, label: "4. Enhetsomvandlingar (l√§ngd, area, volym)" },
                { value: 5, label: "5. Skala & likformighet" },
                { value: 6, label: "6. Vinklar & Pythagoras sats" },
                { value: 7, label: "7. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Algebra": [
                { value: 1, label: "1. Ekvationer med + och ‚àí" },
                { value: 2, label: "2. Multiplikation & division" },
                { value: 3, label: "3. x p√• b√•da sidor" },
                { value: 4, label: "4. Parenteser och f√∂renklingar" },
                { value: 5, label: "5. Br√•k och decimaler" },
                { value: 6, label: "6. L√∂sa ut variabler ur formler" },
                { value: 7, label: "7. Faktorisering av uttryck" },
                { value: 8, label: "8. Kombinerade ekvationer och probleml√∂sning" },
                { value: 9, label: "9. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Taluppfattning": [
                { value: 1, label: "1. Grundl√§ggande tal och positionssystem" },
                { value: 2, label: "2. Negativa tal och tallinjen" },
                { value: 3, label: "3. Br√•k och decimaler" },
                { value: 4, label: "4. Procent, promille och andelar" },
                { value: 5, label: "5. Potenser & kvadratr√∂tter" },
                { value: 6, label: "6. Prefix, avrundning och √∂verslagsr√§kning" },
                { value: 7, label: "7. Primtal, faktorisering och delbarhet" },
                { value: 8, label: "8. Reella tal & j√§mf√∂relser" },
                { value: 9, label: "9. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Statistik": [
                { value: 1, label: "1. Stolp-, cirkel- & linjediagram" },
                { value: 2, label: "2. Boxplot & spridningsm√•tt" }
            ]
        };

        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = appId;
        
        // Appens variabler
        let allProblems = []; 
        let currentProblem = null;
        let filteredProblems = [];
        let currentScore = 0;
        let currentTotal = 0;
        let seenProblemIndices = [];
        let currentMode = 'campaign'; 

        let campaignStreak = 0; 
        let chaptersCleared = {}; 
        const STREAK_TO_PASS = 7; 

        let isCheckingAnswer = false; 

        // DOM Elements (Declare ONCE)
        const problemCard = document.getElementById('problemCard');
        const problemText = document.getElementById('problemText');
        const answerContainer = document.getElementById('answerContainer');
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const totalDisplay = document.getElementById('totalDisplay');
        const progressBar = document.getElementById('progressBar');

        const streakDisplay = document.getElementById('streakDisplay'); 
        const trophyDisplay = document.getElementById('trophyDisplay'); 
        
        const trainingMode = document.getElementById('trainingMode'); 
        const freeTrainingFilters = document.getElementById('freeTrainingFilters');
        const campaignFilters = document.getElementById('campaignFilters');
        const modeDescription = document.getElementById('modeDescription');
        
        const levelFilter = document.getElementById('levelFilter');
        const topicFilter = document.getElementById('topicFilter');
        // difficultyFilter BORTTAGET
        
        const campaignNameFilter = document.getElementById('campaignNameFilter');
        const campaignLevelFilter = document.getElementById('campaignLevelFilter');
        const chapterPartFilter = document.getElementById('chapterPartFilter');
        
        const solutionInline = document.getElementById('solutionInline');
        const solutionText = document.getElementById('solutionText');
        const showSolutionBtn = document.getElementById('showSolutionBtn');
        const toggleCalculatorBtn = document.getElementById('toggleCalculatorBtn'); 
        const calculatorWrapper = document.getElementById('calculatorWrapper'); 
        const calcDisplay = document.getElementById('calcDisplay'); 

        
        function getTopicIcon(topic) {
            switch (topic) {
                case "Algebra": return "üßÆ";
                case "Procent": return "üìà";
                case "Geometri": return "üìê";
                case "Tal": return "üî¢";
                case "Samband": return "üìä";
                case "Sannolikhet": return "üé≤";
                case "Statistik": return "üìâ";
                case "FunktionerSamband": return "üìà";
                case "Taluppfattning": return "üî¢";
                default: return "üìö";
            }
        }
        
        // --- L√ÑGESHANTERING ---
        function switchMode() {
            currentMode = trainingMode.value;
            
            resetScore();
            seenProblemIndices = [];
            problemCard.style.display = 'none';
            statusMessage.style.display = 'none';
            
            if (currentMode === 'free') {
                freeTrainingFilters.classList.remove('hidden');
                campaignFilters.classList.add('hidden');
                modeDescription.textContent = "I detta l√§ge tr√§nar du p√• klassiska typuppgifter som ofta kommer p√• nationella proven";
            } else {
                freeTrainingFilters.classList.add('hidden');
                campaignFilters.classList.remove('hidden');
                modeDescription.textContent = "Tr√§na strukturerat kapitel f√∂r kapitel. Klara 7 uppgifter i rad f√∂r att f√• en pokal! üèÜ";
            }
            
            loadAllProblems();
        }

        // --- K√ÑRNFUNKTIONER ---

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                window.getDoc = getDoc;
                window.doc = doc;
                window.setDoc = setDoc;
                window.collection = collection;
                window.getDocs = getDocs;
                window.query = query;
                window.where = where;

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        userIdDisplay.textContent = user.uid;
                        populateChapterPartsFilter(); 
                        loadScore(); 
                        loadAllProblems();
                    } else {
                        signInAnonymously(window.auth).catch((error) => {
                            console.error("Anonym inloggning misslyckades:", error);
                            statusMessage.textContent = "Kunde inte ansluta till servern (Auth).";
                            statusMessage.style.display = "block";
                        });
                    }
                });

            } catch (error) {
                console.error("Firebase Initiering Misslyckades:", error);
                statusMessage.textContent = `Fel vid initiering: ${error.message}`;
                statusMessage.style.display = "block";
            }
        }
        
        function populateChapterPartsFilter() {
            const selectedCampaign = campaignNameFilter.value; 
            const parts = CAMPAIGN_LEVELS[selectedCampaign] || []; 
             
            chapterPartFilter.innerHTML = '';
             parts.forEach(part => {
                const option = document.createElement('option');
                option.value = part.value; 
                option.textContent = part.label;
                chapterPartFilter.appendChild(option);
            });
            applyFiltersAndRender();
        }


        async function loadAllProblems() {
            if (!window.db) return;
            
            let targetPath;
            if (currentMode === 'free') {
                targetPath = COLLECTION_PATHS.FREE_TRAINING;
            } else {
                const campaign = campaignNameFilter.value; 
                targetPath = `${COLLECTION_PATHS.CAMPAIGN_ROOT}/${campaign}/tasks`; 
            }
            
            statusMessage.textContent = `Laddar uppgifter...`;
            statusMessage.style.display = "block";
            
            try {
                const problemsCollection = collection(window.db, targetPath);
                const querySnapshot = await getDocs(problemsCollection);
                
                allProblems = [];
                querySnapshot.forEach((doc) => {
                    allProblems.push({ id: doc.id, ...doc.data() });
                });
                
                if (allProblems.length === 0) {
                    statusMessage.textContent = `Hittade inga uppgifter i mappen '${targetPath.split('/').pop()}'. Kontrollera adminverktyget.`;
                    statusMessage.style.display = "block";
                } else {
                    statusMessage.style.display = "none";
                    problemCard.style.display = "block";
                    if(currentMode === 'free') populateFilters();
                    
                    if (currentMode === 'campaign') {
                         populateChapterPartsFilter(); 
                    } else {
                        applyFiltersAndRender();
                    }
                }

            } catch (error) {
                console.error("Fel vid laddning av uppgifter: ", error);
                statusMessage.textContent = `Fel vid laddning. Kontrollera samlingen '${targetPath.split('/').pop()}' existerar. F√∂rv√§ntad s√∂kv√§g: ${targetPath}`;
                statusMessage.style.display = "block";
                problemCard.style.display = "none";
            }
        }
        
        function populateFilters() {
            const problemsToFilter = allProblems.filter(p => !p.campaignName); 

            const selectedLevel = levelFilter.value;
            let problemsByLevel = (selectedLevel === 'Alla') ? problemsToFilter : problemsToFilter.filter(p => p.level === selectedLevel);
            
            const topics = [...new Set(problemsByLevel.map(p => p.topic || 'Ok√§nt'))];
            topics.sort();
            
            topicFilter.innerHTML = '<option value="Alla">Alla √Ñmnen</option>';
            
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = `${getTopicIcon(topic)} ${topic}`;
                topicFilter.appendChild(option);
            });
            
            topicFilter.disabled = false;
            topicFilter.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }


        function applyFiltersAndRender() {
            let tempFiltered = allProblems;

            if (currentMode === 'free') {
                const selectedLevel = levelFilter.value;
                const selectedTopic = topicFilter.value;
                // Sv√•righetsgrad borttagen
                
                if (selectedLevel !== 'Alla') {
                    tempFiltered = tempFiltered.filter(p => p.level === selectedLevel);
                }
                if (selectedTopic !== 'Alla') {
                    tempFiltered = tempFiltered.filter(p => p.topic === selectedTopic);
                }
            } else {
                const selectedCampaignLevel = campaignLevelFilter.value; 
                const selectedChapterPart = parseInt(chapterPartFilter.value); 
                
                tempFiltered = tempFiltered.filter(p => 
                    p.campaignLevel === selectedCampaignLevel && 
                    p.chapterLevel === selectedChapterPart
                );
            }
            
            filteredProblems = tempFiltered;
            
            if (filteredProblems.length === 0) {
                statusMessage.textContent = "Inga uppgifter matchade ditt val.";
                statusMessage.style.display = "block";
                problemCard.style.display = "none";
                return;
            }
            
            statusMessage.style.display = "none";
            problemCard.style.display = "block";
            
            if (seenProblemIndices.length >= filteredProblems.length) {
                seenProblemIndices = [];
            }

            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * filteredProblems.length);
            } while (seenProblemIndices.includes(newIndex));

            seenProblemIndices.push(newIndex);
            let currentProblemIndexLocal = newIndex;
            currentProblem = filteredProblems[currentProblemIndexLocal];
            
            if (!currentProblem.question_sv || currentProblem.question_sv.trim() === '') {
                 problemText.textContent = "(Uppgiftstext saknas i databasen!)";
            }

            renderProblem(currentProblem);
        }

        function renderProblem(problem) {
            if (!problem) return;

            const question = problem.question_sv || '';
            if (question.trim() === '') {
                problemText.textContent = "(Uppgiftstext saknas i databasen!)";
            } else {
                problemText.textContent = question;
            }

            feedback.style.display = "none";
            checkAnswerBtn.disabled = false;
            checkAnswerBtn.style.display = "block";
            nextProblemBtn.style.display = "none";
            showSolutionBtn.style.display = "none";
            solutionInline.style.display = "none"; 
            answerContainer.innerHTML = ''; 

            const problemImage = document.getElementById('problemImage');
            if (problem.imageUrl) {
                problemImage.src = problem.imageUrl;
                problemImage.style.display = "block";
            } else {
                problemImage.style.display = "none";
            }

            const type = problem.answerType || 'text';
            if (type === 'number') {
                answerContainer.innerHTML = `
                    <label for="answerInput" class="block text-sm font-bold text-gray-700 mb-1">Svar (endast siffror):</label>
                    <input type="number" id="answerInput" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-red focus:border-praktiska-red focus:outline-none text-lg placeholder-gray-400" placeholder="Skriv ditt svar...">
                `;
            } else if (type === 'text') {
                answerContainer.innerHTML = `
                    <label for="answerInput" class="block text-sm font-bold text-gray-700 mb-1">Svar:</label>
                    <input type="text" id="answerInput" class="w-full p-3.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-red focus:border-praktiska-red focus:outline-none text-lg placeholder-gray-400" placeholder="Skriv ditt svar...">
                `;
            }

            if (window.MathJax) {
                MathJax.typesetPromise([problemText]);
            }
        }
        
        function checkAnswer() {
            if (isCheckingAnswer) {
                return; 
            }
            isCheckingAnswer = true;
            checkAnswerBtn.disabled = true; 

            const answerInput = document.getElementById('answerInput');
            if (!answerInput) {
                isCheckingAnswer = false;
                return;
            }

            const userAnswer = answerInput.value.trim();
            const correctAnswer = String(currentProblem.correctAnswer).trim();
            
            let isCorrect = false;

            if (currentProblem.answerType === 'number') {
                isCorrect = parseFloat(userAnswer) === parseFloat(correctAnswer);
            } else {
                isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            }

            currentTotal++; 

            if (isCorrect) {
                feedback.textContent = "R√§tt svar!";
                feedback.className = "mt-4 text-center font-medium p-3 rounded-lg bg-green-100 text-green-700";
                currentScore++; 
                campaignStreak++; 
            } else {
                feedback.textContent = `Inte riktigt! R√§tt svar var: ${correctAnswer}. Klicka p√• 'Visa f√∂rklaring' f√∂r att se hur man g√∂r.`;
                feedback.className = "mt-4 text-center font-medium p-3 rounded-lg bg-red-100 text-red-700";
                campaignStreak = 0; 
            }
            
            if (currentMode === 'campaign' && isCorrect && campaignStreak >= STREAK_TO_PASS) {
                markChapterCleared();
            }

            updateScoreDisplay();
            updateStreakDisplay(); 
            saveScore(); 
            
            isCheckingAnswer = false; 

            feedback.style.display = "block";
            checkAnswerBtn.style.display = "none";
            nextProblemBtn.style.display = "block";
            showSolutionBtn.style.display = "inline"; 
        }

        function markChapterCleared() {
            const campaign = campaignNameFilter.value;
            const chapter = parseInt(chapterPartFilter.value);
            
            if (!chaptersCleared[campaign]) {
                chaptersCleared[campaign] = {};
            }
            chaptersCleared[campaign][chapter] = true;
            campaignStreak = 0; 
            saveScore();
            updateStreakDisplay();
            
            alert(`GRATTIS! Du har klarat ${campaign} - Del ${CAMPAIGN_LEVELS[campaign].find(p => p.value === chapter).label}!`);
        }


        function showSolution() {
            if (!currentProblem || !currentProblem.explanation_sv) {
                solutionText.textContent = "Det finns tyv√§rr ingen f√∂rklaring till den h√§r uppgiften.";
            } else {
                solutionText.textContent = currentProblem.explanation_sv;
            }
            
            solutionInline.style.display = "block"; 
            showSolutionBtn.style.display = "none"; 
            
            if (window.MathJax) {
                MathJax.typesetPromise([solutionText]);
            }
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = currentScore;
            totalDisplay.textContent = currentTotal;
            updateProgressBar();
        }

        function updateProgressBar() {
            let percent;
             if (currentMode === 'campaign') {
                percent = (campaignStreak / STREAK_TO_PASS) * 100;
                if (percent > 100) percent = 100; 
            } else {
                percent = (currentTotal === 0) ? 0 : (currentScore / currentTotal) * 100;
            }
            progressBar.style.width = `${percent}%`;
        }

        function updateStreakDisplay() {
            const streakSection = document.getElementById('streakSection');
            const streakDisplayEl = document.getElementById('streakDisplay');
            const trophyDisplayEl = document.getElementById('trophyDisplay');
            
            if (currentMode === 'campaign') {
                streakSection.classList.remove('hidden');
                streakDisplayEl.textContent = `${campaignStreak}/${STREAK_TO_PASS} üî•`;
                
                const campaign = campaignNameFilter.value;
                const chapter = parseInt(chapterPartFilter.value);

                const isCleared = chaptersCleared[campaign] && chaptersCleared[campaign][chapter];

                if (isCleared) {
                    trophyDisplayEl.innerHTML = 'üèÜ';
                    streakDisplayEl.classList.remove('text-praktiska-red');
                    streakDisplayEl.classList.add('text-green-600');
                } else {
                    trophyDisplayEl.innerHTML = '';
                    streakDisplayEl.classList.add('text-praktiska-red');
                    streakDisplayEl.classList.remove('text-green-600');
                }
                
            } else {
                streakSection.classList.add('hidden');
            }
        }
        
        async function loadScore() {
            if (!window.userId || !window.db) return;
            const scoreDocPath = `${COLLECTION_PATHS.USER_SCORE}${window.userId}/progress/score_data`;
            try {
                const docRef = doc(window.db, scoreDocPath);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentScore = data.score || 0;
                    currentTotal = data.total || 0;
                    campaignStreak = data.streak || 0; 
                    chaptersCleared = data.cleared || {}; 
                }
            } catch (error) { console.error("Fel vid laddning av po√§ng:", error); }
            updateScoreDisplay();
            updateStreakDisplay(); 
        }
        
        async function saveScore() {
            if (!window.userId || !window.db) return;
            const scoreDocPath = `${COLLECTION_PATHS.USER_SCORE}${window.userId}/progress/score_data`;
            try {
                const docRef = doc(window.db, scoreDocPath);
                await setDoc(docRef, { 
                    score: currentScore, 
                    total: currentTotal,
                    streak: campaignStreak, 
                    cleared: chaptersCleared 
                }, { merge: true });
            } catch (error) { console.error("Fel vid sparning av po√§ng:", error); }
        }

        function resetScore(fullReset = true) {
            if (fullReset) {
                currentScore = 0;
                currentTotal = 0;
                updateScoreDisplay();
                saveScore(); 
            }
            seenProblemIndices = []; 
            campaignStreak = 0; 
            updateStreakDisplay();
        }


        // --- EVENT LISTENERS ---
        
        trainingMode.addEventListener('change', switchMode);
        
        campaignNameFilter.addEventListener('change', () => { resetScore(true); loadAllProblems(); });
        campaignLevelFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
        chapterPartFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });

        levelFilter.addEventListener('change', () => { resetScore(true); populateFilters(); applyFiltersAndRender(); });
        topicFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
        // difficultyFilter BORTTAGET

        checkAnswerBtn.addEventListener('click', checkAnswer);
        nextProblemBtn.addEventListener('click', applyFiltersAndRender);
        showSolutionBtn.addEventListener('click', showSolution);
        
        toggleCalculatorBtn.addEventListener('click', () => {
            const isVisible = calculatorWrapper.style.display !== 'none';
            calculatorWrapper.style.display = isVisible ? 'none' : 'block';
            toggleCalculatorBtn.textContent = isVisible ? 'Visa Kalkylator' : 'D√∂lj Kalkylator';
        });

        // Kalkylator-logik
        const calcButtons = document.getElementById('calcButtons');
        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        let awaitingSecondOperand = false;
        
        function clearOperatorHighlight() {
            document.querySelectorAll('.calc-op').forEach(btn => {
                btn.classList.remove('calc-op-active');
                btn.style.backgroundColor = '#E3004F'; 
            });
        }

        calcButtons.addEventListener('click', (event) => {
            if (!event.target.classList.contains('calc-button')) return;

            const value = event.target.dataset.value;
            
            if (event.target.classList.contains('calc-num') || value === '.') {
                clearOperatorHighlight(); 
                
                if (awaitingSecondOperand) {
                    currentInput = value === '.' ? '0.' : value;
                    awaitingSecondOperand = false;
                } else if (currentInput === '0' && value !== '.') {
                    currentInput = value;
                } else if (value === '.' && currentInput.includes('.')) {
                    
                } else {
                    currentInput += value;
                }
            } else if (event.target.classList.contains('calc-op')) {
                if (value === '=') {
                    if (operator && firstOperand !== null) {
                        currentInput = calculate(firstOperand, operator, parseFloat(currentInput));
                        operator = null;
                        firstOperand = null;
                        awaitingSecondOperand = true;
                    }
                    clearOperatorHighlight();
                } else {
                    clearOperatorHighlight();
                    event.target.classList.add('calc-op-active');

                    if (firstOperand === null) {
                        firstOperand = parseFloat(currentInput);
                    } else if (operator) {
                        const result = calculate(firstOperand, operator, parseFloat(currentInput));
                        firstOperand = result;
                        currentInput = result;
                    }
                    operator = value;
                    awaitingSecondOperand = true;
                }
            } else if (event.target.classList.contains('calc-func')) {
                clearOperatorHighlight();
                if (value === 'AC') {
                    currentInput = '0';
                    operator = null;
                    firstOperand = null;
                    awaitingSecondOperand = false;
                } else if (value === '¬±') {
                    currentInput = String(parseFloat(currentInput) * -1);
                } else if (value === '%') {
                    currentInput = String(parseFloat(currentInput) / 100);
                }
            }
            
            calcDisplay.textContent = currentInput.substring(0, 10);
        });

        function calculate(num1, op, num2) {
            switch (op) {
                case '+': return String(num1 + num2);
                case '-': return String(num1 - num2);
                case '√ó': return String(num1 * num2);
                case '√∑': return String(num1 / num2);
                default: return num2;
            }
        }
        
        window.switchMode = switchMode;
        window.loadAllProblems = loadAllProblems;
        window.applyFiltersAndRender = applyFiltersAndRender;
        window.checkAnswer = checkAnswer;
        window.showSolution = showSolution;
        
        initializeFirebase();
        
    </script>
</body>
</html>