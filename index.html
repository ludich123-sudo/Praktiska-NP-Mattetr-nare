<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Praktiska Gymnasiets Matematiktr√§nare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@300;400;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      options: {
        enableMenu: false,
        renderActions: {
          addMenu: []
        }
      },
      startup: {
        typeset: true,
        ready: () => {
          MathJax.startup.defaultReady();
          console.log('MathJax ready!');
        }
      }
    };
    </script>
    <script id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <style>
        :root {
            --primary-orange: #f06f00;
            --primary-orange-light: #ff8c33;
            --primary-orange-dark: #d45f00;
            --dark-bg: #1a1a1a;
            --dark-surface: #2d2d2d;
            --dark-card: #363636;
            --light-bg: #f8f9fa;
            --light-surface: #ffffff;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%); 
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        body.light-mode {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
        }
        
        body.light-mode .problem-container {
            background: white;
            color: #1f2937;
        }
        
        body.light-mode .problem-text-block {
            color: #1f2937;
        }
        
        /* Styles identical to admin preview */
        .problem-container {
            font-family: 'Merriweather', serif;
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            min-height: 200px;
        }
        
        .problem-text-block {
            font-family: 'Merriweather', serif;
            font-size: 1.15rem;
            line-height: 1.8;
            color: #1f2937;
            display: block;
            margin-bottom: 0.75rem;
        }
        
        .problem-math-block {
            font-family: 'Inter', sans-serif;
            margin: 1rem 0;
            text-align: center;
            font-size: 1.4rem;
            display: block;
        }
        
        .step-block {
            background: #f0fdf4;
            border-left: 4px solid #16a34a;
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            color: #1f2937;
        }
        
        .step-number {
            font-weight: bold;
            color: #16a34a;
            margin-right: 0.5rem;
        }

        .scaffold-block {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            color: #1f2937;
        }

        .scaffold-number {
            font-weight: bold;
            color: #d97706;
            margin-right: 0.5rem;
        }

        /* Genomg√•ng styles */
        .genomgang-tip {
            background: #f0fdf4;
            border-left: 4px solid #16a34a;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .genomgang-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .genomgang-example {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .genomgang-h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1.5rem 0 1rem;
            color: #1e1b4b;
        }
        .genomgang-h3 {
            font-size: 1.25rem;
            font-weight: bold;
            margin: 1.5rem 0 0.75rem;
            color: var(--primary-orange);
        }
        .genomgang-h4 {
            font-size: 1.1rem;
            font-weight: bold;
            margin: 1rem 0 0.5rem;
        }
        .genomgang-paragraph {
            margin-bottom: 1rem;
            line-height: 1.8;
        }
        .genomgang-list-item {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* MathJax */
        mjx-container[jax="CHTML"][display="true"] { display: block !important; text-align: center; margin: 0.5rem 0 !important; }
        mjx-container { margin: 0 3px !important; }

        /* Animations */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: slideIn 0.3s ease-out; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s infinite; }

        /* EPIC Streak glow effect */
        @keyframes streakGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(251, 191, 36, 0.6), 0 0 40px rgba(251, 191, 36, 0.4), 0 0 60px rgba(251, 191, 36, 0.2);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 30px rgba(251, 191, 36, 0.9), 0 0 60px rgba(251, 191, 36, 0.6), 0 0 90px rgba(251, 191, 36, 0.4);
                transform: scale(1.05);
            }
        }
        
        @keyframes fireGlow {
            0%, 100% { text-shadow: 0 0 10px #ff6b00, 0 0 20px #ff4500, 0 0 30px #ff0000; transform: scale(1); }
            50% { text-shadow: 0 0 20px #ff6b00, 0 0 40px #ff4500, 0 0 60px #ff0000; transform: scale(1.1); }
        }
        
        @keyframes successPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        @keyframes multiplierPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }
        
        @keyframes questGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 25px rgba(34, 197, 94, 0.7); }
        }
        
        @keyframes pointsEarned {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-30px) scale(1.5); opacity: 0; }
        }
        
        /* Shake animation for wrong answers */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* Font size classes */
        body.font-large .problem-text-block { font-size: 1.35rem; }
        body.font-large .answer-input { font-size: 1.5rem; }
        body.font-large .scaffold-block, body.font-large .step-block { font-size: 1.2rem; }
        
        body.font-xlarge .problem-text-block { font-size: 1.55rem; }
        body.font-xlarge .answer-input { font-size: 1.75rem; }
        body.font-xlarge .scaffold-block, body.font-xlarge .step-block { font-size: 1.4rem; }
        
        /* Dyslexia font */
        body.dyslexia-font .problem-text-block,
        body.dyslexia-font .scaffold-block,
        body.dyslexia-font .step-block,
        body.dyslexia-font .answer-input,
        body.dyslexia-font .genomgang-paragraph,
        body.dyslexia-font .genomgang-tip,
        body.dyslexia-font .genomgang-warning,
        body.dyslexia-font .genomgang-example {
            font-family: 'OpenDyslexic', 'Merriweather', serif;
            letter-spacing: 0.05em;
            line-height: 2;
        }
        
        /* Session progress bar */
        .session-progress-container {
            background: rgba(0,0,0,0.1);
            border-radius: 999px;
            height: 8px;
            overflow: hidden;
        }
        body.light-mode .session-progress-container {
            background: #e2e8f0;
        }
        .session-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            border-radius: 999px;
            transition: width 0.4s ease;
        }
        
        /* Show Solution Button */
        .btn-show-solution {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        .btn-show-solution:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        /* Skip button */
        .btn-skip {
            background: #f1f5f9;
            color: #64748b;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
        }
        .btn-skip:hover {
            background: #e2e8f0;
            color: #475569;
        }
        
        /* Solution reveal animation */
        @keyframes revealStep {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .solution-step-reveal {
            animation: revealStep 0.4s ease-out forwards;
            opacity: 0;
        }
        
        .streak-glow {
            animation: streakGlow 1.5s ease-in-out infinite;
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
        }
        
        .streak-fire {
            animation: fireGlow 0.5s ease-in-out infinite;
        }

        .streak-legendary {
            animation: legendaryGlow 1s ease-in-out infinite !important;
            background: linear-gradient(135deg, #9333ea, #ec4899, #f59e0b) !important;
            background-size: 200% 200% !important;
        }

        @keyframes legendaryGlow {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(147, 51, 234, 0.8), 0 0 60px rgba(236, 72, 153, 0.6), 0 0 90px rgba(245, 158, 11, 0.4);
                transform: scale(1);
                background-position: 0% 50%;
            }
            50% { 
                box-shadow: 0 0 50px rgba(147, 51, 234, 1), 0 0 100px rgba(236, 72, 153, 0.8), 0 0 150px rgba(245, 158, 11, 0.6);
                transform: scale(1.08);
                background-position: 100% 50%;
            }
        }
        
        .success-pop { animation: successPop 0.4s ease-out; }
        
        .multiplier-badge {
            animation: multiplierPulse 1s ease-in-out infinite;
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
            padding: 2px 8px;
            border-radius: 9999px;
            font-weight: 800;
            font-size: 12px;
            margin-left: 6px;
        }
        
        .quest-active {
            animation: questGlow 2s ease-in-out infinite;
        }
        
        .points-popup {
            position: fixed;
            pointer-events: none;
            z-index: 10001;
            font-weight: 900;
            font-size: 24px;
            color: #fbbf24;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.8);
            animation: pointsEarned 1s ease-out forwards;
        }
        
        .daily-quest-card {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }
        
        .daily-quest-card.completed {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15));
            border-color: rgba(251, 191, 36, 0.5);
        }
        
        .task-progress-indicator {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
        }
        body.light-mode .task-progress-indicator {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        body.light-mode .task-progress-indicator span {
            color: #374151;
        }
        
        /* Quest Modal Styles */
        .quest-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s;
        }
        .quest-card.quest-completed {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));
            border-color: rgba(34, 197, 94, 0.5);
        }
        .quest-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quest-card.quest-completed .quest-icon {
            background: rgba(34, 197, 94, 0.2);
        }
        .quest-title {
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }
        .quest-desc {
            color: #9ca3af;
            font-size: 0.8rem;
        }
        .quest-reward {
            color: #fbbf24;
            font-weight: 700;
            font-size: 0.85rem;
        }
        .quest-progress-text {
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
        }
        .quest-status-active {
            font-size: 0.7rem;
            color: #a78bfa;
            font-weight: 600;
        }
        .quest-status-done {
            font-size: 0.7rem;
            color: #22c55e;
            font-weight: 700;
        }
        .quest-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .quest-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a855f7);
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .quest-bar-fill.quest-bar-streak {
            background: linear-gradient(90deg, #f97316, #ef4444);
        }
        .quest-bar-fill.completed {
            background: linear-gradient(90deg, #22c55e, #10b981);
        }
        
        .quest-progress-bar {
            height: 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #10b981);
            border-radius: 6px;
            transition: width 0.5s ease;
        }
        
        .quest-progress-fill.completed {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }

        /* ============ CALCULATOR STYLES ============ */
        .calculator {
            position: fixed;
            z-index: 10000;
            background: #1c1c1e;
            border-radius: 24px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            padding: 16px;
            width: 280px;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            touch-action: none;
            user-select: none;
        }
        
        .calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: move;
            padding: 8px;
            background: #2c2c2e;
            border-radius: 12px;
        }
        
        .calc-close {
            background: #ff3b30;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            cursor: pointer;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calc-display {
            background: #1c1c1e;
            color: white;
            font-size: 48px;
            text-align: right;
            padding: 20px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            min-height: 80px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            overflow: hidden;
            word-break: break-all;
        }
        
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .calc-btn {
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calc-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        .calc-btn-num {
            background: #333;
            color: white;
        }
        
        .calc-btn-num:hover {
            background: #505050;
        }
        
        .calc-btn-op {
            background: #ff9500;
            color: white;
        }
        
        .calc-btn-op:hover {
            background: #ffb143;
        }
        
        .calc-btn-op.active {
            background: white;
            color: #ff9500;
        }
        
        .calc-btn-func {
            background: #a5a5a5;
            color: black;
        }
        
        .calc-btn-func:hover {
            background: #d4d4d4;
        }
        
        .calc-btn-zero {
            grid-column: span 2;
            width: 100%;
            border-radius: 28px;
            justify-content: flex-start;
            padding-left: 22px;
        }

        .calc-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #1c1c1e, #333);
            color: white;
            border: none;
            min-width: 60px;
            height: 60px;
            border-radius: 30px;
            padding: 0 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .calc-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(0,0,0,0.5);
        }
        
        .calc-toggle-btn span {
            display: none;
        }
        
        @media (min-width: 640px) {
            .calc-toggle-btn span {
                display: inline;
            }
        }

        /* Confetti canvas */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: #404040;
            border-radius: 4px;
            overflow: hidden;
        }
        body.light-mode .progress-bar {
            background: #e2e8f0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-orange), var(--primary-orange-light));
            transition: width 0.3s ease;
        }

        /* Modern Answer Area - Mappi-inspired */
        .answer-container {
            background: var(--dark-surface);
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        body.light-mode .answer-container {
            background: white;
        }
        
        .answer-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #2a2a2e;
            border: 3px solid var(--primary-orange);
            border-radius: 12px;
            transition: all 0.2s;
            box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15);
        }
        body.light-mode .answer-input-wrapper {
            background: #f8fafc;
            border-color: var(--primary-orange);
        }
        .answer-input-wrapper:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.25);
        }
        
        .answer-input {
            flex: 1;
            font-size: 1.1rem;
            padding: 8px 0;
            border: none;
            background: transparent;
            color: white;
            font-weight: 500;
            outline: none;
        }
        body.light-mode .answer-input {
            color: #1f2937;
        }
        .answer-input::placeholder {
            color: #9ca3af;
        }
        .answer-input.correct {
            color: #22c55e;
        }
        .answer-input.incorrect {
            color: #ef4444;
        }

        /* Math Toggle Button */
        .math-toggle-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #333;
            border: 1px solid #444;
            color: #9ca3af;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
        }
        body.light-mode .math-toggle-btn {
            background: #f1f5f9;
            border-color: #e2e8f0;
            color: #64748b;
        }
        .math-toggle-btn:hover {
            background: #444;
            color: #8b5cf6;
        }
        body.light-mode .math-toggle-btn:hover {
            background: #e2e8f0;
        }
        .math-toggle-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: #8b5cf6;
        }

        /* Submit Button - Message style arrow */
        .submit-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
            flex-shrink: 0;
        }
        .submit-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.5);
        }
        .submit-btn:active {
            transform: scale(0.95);
        }
        .submit-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Preview Section */
        .preview-section {
            background: #1f1f23;
            border-top: 1px solid #333;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.light-mode .preview-section {
            background: #fafafa;
            border-color: #e5e7eb;
        }
        .preview-label {
            font-size: 0.75rem;
            color: #6b7280;
            white-space: nowrap;
        }
        body.light-mode .preview-label {
            color: #9ca3af;
        }
        .preview-content {
            flex: 1;
            font-size: 1rem;
            color: #d1d5db;
            min-height: 24px;
        }
        body.light-mode .preview-content {
            color: #374151;
        }
        .preview-empty {
            color: #6b7280;
            font-style: italic;
        }

        /* Hint Section - Smooth Slide Animation */
        .hint-section-collapsed {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-bottom: 0;
            transition: max-height 0.35s ease-out, opacity 0.25s ease-out, margin-bottom 0.35s ease-out;
        }
        .hint-section-expanded {
            max-height: 150px;
            opacity: 1;
            margin-bottom: 12px;
            transition: max-height 0.35s ease-out, opacity 0.25s ease-in, margin-bottom 0.35s ease-out;
        }
        .hint-inner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            border-radius: 0 12px 12px 0;
            padding: 12px 16px;
            color: #92400e;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        body.light-mode .hint-inner {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }

        /* Scaffold Section - Smooth Slide Animation */
        .scaffold-section-collapsed {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            margin-bottom: 0;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-out, margin-bottom 0.4s ease-out;
        }
        .scaffold-section-expanded {
            max-height: 500px;
            opacity: 1;
            margin-bottom: 12px;
            transition: max-height 0.4s ease-out, opacity 0.3s ease-in, margin-bottom 0.4s ease-out;
        }
        .scaffold-inner {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-radius: 12px;
            border: 1px solid #fcd34d;
            overflow: hidden;
        }
        .scaffold-header {
            background: #fde68a;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .scaffold-content {
            padding: 12px 16px;
        }
        .scaffold-step {
            background: white;
            border-left: 3px solid #f59e0b;
            padding: 10px 14px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            color: #1f2937;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .scaffold-step:last-child {
            margin-bottom: 0;
        }
        .scaffold-step-number {
            font-weight: 700;
            color: #d97706;
            margin-right: 8px;
        }

        /* Math Input Toolbar - Collapsible */
        .math-toolbar {
            display: none;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px 16px;
            background: #252529;
            border-top: 1px solid #333;
            animation: slideDown 0.2s ease;
        }
        .math-toolbar.visible {
            display: flex;
        }
        body.light-mode .math-toolbar {
            background: #f1f5f9;
            border-color: #e2e8f0;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .math-btn {
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            font-family: 'Inter', sans-serif;
            color: white;
        }
        body.light-mode .math-btn {
            background: white;
            border-color: #e2e8f0;
            color: #374151;
        }
        
        .math-btn:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
            transform: translateY(-1px);
        }
        body.light-mode .math-btn:hover {
            background: #f5f3ff;
        }
        
        .math-btn:active {
            transform: scale(0.95);
        }
        
        .math-btn-label {
            font-size: 11px;
            color: #9ca3af;
            margin-left: 4px;
        }
        body.light-mode .math-btn-label {
            color: #64748b;
        }

        /* Action Buttons Row */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .action-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: #2a2a2e;
            border: 1px solid #404040;
            color: #9ca3af;
        }
        body.light-mode .action-btn {
            background: #f1f5f9;
            border-color: #e2e8f0;
            color: #64748b;
        }
        .action-btn:hover {
            background: #333;
            color: #d1d5db;
        }
        body.light-mode .action-btn:hover {
            background: #e2e8f0;
            color: #374151;
        }
        .action-btn.help-btn {
            background: #fef3c7;
            border-color: #fcd34d;
            color: #92400e;
        }
        .action-btn.help-btn:hover {
            background: #fde68a;
        }
        .action-btn.skip-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }
        body.light-mode .action-btn.skip-btn:hover {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        /* Answer hint */
        .answer-hint {
            font-size: 11px;
            color: #64748b;
            margin-top: 6px;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-light));
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: 700;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(240, 111, 0, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 111, 0, 0.5);
        }

        .btn-secondary {
            background: var(--dark-surface);
            color: var(--primary-orange);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: 2px solid var(--primary-orange);
            transition: all 0.2s;
        }
        body.light-mode .btn-secondary {
            background: white;
        }
        .btn-secondary:hover {
            background: var(--primary-orange);
            color: white;
        }

        /* Quests Toggle Button - LOWER z-index so it doesn't block modals */
        .quests-toggle-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 40;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            border: none;
            color: white;
            min-width: 50px;
            height: 50px;
            border-radius: 25px;
            padding: 0 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            font-weight: 700;
        }
        .quests-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(139, 92, 246, 0.6);
        }
        .quests-notification {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        /* Topic/Chapter selector */
        .selector-card {
            background: var(--dark-surface);
            border: 2px solid #404040;
            border-radius: 1rem;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }
        body.light-mode .selector-card {
            background: white;
            border-color: #e2e8f0;
            color: #1f2937;
        }
        .selector-card:hover {
            border-color: var(--primary-orange);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 111, 0, 0.2);
        }
        .selector-card.active {
            border-color: var(--primary-orange);
            background: rgba(240, 111, 0, 0.1);
        }
        .selector-card h3 {
            color: inherit;
        }
        .selector-card p {
            color: #9ca3af;
        }
        body.light-mode .selector-card p {
            color: #6b7280;
        }

        /* Header styles */
        .app-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .app-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
            font-size: 1.25rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        body.light-mode .app-title {
            color: #1a1a1a;
        }
        @media (min-width: 640px) {
            .app-title {
                font-size: 2rem;
            }
        }
        .math-icon {
            background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-light));
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(240, 111, 0, 0.4);
        }
        .app-subtitle {
            color: #9ca3af;
            font-size: 1rem;
        }
        body.light-mode .app-subtitle {
            color: #6b7280;
        }
        
        /* Points display */
        .points-display {
            animation: pointsGlow 2s ease-in-out infinite alternate;
        }
        @keyframes pointsGlow {
            from { box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); }
            to { box-shadow: 0 4px 25px rgba(245, 158, 11, 0.7); }
        }
        @media (max-width: 640px) {
            .points-display {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
        }
        
        /* Username display */
        .username-display {
            font-size: 0.875rem;
        }
        @media (max-width: 640px) {
            .username-display {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            .username-display span:first-child {
                display: none;
            }
        }

        /* Panel backgrounds */
        .mode-panel {
            background: rgba(45, 45, 45, 0.8);
            backdrop-filter: blur(10px);
        }
        body.light-mode .mode-panel {
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Settings panel */
        .settings-panel {
            background: var(--dark-surface);
            color: white;
        }
        body.light-mode .settings-panel {
            background: white;
            color: #1f2937;
        }
        .settings-panel label {
            color: #9ca3af;
        }
        body.light-mode .settings-panel label {
            color: #4b5563;
        }
        .settings-panel select {
            background: var(--dark-card);
            border-color: #404040;
            color: white;
        }
        body.light-mode .settings-panel select {
            background: white;
            border-color: #e2e8f0;
            color: #1f2937;
        }

        /* Genomgang button */
        .genomgang-btn {
            background: rgba(240, 111, 0, 0.15);
            color: var(--primary-orange);
            border: 1px solid rgba(240, 111, 0, 0.3);
        }
        .genomgang-btn:hover {
            background: rgba(240, 111, 0, 0.25);
        }

        /* Leaderboard styles */
        .leaderboard-container {
            animation: leaderboardSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes leaderboardSlideIn {
            from { transform: scale(0.8) translateY(50px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        .leaderboard-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(4px);
        }
        .leaderboard-item.gold {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,193,7,0.1));
            border-color: rgba(255,215,0,0.4);
            box-shadow: 0 0 20px rgba(255,215,0,0.2);
        }
        .leaderboard-item.silver {
            background: linear-gradient(135deg, rgba(192,192,192,0.2), rgba(169,169,169,0.1));
            border-color: rgba(192,192,192,0.4);
            box-shadow: 0 0 15px rgba(192,192,192,0.15);
        }
        .leaderboard-item.bronze {
            background: linear-gradient(135deg, rgba(205,127,50,0.2), rgba(184,115,51,0.1));
            border-color: rgba(205,127,50,0.4);
            box-shadow: 0 0 15px rgba(205,127,50,0.15);
        }
        .leaderboard-item.you {
            background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.2));
            border-color: rgba(99,102,241,0.5);
            animation: pulseYou 2s infinite;
        }
        @keyframes pulseYou {
            0%, 100% { box-shadow: 0 0 10px rgba(99,102,241,0.3); }
            50% { box-shadow: 0 0 25px rgba(99,102,241,0.5); }
        }
        
        .rank-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-weight: 900;
            font-size: 14px;
            margin-right: 12px;
        }
        .rank-badge.gold {
            background: linear-gradient(135deg, #ffd700, #ffb700);
            color: #7c5800;
            font-size: 20px;
        }
        .rank-badge.silver {
            background: linear-gradient(135deg, #e8e8e8, #c0c0c0);
            color: #555;
            font-size: 20px;
        }
        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #b87333);
            color: #5a3510;
            font-size: 20px;
        }
        .rank-badge.normal {
            background: rgba(255,255,255,0.1);
            color: #888;
        }
        
        .player-name {
            flex: 1;
            font-weight: 600;
            color: white;
            font-size: 14px;
        }
        .player-stats {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .player-points {
            font-weight: 800;
            color: #fbbf24;
            font-size: 14px;
        }
        .player-quests {
            font-weight: 700;
            color: #a78bfa;
            font-size: 14px;
        }
        
        .leaderboard-header {
            animation: shimmer 3s infinite;
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Task area panel */
        .task-progress-panel {
            background: rgba(45, 45, 45, 0.8);
            backdrop-filter: blur(10px);
        }
        body.light-mode .task-progress-panel {
            background: rgba(255, 255, 255, 0.9);
        }

        /* Answer section */
        .answer-section {
            background: var(--dark-surface);
            color: white;
        }
        body.light-mode .answer-section {
            background: white;
            color: #1f2937;
        }
        
        body.light-mode .math-toolbar {
            background: #f8fafc;
            border-color: #e2e8f0;
        }
        .math-toolbar {
            background: var(--dark-card);
            border-color: #404040;
        }
        
        body.light-mode .math-btn {
            background: white;
            border-color: #e2e8f0;
            color: #1f2937;
        }
        .math-btn {
            background: var(--dark-surface);
            border-color: #404040;
            color: white;
        }

        /* Mode title */
        .mode-title {
            color: white;
        }
        body.light-mode .mode-title {
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Quests Button -->
    <button class="quests-toggle-btn" onclick="showQuestsModal()" title="Visa Quests">
        <span class="text-xl">üìã</span>
        <span class="hidden sm:inline">Quests</span>
        <span id="questsNotification" class="quests-notification hidden">!</span>
    </button>

    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="app-header text-center mb-8">
            <div class="flex items-center justify-between w-full">
                <div class="username-display bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-2 rounded-xl font-bold shadow-lg flex items-center gap-2 cursor-pointer hover:scale-105 transition-transform" onclick="showSyncModal()" title="Synka profil mellan enheter">
                    <span>üéÆ</span>
                    <span id="usernameDisplay" class="text-sm">...</span>
                    <span class="text-xs opacity-70">üîó</span>
                </div>
                <h1 class="app-title">
                    <span class="math-icon">üìê</span>
                    <span class="hidden sm:inline">Matematiktr√§nare</span>
                    <span class="sm:hidden">Matte</span>
                </h1>
                <div class="points-display bg-gradient-to-r from-amber-500 to-orange-500 text-white px-3 py-2 rounded-xl font-bold shadow-lg flex items-center gap-2 cursor-pointer hover:scale-105 transition-transform" onclick="showLeaderboard()" title="Visa topplista">
                    <span>‚≠ê</span>
                    <span id="totalPoints">0</span>
                    <span class="text-xs opacity-80 hidden sm:inline">po√§ng</span>
                    <span class="text-lg">üèÜ</span>
                </div>
            </div>
            <p class="app-subtitle mt-4">Tr√§na p√• typiska uppgifter f√∂r Nationella proven</p>
        </div>

        <!-- Leaderboard Modal - higher z-index -->
        <div id="leaderboardModal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4">
            <div class="leaderboard-container bg-gradient-to-b from-slate-900 to-slate-800 rounded-3xl max-w-lg w-full max-h-[90vh] overflow-hidden shadow-2xl border border-amber-500/30">
                <!-- Header -->
                <div class="leaderboard-header bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 p-4 sm:p-6 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxjaXJjbGUgY3g9IjIwIiBjeT0iMjAiIHI9IjMiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4xKSIvPjwvZz48L3N2Zz4=')] opacity-30"></div>
                    <div class="relative">
                        <div class="text-4xl sm:text-5xl mb-2">üèÜ</div>
                        <h2 class="text-xl sm:text-2xl font-black text-white drop-shadow-lg">TOPPLISTA</h2>
                        <p class="text-amber-100 text-xs sm:text-sm mt-1">Topp 50 mattehj√§ltar</p>
                    </div>
                    <button onclick="closeLeaderboard()" class="absolute top-3 right-3 text-white/80 hover:text-white bg-black/20 hover:bg-black/40 rounded-full w-8 h-8 flex items-center justify-center transition z-20">‚úï</button>
                </div>
                
                <!-- Your rank -->
                <div id="yourRankSection" class="bg-gradient-to-r from-indigo-600 to-purple-600 px-4 py-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">üë§</span>
                        <div>
                            <div class="text-white font-bold text-sm" id="yourUsername">...</div>
                            <div class="text-indigo-200 text-xs">Din placering</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-black text-xl" id="yourRank">#-</div>
                        <div class="text-indigo-200 text-xs"><span id="yourPoints">0</span> po√§ng</div>
                    </div>
                </div>
                
                <!-- Leaderboard list -->
                <div class="leaderboard-list overflow-y-auto max-h-[50vh] p-4" id="leaderboardList">
                    <div class="text-center py-8 text-gray-400">
                        <div class="animate-spin text-4xl mb-2">‚è≥</div>
                        Laddar topplista...
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="bg-slate-900/80 px-4 py-3 text-center border-t border-slate-700">
                    <button onclick="syncScoreToLeaderboard()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-2 rounded-full font-bold text-sm hover:scale-105 transition-transform shadow-lg">
                        üîÑ Uppdatera min po√§ng
                    </button>
                </div>
            </div>
        </div>

        <!-- Profile Sync Modal - higher z-index and scrollable -->
        <div id="syncModal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-gradient-to-b from-slate-900 to-slate-800 rounded-3xl max-w-md w-full shadow-2xl border border-indigo-500/30 my-4 max-h-[90vh] overflow-y-auto">
                <!-- Header -->
                <div class="bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500 p-4 sm:p-6 text-center relative sticky top-0 z-10">
                    <div class="text-3xl sm:text-4xl mb-2">üîó</div>
                    <h2 class="text-lg sm:text-xl font-black text-white drop-shadow-lg">Synka Profil</h2>
                    <p class="text-indigo-100 text-xs sm:text-sm mt-1">Koppla ihop samma profil p√• flera enheter</p>
                    <button onclick="closeSyncModal()" class="absolute top-3 right-3 text-white/80 hover:text-white bg-black/20 hover:bg-black/40 rounded-full w-8 h-8 flex items-center justify-center transition z-20">‚úï</button>
                </div>
                
                <!-- Content -->
                <div class="p-4 sm:p-6">
                    <!-- Current profile info -->
                    <div class="bg-slate-700/50 rounded-xl p-3 sm:p-4 mb-4 text-center">
                        <div class="text-xs sm:text-sm text-gray-400 mb-1">Din nuvarande profil</div>
                        <div class="text-white font-bold text-base sm:text-lg" id="syncCurrentUsername">...</div>
                        <div class="text-amber-400 text-xs sm:text-sm"><span id="syncCurrentPoints">0</span> po√§ng</div>
                    </div>
                    
                    <!-- Accessibility Settings in Profile -->
                    <div class="bg-slate-700/30 rounded-xl p-3 sm:p-4 mb-4 border border-slate-600">
                        <h3 class="text-white font-bold mb-3 text-sm sm:text-base">‚öôÔ∏è Inst√§llningar</h3>
                        <div class="space-y-3">
                            <!-- Font Size -->
                            <div>
                                <label class="block text-xs font-medium text-gray-400 mb-2">Textstorlek</label>
                                <div class="flex gap-2">
                                    <button onclick="setFontSize('normal')" id="fontNormal" class="flex-1 py-2 px-3 text-sm rounded-lg border-2 border-slate-500 bg-slate-800 text-gray-200 font-medium hover:border-orange-400 transition">Normal</button>
                                    <button onclick="setFontSize('large')" id="fontLarge" class="flex-1 py-2 px-3 text-sm rounded-lg border-2 border-slate-500 bg-slate-800 text-gray-200 font-medium hover:border-orange-400 transition">Stor</button>
                                    <button onclick="setFontSize('xlarge')" id="fontXLarge" class="flex-1 py-2 px-3 text-sm rounded-lg border-2 border-slate-500 bg-slate-800 text-gray-200 font-medium hover:border-orange-400 transition">Extra stor</button>
                                </div>
                            </div>
                            <!-- Dyslexia Font -->
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-medium text-gray-400">Dyslexiv√§nligt typsnitt</label>
                                <button onclick="toggleDyslexiaFont()" id="dyslexiaToggle" class="w-12 h-6 rounded-full bg-gray-500 relative transition-colors">
                                    <span id="dyslexiaToggleKnob" class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full transition-transform shadow"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Two options -->
                    <div class="grid grid-cols-1 gap-3 sm:gap-4">
                        <!-- Option 1: Generate code -->
                        <div id="syncGenerateSection" class="bg-slate-700/30 rounded-xl p-3 sm:p-4 border border-slate-600">
                            <h3 class="text-white font-bold mb-2 text-sm sm:text-base">üì§ Dela denna profil</h3>
                            <p class="text-gray-400 text-xs sm:text-sm mb-3">Skapa en kod som du kan anv√§nda p√• en annan enhet</p>
                            <button onclick="generateSyncCode()" id="generateCodeBtn" class="w-full bg-gradient-to-r from-indigo-500 to-purple-500 text-white py-2.5 sm:py-3 rounded-xl font-bold hover:scale-105 transition-transform text-sm sm:text-base">
                                Skapa synkkod
                            </button>
                            <div id="syncCodeDisplay" class="hidden mt-3 sm:mt-4 text-center">
                                <div class="text-gray-400 text-xs sm:text-sm mb-2">Din synkkod (giltig 10 min):</div>
                                <div class="bg-slate-900 rounded-xl p-3 sm:p-4 border-2 border-dashed border-indigo-400">
                                    <span id="syncCodeValue" class="text-2xl sm:text-3xl font-mono font-bold text-indigo-400 tracking-widest"></span>
                                </div>
                                <p class="text-gray-500 text-xs mt-2">Skriv in koden p√• din andra enhet</p>
                            </div>
                        </div>
                        
                        <!-- Option 2: Enter code -->
                        <div class="bg-slate-700/30 rounded-xl p-3 sm:p-4 border border-slate-600">
                            <h3 class="text-white font-bold mb-2 text-sm sm:text-base">üì• H√§mta annan profil</h3>
                            <p class="text-gray-400 text-xs sm:text-sm mb-3">Har du en kod fr√•n en annan enhet?</p>
                            <div class="flex gap-2">
                                <input type="text" id="syncCodeInput" class="flex-1 bg-slate-800 border-2 border-slate-600 rounded-xl px-3 sm:px-4 py-2.5 sm:py-3 text-white text-center font-mono text-lg sm:text-xl tracking-widest uppercase" placeholder="ABC123" maxlength="6" oninput="this.value = this.value.toUpperCase()">
                                <button onclick="applySyncCode()" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 sm:px-6 py-2.5 sm:py-3 rounded-xl font-bold hover:scale-105 transition-transform">
                                    ‚úì
                                </button>
                            </div>
                            <div id="syncCodeMessage" class="hidden mt-3 text-center text-xs sm:text-sm py-2 rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Selection -->
        <div id="modeSelection" class="mode-panel rounded-2xl p-6 mb-6">
            <h2 class="text-xl font-bold mb-4 mode-title">V√§lj l√§ge</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="setMode('campaigns')" class="selector-card">
                    <div class="text-3xl mb-2">üöÄ</div>
                    <h3 class="font-bold">Kapiteltr√§ning</h3>
                    <p class="text-sm">V√§lj ett kapitel och tr√§na strukturerat</p>
                </button>
                <button onclick="setMode('math_tasks')" class="selector-card">
                    <div class="text-3xl mb-2">üéØ</div>
                    <h3 class="font-bold">Typuppgifter NP</h3>
                    <p class="text-sm">√ñva p√• specifika NP-uppgiftstyper</p>
                </button>
            </div>
        </div>

        <!-- Topic & Settings Panel -->
        <div id="settingsPanel" class="hidden settings-panel rounded-2xl shadow-2xl p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" id="modeTitle">Kapiteltr√§ning</h2>
                <button onclick="showModeSelection()" class="text-orange-500 hover:text-orange-400 font-medium">‚Üê Byt l√§ge</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">√Ñmne</label>
                    <select id="topicSelect" class="w-full p-3 border-2 border-gray-200 rounded-xl font-medium" onchange="updateChapters(); loadTasks(false)">
                        <option value="Taluppfattning">Taluppfattning</option>
                        <option value="Algebra">Algebra</option>
                        <option value="Procent">Procent</option>
                        <option value="Sannolikhet">Sannolikhet</option>
                        <option value="FunktionerSamband">Funktioner & Samband</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-600 mb-2">Del</label>
                    <select id="chapterSelect" class="w-full p-3 border-2 border-gray-200 rounded-xl font-medium" onchange="handleChapterChange()">
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Course Level Selector - Only for Kapiteltr√§ning -->
            <div id="courseLevelSelector" class="hidden mb-6">
                <label class="block text-sm font-bold text-gray-600 mb-2">Kursniv√•</label>
                <div class="grid grid-cols-2 gap-3">
                    <button id="levelGrund" onclick="setCourseLevel('grund')" class="course-level-btn py-3 px-4 rounded-xl font-bold text-center transition-all border-2 border-green-500 bg-green-100 text-green-700 hover:bg-green-200">
                        üìó Matematik Grund
                    </button>
                    <button id="levelMa1" onclick="setCourseLevel('ma1')" class="course-level-btn py-3 px-4 rounded-xl font-bold text-center transition-all border-2 border-orange-500 bg-orange-500 text-white">
                        üìô Matematik 1
                    </button>
                </div>
            </div>

            <!-- Genomg√•ng Button -->
            <div class="mb-6">
                <button onclick="showGenomgang()" id="genomgangBtn" class="genomgang-btn w-full font-semibold py-3 px-4 rounded-xl transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5"/>
                        <rect x="2" y="6" width="14" height="12" rx="2"/>
                    </svg>
                    üìñ Visa genomg√•ng
                </button>
            </div>

            <!-- Genomg√•ng Modal -->
            <div id="genomgangModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                    <div class="sticky top-0 text-white px-6 py-4 rounded-t-2xl flex items-center justify-between" style="background: linear-gradient(135deg, var(--primary-orange), var(--primary-orange-light));">
                        <h3 class="text-xl font-bold">üìñ Genomg√•ng</h3>
                        <button onclick="closeGenomgang()" class="text-white hover:bg-white/20 rounded-lg p-2 transition">‚úï</button>
                    </div>
                    <div id="genomgangContent" class="p-6">
                        <p class="text-gray-400 text-center py-8">Laddar...</p>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="bg-green-50 rounded-xl p-4">
                    <div class="text-2xl font-bold text-green-600" id="correctCount">0</div>
                    <div class="text-sm text-green-700">R√§tt</div>
                </div>
                <div class="bg-red-50 rounded-xl p-4">
                    <div class="text-2xl font-bold text-red-600" id="wrongCount">0</div>
                    <div class="text-sm text-red-700">Fel</div>
                </div>
                <div id="streakContainer" class="bg-amber-50 rounded-xl p-4 transition-all duration-300">
                    <div class="text-2xl font-bold text-amber-600" id="streakCount">0 üî•</div>
                    <div class="text-sm text-amber-700">Streak</div>
                </div>
            </div>
        </div>

        <!-- Quests Modal - higher z-index -->
        <div id="questsModal" class="hidden fixed inset-0 bg-black/70 z-[60] flex items-center justify-center p-4">
            <div class="quests-container bg-gradient-to-b from-slate-900 to-slate-800 rounded-3xl max-w-md w-full overflow-hidden shadow-2xl border border-purple-500/30">
                <!-- Header -->
                <div class="bg-gradient-to-r from-purple-600 via-violet-500 to-purple-600 p-4 sm:p-6 text-center relative">
                    <div class="text-3xl sm:text-4xl mb-2">üìã</div>
                    <h2 class="text-xl sm:text-2xl font-black text-white drop-shadow-lg">DAGENS QUESTS</h2>
                    <p class="text-purple-100 text-xs sm:text-sm mt-1">Klara quests f√∂r att f√• bonuspo√§ng!</p>
                    <button onclick="closeQuestsModal()" class="absolute top-3 right-3 text-white/80 hover:text-white bg-black/20 hover:bg-black/40 rounded-full w-8 h-8 flex items-center justify-center transition z-20">‚úï</button>
                </div>
                
                <!-- Quest List -->
                <div class="p-4 space-y-4">
                    <!-- Quest 1: 7 correct today -->
                    <div id="quest1Card" class="quest-card">
                        <div class="flex items-center gap-3">
                            <div class="quest-icon">üéØ</div>
                            <div class="flex-1">
                                <div class="quest-title">Daglig tr√§ning</div>
                                <div class="quest-desc">Klara 7 uppgifter idag</div>
                                <div class="quest-reward">+10 po√§ng</div>
                            </div>
                            <div class="text-right">
                                <div class="quest-progress-text" id="quest1Progress">0/7</div>
                                <div id="quest1Status" class="quest-status-active">Aktiv</div>
                            </div>
                        </div>
                        <div class="quest-bar mt-3">
                            <div class="quest-bar-fill" id="quest1Bar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Quest 2: 5 streak -->
                    <div id="quest2Card" class="quest-card">
                        <div class="flex items-center gap-3">
                            <div class="quest-icon">üî•</div>
                            <div class="flex-1">
                                <div class="quest-title">Streak-m√§stare</div>
                                <div class="quest-desc">Klara 5 uppgifter i rad</div>
                                <div class="quest-reward">+5 po√§ng</div>
                            </div>
                            <div class="text-right">
                                <div class="quest-progress-text" id="quest2Progress">0/5</div>
                                <div id="quest2Status" class="quest-status-active">Aktiv</div>
                            </div>
                        </div>
                        <div class="quest-bar mt-3">
                            <div class="quest-bar-fill quest-bar-streak" id="quest2Bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="bg-slate-900/80 px-4 py-3 text-center border-t border-slate-700">
                    <p class="text-gray-400 text-sm">Quests √•terst√§lls varje dag vid midnatt</p>
                </div>
            </div>
        </div>

        <!-- Task Area -->
        <div id="taskArea" class="hidden">
            <!-- Session Progress Bar -->
            <div id="taskProgressBar" class="task-progress-indicator mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span id="currentPartName" class="text-gray-300 text-sm font-medium">Del</span>
                    <div class="flex items-center gap-3">
                        <span class="text-sm" id="sessionProgressText"><span id="sessionCorrect">0</span> av <span id="sessionTotal">7</span> i denna session</span>
                        <div id="streakMultiplier" class="hidden">
                            <span class="multiplier-badge">üî• 2X</span>
                        </div>
                    </div>
                </div>
                <div class="session-progress-container">
                    <div class="session-progress-fill" id="sessionProgressBar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Problem Display with integrated help -->
            <div class="problem-container shadow-2xl mb-4" id="problemContainer">
                <div id="problemContent">
                    <p class="text-gray-400 text-center py-8 animate-pulse">Laddar uppgifter...</p>
                </div>
                <!-- Help buttons integrated with task -->
                <div class="flex items-center gap-2 mt-4 pt-3 border-t border-gray-200 dark:border-gray-700" id="helpButtonsRow">
                    <button onclick="showNextScaffold()" class="action-btn help-btn" id="scaffoldBtn">
                        ü™ú Hj√§lp
                    </button>
                    <button onclick="showHint()" class="action-btn help-btn" id="hintBtn">
                        üí° Ledtr√•d
                    </button>
                </div>
            </div>

            <!-- Scaffolding Section - Smooth slide down -->
            <div id="scaffoldingSection" class="scaffold-section-collapsed">
                <div class="scaffold-inner">
                    <div class="scaffold-header">
                        <span class="font-semibold text-amber-800 flex items-center gap-2">ü™ú Steg-f√∂r-steg hj√§lp</span>
                        <span class="text-xs text-amber-600 bg-amber-200/50 px-2 py-0.5 rounded-full" id="scaffoldProgress">Steg 0/0</span>
                    </div>
                    <div class="scaffold-content" id="scaffoldContent">
                        <!-- Scaffold steps shown here -->
                    </div>
                </div>
            </div>

            <!-- Hint display - Smooth slide down -->
            <div id="hintDisplay" class="hint-section-collapsed">
                <div class="hint-inner">
                    <span class="text-amber-700 font-semibold flex items-center gap-2">üí° <span id="hintText"></span></span>
                </div>
            </div>

            <!-- Answer Section - Modern Mappi-inspired design -->
            <div class="answer-container mb-4" id="answerSection">
                <div id="answerInputArea">
                    <!-- Input Row with math toggle and submit -->
                    <div class="answer-input-wrapper">
                        <input type="text" id="answerInput" class="answer-input" placeholder="Svar" 
                               onkeydown="handleAnswerKeydown(event)" 
                               oninput="updateAnswerPreview()"
                               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        <button type="button" class="math-toggle-btn" onclick="toggleMathToolbar()" title="Matematiska symboler" id="mathToggleBtn">
                            œÄ
                        </button>
                        <button onclick="checkAnswer()" class="submit-btn" title="Skicka svar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Math Input Toolbar (hidden by default) -->
                    <div class="math-toolbar" id="mathToolbar">
                        <button type="button" class="math-btn" onclick="insertMath('fraction')" title="Br√•k (skriv a/b)">
                            <span style="font-size: 14px;">‚Öü</span><span class="math-btn-label">Br√•k</span>
                        </button>
                        <button type="button" class="math-btn" onclick="insertMath('power')" title="Exponent (skriv x^2)">
                            x<sup style="font-size: 10px;">n</sup><span class="math-btn-label">Exponent</span>
                        </button>
                        <button type="button" class="math-btn" onclick="insertMath('sqrt')" title="Kvadratrot">
                            ‚àö<span class="math-btn-label">Rot</span>
                        </button>
                        <button type="button" class="math-btn" onclick="insertMath('pi')" title="Pi">
                            œÄ
                        </button>
                        <button type="button" class="math-btn" onclick="insertMath('plusminus')" title="Plus/minus">
                            ¬±
                        </button>
                        <button type="button" class="math-btn" onclick="insertMath('multiply')" title="G√•nger">
                            √ó
                        </button>
                        <button type="button" class="math-btn" onclick="clearAnswer()" title="Rensa">
                            ‚å´
                        </button>
                    </div>
                    
                    <!-- Live Preview -->
                    <div class="preview-section">
                        <span class="preview-label">S√• h√§r ser ditt svar ut:</span>
                        <div id="answerPreview" class="preview-content preview-empty">...</div>
                    </div>
                </div>

                <!-- Result display -->
                <div id="resultDisplay" class="hidden p-4">
                    <div id="resultMessage" class="text-center py-4 rounded-xl mb-4"></div>
                    
                    <!-- Solution -->
                    <div id="solutionContainer" class="hidden bg-green-50 rounded-xl p-4 border border-green-200">
                        <div class="flex items-center gap-2 text-green-700 font-bold mb-3">üí° L√∂sning</div>
                        <div id="solutionContent"></div>
                    </div>

                    <button onclick="nextTask()" class="btn-primary w-full mt-4">
                        N√§sta uppgift ‚Üí
                    </button>
                </div>
            </div>

            <!-- Skip button -->
            <div class="action-buttons">
                <button onclick="skipTask()" class="action-btn skip-btn" id="skipBtn">
                    ‚è≠Ô∏è Hoppa √∂ver
                </button>
            </div>
        </div>

        <!-- No tasks message -->
        <div id="noTasksMessage" class="hidden bg-white rounded-2xl shadow-2xl p-8 text-center">
            <div class="text-6xl mb-4">üì≠</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Inga uppgifter hittades</h3>
            <p class="text-gray-500 mb-4">Det finns inga uppgifter f√∂r dina valda filter √§nnu.</p>
            <button onclick="showModeSelection()" class="btn-secondary">‚Üê √Ñndra filter</button>
        </div>
    </div>

    <!-- Confetti Canvas -->
    <canvas id="confettiCanvas"></canvas>

    <!-- Calculator Toggle Button -->
    <button class="calc-toggle-btn" onclick="toggleCalculator()" title="√ñppna minir√§knare">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect width="16" height="20" x="4" y="2" rx="2"/>
            <line x1="8" x2="16" y1="6" y2="6"/>
            <line x1="16" x2="16" y1="14" y2="18"/>
            <path d="M16 10h.01"/>
            <path d="M12 10h.01"/>
            <path d="M8 10h.01"/>
            <path d="M12 14h.01"/>
            <path d="M8 14h.01"/>
            <path d="M12 18h.01"/>
            <path d="M8 18h.01"/>
        </svg>
        <span>Minir√§knare</span>
    </button>

    <!-- Calculator (hidden by default) -->
    <div id="calculator" class="calculator" style="display: none; top: 100px; left: 50px;">
        <div class="calc-header" id="calcHeader">
            <span style="color: #888; font-size: 14px;">üì± Minir√§knare</span>
            <button class="calc-close" onclick="toggleCalculator()">√ó</button>
        </div>
        <div class="calc-display" id="calcDisplay">0</div>
        <div class="calc-buttons">
            <button class="calc-btn calc-btn-func" onclick="calcClear()">AC</button>
            <button class="calc-btn calc-btn-func" onclick="calcToggleSign()">¬±</button>
            <button class="calc-btn calc-btn-func" onclick="calcPercent()">%</button>
            <button class="calc-btn calc-btn-op" onclick="calcOp('/')">√∑</button>
            
            <button class="calc-btn calc-btn-num" onclick="calcNum('7')">7</button>
            <button class="calc-btn calc-btn-num" onclick="calcNum('8')">8</button>
            <button class="calc-btn calc-btn-num" onclick="calcNum('9')">9</button>
            <button class="calc-btn calc-btn-op" onclick="calcOp('*')">√ó</button>
            
            <button class="calc-btn calc-btn-num" onclick="calcNum('4')">4</button>
            <button class="calc-btn calc-btn-num" onclick="calcNum('5')">5</button>
            <button class="calc-btn calc-btn-num" onclick="calcNum('6')">6</button>
            <button class="calc-btn calc-btn-op" onclick="calcOp('-')">‚àí</button>
            
            <button class="calc-btn calc-btn-num" onclick="calcNum('1')">1</button>
            <button class="calc-btn calc-btn-num" onclick="calcNum('2')">2</button>
            <button class="calc-btn calc-btn-num" onclick="calcNum('3')">3</button>
            <button class="calc-btn calc-btn-op" onclick="calcOp('+')">+</button>
            
            <button class="calc-btn calc-btn-num calc-btn-zero" onclick="calcNum('0')">0</button>
            <button class="calc-btn calc-btn-num" onclick="calcDecimal()">,</button>
            <button class="calc-btn calc-btn-op" onclick="calcEquals()">=</button>
        </div>
    </div>

    <!-- Calculator Script (non-module) -->
    <script>
        // Calculator state
        let calcDisplayValue = '0';
        let calcFirstOperand = null;
        let calcOperator = null;
        let calcWaitingForSecond = false;

        function updateCalcDisplay() {
            const display = document.getElementById('calcDisplay');
            let formatted = calcDisplayValue.replace('.', ',');
            // Shrink font if number is long
            if (formatted.length > 9) {
                display.style.fontSize = '32px';
            } else if (formatted.length > 6) {
                display.style.fontSize = '40px';
            } else {
                display.style.fontSize = '48px';
            }
            display.textContent = formatted;
        }

        window.toggleCalculator = function() {
            const calc = document.getElementById('calculator');
            calc.style.display = calc.style.display === 'none' ? 'block' : 'none';
        };

        window.calcClear = function() {
            calcDisplayValue = '0';
            calcFirstOperand = null;
            calcOperator = null;
            calcWaitingForSecond = false;
            updateCalcDisplay();
            // Remove active state from operators
            document.querySelectorAll('.calc-btn-op').forEach(b => b.classList.remove('active'));
        };

        window.calcNum = function(num) {
            if (calcWaitingForSecond) {
                calcDisplayValue = num;
                calcWaitingForSecond = false;
            } else {
                calcDisplayValue = calcDisplayValue === '0' ? num : calcDisplayValue + num;
            }
            updateCalcDisplay();
        };

        window.calcDecimal = function() {
            if (calcWaitingForSecond) {
                calcDisplayValue = '0.';
                calcWaitingForSecond = false;
            } else if (!calcDisplayValue.includes('.')) {
                calcDisplayValue += '.';
            }
            updateCalcDisplay();
        };

        window.calcToggleSign = function() {
            calcDisplayValue = String(-parseFloat(calcDisplayValue));
            updateCalcDisplay();
        };

        window.calcPercent = function() {
            calcDisplayValue = String(parseFloat(calcDisplayValue) / 100);
            updateCalcDisplay();
        };

        window.calcOp = function(op) {
            const inputValue = parseFloat(calcDisplayValue);
            
            // Highlight active operator
            document.querySelectorAll('.calc-btn-op').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (calcFirstOperand === null) {
                calcFirstOperand = inputValue;
            } else if (calcOperator) {
                const result = calculate(calcFirstOperand, inputValue, calcOperator);
                calcDisplayValue = String(result);
                calcFirstOperand = result;
                updateCalcDisplay();
            }

            calcWaitingForSecond = true;
            calcOperator = op;
        };

        window.calcEquals = function() {
            if (calcOperator === null || calcFirstOperand === null) return;
            
            const inputValue = parseFloat(calcDisplayValue);
            const result = calculate(calcFirstOperand, inputValue, calcOperator);
            
            calcDisplayValue = String(result);
            calcFirstOperand = null;
            calcOperator = null;
            calcWaitingForSecond = false;
            
            updateCalcDisplay();
            document.querySelectorAll('.calc-btn-op').forEach(b => b.classList.remove('active'));
        };

        function calculate(first, second, op) {
            let result;
            switch (op) {
                case '+': result = first + second; break;
                case '-': result = first - second; break;
                case '*': result = first * second; break;
                case '/': result = second !== 0 ? first / second : 'Error'; break;
                default: result = second;
            }
            // Fix floating point precision (e.g., 0.7200000000000001 -> 0.72)
            if (typeof result === 'number' && !isNaN(result)) {
                result = Math.round(result * 1000000000000) / 1000000000000;
            }
            return result;
        }

        // Drag functionality
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        document.getElementById('calcHeader').addEventListener('mousedown', startDrag);
        document.getElementById('calcHeader').addEventListener('touchstart', startDrag, { passive: false });

        function startDrag(e) {
            isDragging = true;
            const calc = document.getElementById('calculator');
            const rect = calc.getBoundingClientRect();
            
            if (e.type === 'touchstart') {
                dragOffsetX = e.touches[0].clientX - rect.left;
                dragOffsetY = e.touches[0].clientY - rect.top;
            } else {
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
            }
            e.preventDefault();
        }

        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const calc = document.getElementById('calculator');
            let x, y;
            
            if (e.type === 'touchmove') {
                x = e.touches[0].clientX - dragOffsetX;
                y = e.touches[0].clientY - dragOffsetY;
            } else {
                x = e.clientX - dragOffsetX;
                y = e.clientY - dragOffsetY;
            }
            
            // Keep within viewport
            x = Math.max(0, Math.min(x, window.innerWidth - calc.offsetWidth));
            y = Math.max(0, Math.min(y, window.innerHeight - calc.offsetHeight));
            
            calc.style.left = x + 'px';
            calc.style.top = y + 'px';
        }

        document.addEventListener('mouseup', () => isDragging = false);
        document.addEventListener('touchend', () => isDragging = false);
    </script>

    <!-- JavaScript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        // Expose setDoc to window for leaderboard functions
        window.setDoc = setDoc;

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD9wbtUB4MUFq1BF00upHxIS6DQK9aS0vQ",
            authDomain: "praktiska-np.firebaseapp.com",
            projectId: "praktiska-np",
            storageBucket: "praktiska-np.firebasestorage.app",
            messagingSenderId: "239785866823",
            appId: "1:239785866823:web:55ffb3a3485d32984ca362"
        };
        
        const appId = 'default-app-id';

        // ============ COURSE STRUCTURE - SYNCED WITH ADMIN (KAPITELTR√ÑNING) ============
        const COURSE_STRUCTURE = {
            Taluppfattning: {
                name: 'Taluppfattning',
                parts: [
                    { id: 'prio', name: 'Prioriteringsregeln' },
                    { id: 'neg', name: 'Negativa tal' },
                    { id: 'potenser', name: 'Potenser' },
                    { id: 'brak', name: 'Br√•ktal' },
                    { id: 'forlangforkort', name: 'F√∂rl√§ng och f√∂rkorta' },
                    { id: 'overslags', name: '√ñverslagsr√§kning' },
                    { id: 'blandadetal', name: 'Blandade uppgifter' }
                ]
            },
            Algebra: {
                name: 'Algebra',
                parts: [
                    { id: 'uttryck', name: 'Uttryck' },
                    { id: 'forenklauttryck', name: 'F√∂renkla uttryck' },
                    { id: 'parenteser', name: 'Parenteser' },
                    { id: 'vardeavuttryck', name: 'Ber√§kna v√§rde av uttryck' },
                    { id: 'faktorisera', name: 'Faktorisera' },
                    { id: 'formel', name: 'L√∂s ut ur formeln' },
                    { id: 'ekvplusminus', name: 'Ekvationer plus och minus' },
                    { id: 'ekvmultidiv', name: 'Ekvationer multiplikation/division' },
                    { id: 'ekvparentes', name: 'Ekvationer med parentes' },
                    { id: 'ekvbadasida', name: 'Ekvation med x p√• b√•da sidor' },
                    { id: 'algebrablandat', name: 'Blandade uppgifter' }
                ]
            },
            Procent: {
                name: 'Procent',
                parts: [
                    { id: 'brakdeciproform', name: 'Br√•k/Decimal/Procentform' },
                    { id: 'delandelhela', name: 'Delen, andelen, det hela' },
                    { id: 'procentenheter', name: 'Procentenheter' },
                    { id: 'forandringsfaktorn', name: 'F√∂r√§ndringsfaktorn' },
                    { id: 'upprepadforandring', name: 'Upprepad f√∂r√§ndring' },
                    { id: 'bakl√§nges', name: 'Bakl√§nges r√§kning' },
                    { id: 'procentblandat', name: 'Blandade uppgifter' }
                ]
            },
            Sannolikhet: {
                name: 'Sannolikhet',
                parts: [
                    { id: 'grundsannolikhet', name: 'Grundl√§ggande sannolikhet' },
                    { id: 'enklasannolikheter', name: 'Enkla sannolikheter' },
                    { id: 'flerautfall', name: 'Flera utfall' },
                    { id: 'oberoendeberoende', name: 'Oberoende o beroende' },
                    { id: 'komplement', name: 'Komplementh√§ndelse' },
                    { id: 'sannolikhetblandade', name: 'Blandade uppgifter' }
                ]
            },
            FunktionerSamband: {
                name: 'Funktioner och Samband',
                parts: [
                    { id: 'anvandaformler', name: 'Anv√§nda formler f(x)' },
                    { id: 'ratalinjen', name: 'Den r√§ta linjen' },
                    { id: 'procentuell', name: 'Procentuell f√∂r√§ndring' },
                    { id: 'jamfortolka', name: 'J√§mf√∂ra och tolka' },
                    { id: 'funktionerblandade', name: 'Blandade uppgifter' }
                ]
            }
        };

        // ============ NP STRUCTURE - SYNCED WITH ADMIN (TYPUPPGIFTER NP) ============
        const NP_STRUCTURE = {
            Algebra: {
                name: 'Algebra',
                parts: [
                    { id: 'forenklauttryck', name: 'F√∂renkling av uttryck' },
                    { id: 'ekvationer', name: 'Ekvationer' },
                    { id: 'faktorisera', name: 'Faktorisera' },
                    { id: 'monsterformler', name: 'M√∂nster och formler' },
                    { id: 'losuturformler', name: 'L√∂s ut ur formler' }
                ]
            },
            FunktionerSamband: {
                name: 'Funktioner',
                parts: [
                    { id: 'funktionsbegreppet', name: 'Funktionsbegreppet f(x)' },
                    { id: 'linjarafunktioner', name: 'Linj√§ra funktioner' },
                    { id: 'exponentiellafunktioner', name: 'Exponentiella funktioner' },
                    { id: 'koordinatsystem', name: 'Koordinatsystem, grafer och punkter' }
                ]
            },
            Taluppfattning: {
                name: 'Taluppfattning',
                parts: [
                    { id: 'Prioriteringsregeln', name: 'Prioriteringsregeln' },
                    { id: 'braktal', name: 'Br√•ktal' },
                    { id: 'potenser', name: 'Potenser' }
                ]
            },
            Procent: {
                name: 'Procent',
                parts: [
                    { id: 'F√∂r√§ndringsfaktorn', name: 'F√∂r√§ndringsfaktorn (intro)' },
                    { id: 'ff', name: 'F√∂r√§ndringsfaktorn' },
                    { id: 'upprepadff', name: 'Upprepad f√∂r√§ndring' },
                    { id: 'lanoranta', name: 'L√•n, r√§nta och amortering' }
                ]
            },
            Sannolikhet: {
                name: 'Sannolikhet',
                parts: [
                    { id: 'beroendeoberoende', name: 'Beroende och oberoende-h√§ndelse' },
                    { id: 'komplement', name: 'Komplementh√§ndelse' }
                ]
            }
        };

        // Firebase paths - supports both collections and course levels
        function getFirebasePath(topic, partId) {
            if (currentMode === 'math_tasks') {
                return `artifacts/${appId}/public/data/math_tasks/${topic}/${partId}`;
            }
            // For campaigns mode, append 'grund' suffix if course level is 'grund'
            const suffix = currentCourseLevel === 'grund' ? 'grund' : '';
            return `artifacts/${appId}/public/data/campaigns/${topic}/${partId}${suffix}`;
        }
        
        // Get current structure based on mode
        function getCurrentStructure() {
            return currentMode === 'math_tasks' ? NP_STRUCTURE : COURSE_STRUCTURE;
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // State
        let currentMode = 'campaigns';
        let currentCourseLevel = 'ma1'; // 'ma1' or 'grund' - only used in campaigns mode
        let consecutiveWrong = 0; // Track consecutive wrong answers for auto-genomg√•ng
        let tasks = [];
        let currentTaskIndex = 0;
        let currentScaffoldIndex = 0;
        let stats = { correct: 0, wrong: 0, streak: 0 };
        
        // Session tracking (moved here to ensure availability)
        let sessionCorrect = 0;
        const SESSION_GOAL = 7;
        let skippedTasks = []; // Store skipped tasks to come back later
        
        // ============ DAILY PROGRESS & POINTS SYSTEM ============
        const DAILY_GOAL = 7;
        const STREAK_GOAL = 5;
        const POINTS_PER_PART = 10;
        const POINTS_PER_STREAK = 5;
        
        function getTodayKey() {
            return new Date().toISOString().split('T')[0]; // YYYY-MM-DD
        }
        
        function getDailyProgress() {
            const today = getTodayKey();
            const stored = localStorage.getItem('mathTrainer_dailyProgress');
            if (stored) {
                const data = JSON.parse(stored);
                if (data.date === today) {
                    return data;
                }
            }
            // Reset for new day
            return { date: today, correct: 0, partsCompleted: [], streakQuestDone: false };
        }
        
        function saveDailyProgress(progress) {
            localStorage.setItem('mathTrainer_dailyProgress', JSON.stringify(progress));
        }
        
        // Check and award streak quest
        function checkStreakQuest() {
            const progress = getDailyProgress();
            if (stats.streak >= STREAK_GOAL && !progress.streakQuestDone) {
                progress.streakQuestDone = true;
                saveDailyProgress(progress);
                addPoints(POINTS_PER_STREAK);
                addQuest();
                showStreakQuestCompletion();
                updateQuestsNotification();
                return true;
            }
            return false;
        }
        
        function showStreakQuestCompletion() {
            // Flash notification
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.innerHTML = `üî• STREAK QUEST +${POINTS_PER_STREAK}!`;
            popup.style.left = '50%';
            popup.style.top = '30%';
            popup.style.transform = 'translateX(-50%)';
            popup.style.fontSize = '28px';
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
        }
        
        function getTotalPoints() {
            return parseInt(localStorage.getItem('mathTrainer_totalPoints') || '0');
        }
        
        function addPoints(points) {
            const current = getTotalPoints();
            localStorage.setItem('mathTrainer_totalPoints', (current + points).toString());
            updatePointsDisplay();
        }
        
        function updatePointsDisplay() {
            const points = getTotalPoints();
            document.getElementById('totalPoints').textContent = points;
        }
        
        // ============ USERNAME SYSTEM ============
        const ADJECTIVES = [
            'crazy', 'super', 'mega', 'turbo', 'epic', 'cool', 'magic', 'swift', 
            'brave', 'happy', 'smart', 'lucky', 'ninja', 'cosmic', 'stellar', 
            'thunder', 'blazing', 'mighty', 'golden', 'shadow'
        ];
        
        const ANIMALS = [
            'panda', 'tiger', 'dragon', 'phoenix', 'wolf', 'eagle', 'fox', 'lion',
            'shark', 'falcon', 'panther', 'cobra', 'hawk', 'bear', 'lynx',
            'jaguar', 'viper', 'raven', 'orca', 'leopard'
        ];
        
        function generateUsername() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const animal = ANIMALS[Math.floor(Math.random() * ANIMALS.length)];
            const num = Math.floor(Math.random() * 900) + 100; // 100-999
            return `${adj}${animal}${num}`;
        }
        
        function getUsername() {
            let username = localStorage.getItem('mathTrainer_username');
            if (!username) {
                username = generateUsername();
                localStorage.setItem('mathTrainer_username', username);
            }
            return username;
        }
        
        function updateUsernameDisplay() {
            document.getElementById('usernameDisplay').textContent = getUsername();
        }
        
        // ============ LEADERBOARD SYSTEM ============
        window.showLeaderboard = async function() {
            document.getElementById('leaderboardModal').classList.remove('hidden');
            document.getElementById('yourUsername').textContent = getUsername();
            document.getElementById('yourPoints').textContent = getTotalPoints();
            await loadLeaderboard();
        };
        
        window.closeLeaderboard = function() {
            document.getElementById('leaderboardModal').classList.add('hidden');
        };
        
        function getTotalQuests() {
            return parseInt(localStorage.getItem('totalQuests') || '0');
        }
        
        function addQuest() {
            const current = getTotalQuests();
            localStorage.setItem('totalQuests', (current + 1).toString());
        }
        
        window.syncScoreToLeaderboard = async function() {
            const username = getUsername();
            const points = getTotalPoints();
            const quests = getTotalQuests();
            
            try {
                const leaderboardRef = doc(db, `artifacts/${appId}/public/data/leaderboard`, username);
                await window.setDoc(leaderboardRef, {
                    username: username,
                    points: points,
                    quests: quests,
                    updatedAt: new Date().toISOString()
                });
                
                // Show success feedback
                const btn = event.target;
                btn.innerHTML = '‚úÖ Uppdaterad!';
                btn.classList.remove('from-green-500', 'to-emerald-500');
                btn.classList.add('from-blue-500', 'to-indigo-500');
                
                setTimeout(() => {
                    btn.innerHTML = 'üîÑ Uppdatera min po√§ng';
                    btn.classList.remove('from-blue-500', 'to-indigo-500');
                    btn.classList.add('from-green-500', 'to-emerald-500');
                }, 2000);
                
                // Reload leaderboard
                await loadLeaderboard();
            } catch (error) {
                console.error('Error syncing score:', error);
            }
        };
        
        async function loadLeaderboard() {
            const listEl = document.getElementById('leaderboardList');
            const username = getUsername();
            
            try {
                const leaderboardRef = collection(db, `artifacts/${appId}/public/data/leaderboard`);
                const snapshot = await getDocs(leaderboardRef);
                
                let players = [];
                snapshot.forEach(docSnap => {
                    players.push(docSnap.data());
                });
                
                // Sort by points descending
                players.sort((a, b) => b.points - a.points);
                
                // Take top 50
                players = players.slice(0, 50);
                
                if (players.length === 0) {
                    listEl.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üèúÔ∏è</div>
                            <p>Ingen p√• topplistan √§n!</p>
                            <p class="text-sm mt-2">Var f√∂rst med att synka dina po√§ng!</p>
                        </div>
                    `;
                    document.getElementById('yourRank').textContent = '#-';
                    return;
                }
                
                // Find user's rank
                const userRank = players.findIndex(p => p.username === username);
                document.getElementById('yourRank').textContent = userRank >= 0 ? `#${userRank + 1}` : '#-';
                
                // Render list
                listEl.innerHTML = players.map((player, index) => {
                    const rank = index + 1;
                    const isYou = player.username === username;
                    
                    let rankClass = 'normal';
                    let itemClass = '';
                    let trophy = rank.toString();
                    
                    if (rank === 1) {
                        rankClass = 'gold';
                        itemClass = 'gold';
                        trophy = 'ü•á';
                    } else if (rank === 2) {
                        rankClass = 'silver';
                        itemClass = 'silver';
                        trophy = 'ü•à';
                    } else if (rank === 3) {
                        rankClass = 'bronze';
                        itemClass = 'bronze';
                        trophy = 'ü•â';
                    }
                    
                    if (isYou) itemClass += ' you';
                    
                    return `
                        <div class="leaderboard-item ${itemClass}">
                            <div class="rank-badge ${rankClass}">${trophy}</div>
                            <div class="player-name">
                                ${player.username}
                                ${isYou ? '<span class="text-xs ml-2 text-indigo-400">(du)</span>' : ''}
                            </div>
                            <div class="player-stats">
                                <span class="player-points">${player.points} <span style="color: #fbbf24;">p</span></span>
                                <span class="player-quests">${player.quests || 0} ‚≠ê</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                listEl.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üòµ</div>
                        <p>Kunde inte ladda topplistan</p>
                    </div>
                `;
            }
        }
        
        // ============ PROFILE SYNC SYSTEM ============
        window.showSyncModal = function() {
            document.getElementById('syncModal').classList.remove('hidden');
            document.getElementById('syncCurrentUsername').textContent = getUsername();
            document.getElementById('syncCurrentPoints').textContent = getTotalPoints();
            document.getElementById('syncCodeDisplay').classList.add('hidden');
            document.getElementById('syncCodeInput').value = '';
            document.getElementById('syncCodeMessage').classList.add('hidden');
        };
        
        window.closeSyncModal = function() {
            document.getElementById('syncModal').classList.add('hidden');
        };
        
        function generateRandomCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Exclude confusing characters
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        window.generateSyncCode = async function() {
            const btn = document.getElementById('generateCodeBtn');
            btn.innerHTML = '‚è≥ Skapar...';
            btn.disabled = true;
            
            try {
                const username = getUsername();
                const points = getTotalPoints();
                const code = generateRandomCode();
                const expiresAt = new Date(Date.now() + 10 * 60 * 1000).toISOString(); // 10 minutes
                
                // Store sync code in Firebase
                const syncRef = doc(db, `artifacts/${appId}/public/data/sync_codes`, code);
                await window.setDoc(syncRef, {
                    code: code,
                    username: username,
                    points: points,
                    dailyProgress: localStorage.getItem('mathTrainer_dailyProgress') || '{}',
                    createdAt: new Date().toISOString(),
                    expiresAt: expiresAt
                });
                
                // Show the code
                document.getElementById('syncCodeValue').textContent = code;
                document.getElementById('syncCodeDisplay').classList.remove('hidden');
                btn.innerHTML = '‚úÖ Kod skapad!';
                
                setTimeout(() => {
                    btn.innerHTML = 'Skapa ny kod';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error generating sync code:', error);
                btn.innerHTML = '‚ùå Fel uppstod';
                setTimeout(() => {
                    btn.innerHTML = 'Skapa synkkod';
                    btn.disabled = false;
                }, 2000);
            }
        };
        
        window.applySyncCode = async function() {
            const codeInput = document.getElementById('syncCodeInput');
            const messageEl = document.getElementById('syncCodeMessage');
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length !== 6) {
                messageEl.textContent = '‚ùå Koden m√•ste vara 6 tecken';
                messageEl.className = 'mt-3 text-center text-sm py-2 rounded-lg bg-red-500/20 text-red-400';
                messageEl.classList.remove('hidden');
                return;
            }
            
            messageEl.textContent = '‚è≥ H√§mtar profil...';
            messageEl.className = 'mt-3 text-center text-sm py-2 rounded-lg bg-slate-600/50 text-gray-300';
            messageEl.classList.remove('hidden');
            
            try {
                const syncRef = doc(db, `artifacts/${appId}/public/data/sync_codes`, code);
                const syncSnap = await getDoc(syncRef);
                
                if (!syncSnap.exists()) {
                    messageEl.textContent = '‚ùå Koden finns inte eller har g√•tt ut';
                    messageEl.className = 'mt-3 text-center text-sm py-2 rounded-lg bg-red-500/20 text-red-400';
                    return;
                }
                
                const data = syncSnap.data();
                
                // Check if expired
                if (new Date(data.expiresAt) < new Date()) {
                    messageEl.textContent = '‚ùå Koden har g√•tt ut';
                    messageEl.className = 'mt-3 text-center text-sm py-2 rounded-lg bg-red-500/20 text-red-400';
                    return;
                }
                
                // Apply the profile
                localStorage.setItem('mathTrainer_username', data.username);
                localStorage.setItem('mathTrainer_totalPoints', data.points.toString());
                if (data.dailyProgress) {
                    localStorage.setItem('mathTrainer_dailyProgress', data.dailyProgress);
                }
                
                // Update displays
                updateUsernameDisplay();
                updatePointsDisplay();
                updateDailyProgressDisplay();
                
                messageEl.textContent = `‚úÖ Profil "${data.username}" h√§mtad med ${data.points} po√§ng!`;
                messageEl.className = 'mt-3 text-center text-sm py-2 rounded-lg bg-green-500/20 text-green-400';
                
                // Update modal display
                document.getElementById('syncCurrentUsername').textContent = data.username;
                document.getElementById('syncCurrentPoints').textContent = data.points;
                
                // Close modal after a delay
                setTimeout(() => {
                    closeSyncModal();
                }, 2000);
                
            } catch (error) {
                console.error('Error applying sync code:', error);
                messageEl.textContent = '‚ùå N√•got gick fel';
                messageEl.className = 'mt-3 text-center text-sm py-2 rounded-lg bg-red-500/20 text-red-400';
            }
        };
        
        function updateDailyProgressDisplay() {
            const progress = getDailyProgress();
            const dailyCorrectEl = document.getElementById('dailyCorrect');
            const progressBar = document.getElementById('progressBar');
            
            // If old daily progress elements don't exist (new session-based UI), just bail out gracefully
            if (!dailyCorrectEl || !progressBar) {
                return;
            }
            
            dailyCorrectEl.textContent = progress.correct;
            const percentage = Math.min((progress.correct / DAILY_GOAL) * 100, 100);
            progressBar.style.width = `${percentage}%`;
            
            // Update progress bar styling
            const streakMultiplier = document.getElementById('streakMultiplier');
            
            if (progress.correct >= DAILY_GOAL) {
                progressBar.classList.add('completed');
            } else {
                progressBar.classList.remove('completed');
                
                // Show multiplier status based on current streak
                if (stats && stats.streak >= 3) {
                    if (streakMultiplier) streakMultiplier.classList.remove('hidden');
                } else {
                    if (streakMultiplier) streakMultiplier.classList.add('hidden');
                }
            }
            
            // Update quests notification
            updateQuestsNotification();
        }
        
        function updateQuestsNotification() {
            const progress = getDailyProgress();
            const quest1Done = progress.correct >= DAILY_GOAL && progress.partsCompleted.length > 0;
            const quest2Done = progress.streakQuestDone || false;
            
            const notificationEl = document.getElementById('questsNotification');
            if (notificationEl) {
                // Show notification if quests are incomplete
                if (!quest1Done || !quest2Done) {
                    notificationEl.classList.remove('hidden');
                } else {
                    notificationEl.classList.add('hidden');
                }
            }
        }
        
        // ============ QUESTS MODAL ============
        window.showQuestsModal = function() {
            document.getElementById('questsModal').classList.remove('hidden');
            updateQuestsDisplay();
        };
        
        window.closeQuestsModal = function() {
            document.getElementById('questsModal').classList.add('hidden');
        };
        
        function updateQuestsDisplay() {
            const progress = getDailyProgress();
            
            // Quest 1: 7 correct today
            const quest1Card = document.getElementById('quest1Card');
            const quest1Progress = document.getElementById('quest1Progress');
            const quest1Bar = document.getElementById('quest1Bar');
            const quest1Status = document.getElementById('quest1Status');
            
            const q1Correct = Math.min(progress.correct, DAILY_GOAL);
            quest1Progress.textContent = `${q1Correct}/${DAILY_GOAL}`;
            quest1Bar.style.width = `${(q1Correct / DAILY_GOAL) * 100}%`;
            
            const quest1Done = progress.correct >= DAILY_GOAL && progress.partsCompleted.length > 0;
            if (quest1Done) {
                quest1Card.classList.add('quest-completed');
                quest1Bar.classList.add('completed');
                quest1Status.textContent = '‚úÖ Klar!';
                quest1Status.className = 'quest-status-done';
            } else {
                quest1Card.classList.remove('quest-completed');
                quest1Bar.classList.remove('completed');
                quest1Status.textContent = 'Aktiv';
                quest1Status.className = 'quest-status-active';
            }
            
            // Quest 2: 5 streak
            const quest2Card = document.getElementById('quest2Card');
            const quest2Progress = document.getElementById('quest2Progress');
            const quest2Bar = document.getElementById('quest2Bar');
            const quest2Status = document.getElementById('quest2Status');
            
            const currentStreak = stats ? Math.min(stats.streak, STREAK_GOAL) : 0;
            const quest2Done = progress.streakQuestDone || false;
            
            if (quest2Done) {
                quest2Progress.textContent = `${STREAK_GOAL}/${STREAK_GOAL}`;
                quest2Bar.style.width = '100%';
                quest2Bar.classList.add('completed');
                quest2Card.classList.add('quest-completed');
                quest2Status.textContent = '‚úÖ Klar!';
                quest2Status.className = 'quest-status-done';
            } else {
                quest2Progress.textContent = `${currentStreak}/${STREAK_GOAL}`;
                quest2Bar.style.width = `${(currentStreak / STREAK_GOAL) * 100}%`;
                quest2Bar.classList.remove('completed');
                quest2Card.classList.remove('quest-completed');
                quest2Status.textContent = 'Aktiv';
                quest2Status.className = 'quest-status-active';
            }
        }
        
        function showPointsPopup(points, hasMultiplier) {
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.innerHTML = hasMultiplier ? `+${points} üî•` : `+${points}`;
            popup.style.left = `${Math.random() * 60 + 20}%`;
            popup.style.top = '40%';
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }
        
        function getCurrentPartKey() {
            const topic = document.getElementById('topicSelect').value;
            const partId = document.getElementById('chapterSelect').value;
            return `${currentMode}_${topic}_${partId}`;
        }
        
        function checkPartCompletion() {
            const progress = getDailyProgress();
            const partKey = getCurrentPartKey();
            
            // Check if we reached the goal and haven't already claimed points for this part today
            if (progress.correct >= DAILY_GOAL && !progress.partsCompleted.includes(partKey)) {
                progress.partsCompleted.push(partKey);
                saveDailyProgress(progress);
                addPoints(POINTS_PER_PART);
                addQuest();
                
                // Show completion message!
                showPartCompletionCelebration();
                return true;
            }
            return false;
        }
        
        function showPartCompletionCelebration() {
            const problemContent = document.getElementById('problemContent');
            problemContent.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-7xl mb-4 success-pop">üèÜ</div>
                    <div class="text-4xl mb-2">‚≠êüéâ‚≠ê</div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">QUEST AVKLARAD!</h3>
                    <p class="text-gray-600 mb-2">Du klarade dagens m√•l med 7 uppgifter!</p>
                    <div class="bg-gradient-to-r from-amber-100 to-yellow-100 rounded-2xl p-4 my-4 border-2 border-amber-300">
                        <p class="text-3xl font-black text-amber-600 mb-1">+10 BONUS PO√ÑNG!</p>
                        <p class="text-lg text-amber-700">Totalt: <span class="font-black">${getTotalPoints()}</span> po√§ng</p>
                    </div>
                    <p class="text-sm text-gray-500 mb-4">Forts√§tt f√∂r att tj√§na fler po√§ng!</p>
                    <button onclick="resetDailyAndContinue()" class="btn-primary mt-4">
                        üöÄ Forts√§tt tr√§na
                    </button>
                </div>
            `;
            document.getElementById('answerSection').classList.add('hidden');
            updateDailyProgressDisplay();
            launchConfetti(500);
        }
        
        window.resetDailyAndContinue = function() {
            // Reset daily counter but keep points
            const progress = getDailyProgress();
            progress.correct = 0;
            saveDailyProgress(progress);
            updateDailyProgressDisplay();
            
            // Continue with next task
            currentTaskIndex++;
            document.getElementById('answerSection').classList.remove('hidden');
            showTask();
        };

        // ============ CONFETTI SYSTEM ============
        const confettiCanvas = document.getElementById('confettiCanvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        let confettiAnimating = false;

        function resizeConfettiCanvas() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
        }
        resizeConfettiCanvas();
        window.addEventListener('resize', resizeConfettiCanvas);

        function createConfetti(count = 150) {
            const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];
            for (let i = 0; i < count; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: Math.random() * confettiCanvas.height - confettiCanvas.height,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 6 + 4,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    angle: Math.random() * 360,
                    spin: Math.random() * 10 - 5,
                    drift: Math.random() * 2 - 1
                });
            }
        }

        function animateConfetti() {
            if (!confettiAnimating) return;
            
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            
            confettiParticles.forEach((p, i) => {
                p.y += p.speed;
                p.x += p.drift;
                p.angle += p.spin;
                
                confettiCtx.save();
                confettiCtx.translate(p.x, p.y);
                confettiCtx.rotate(p.angle * Math.PI / 180);
                confettiCtx.fillStyle = p.color;
                confettiCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                confettiCtx.restore();
                
                if (p.y > confettiCanvas.height + 50) {
                    confettiParticles.splice(i, 1);
                }
            });
            
            if (confettiParticles.length > 0) {
                requestAnimationFrame(animateConfetti);
            } else {
                confettiAnimating = false;
                confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            }
        }

        function launchConfetti(amount = 150) {
            confettiParticles = [];
            createConfetti(amount);
            confettiAnimating = true;
            animateConfetti();
        }

        // Update topics dropdown based on mode
        window.updateTopics = function() {
            const topicSelect = document.getElementById('topicSelect');
            const structure = getCurrentStructure();
            
            topicSelect.innerHTML = '';
            
            Object.keys(structure).forEach(topicKey => {
                const option = document.createElement('option');
                option.value = topicKey;
                option.textContent = structure[topicKey].name;
                topicSelect.appendChild(option);
            });
            
            updateChapters();
        };

        // Handle chapter (del) selection - scroll to task in math_tasks mode (Typuppgifter NP)
        window.handleChapterChange = function() {
            // In math_tasks mode (Typuppgifter NP), there's no course level selection,
            // so selecting a part is the final step -> scroll to task
            // In campaigns mode (Kapiteltr√§ning), user still needs to select course level -> no scroll
            const shouldScroll = currentMode === 'math_tasks';
            loadTasks(shouldScroll);
        };

        // Update chapters dropdown based on topic
        window.updateChapters = function() {
            const topic = document.getElementById('topicSelect').value;
            const chapterSelect = document.getElementById('chapterSelect');
            const structure = getCurrentStructure()[topic];
            
            chapterSelect.innerHTML = '';
            
            // Add parts first - default to first specific part for better UX
            if (structure && structure.parts && structure.parts.length > 0) {
                structure.parts.forEach((part, index) => {
                    const option = document.createElement('option');
                    option.value = part.id;
                    option.textContent = `Del ${index + 1}: ${part.name}`;
                    chapterSelect.appendChild(option);
                });
                
                // Add "All" option at the end
                const allOption = document.createElement('option');
                allOption.value = '';
                allOption.textContent = 'üìö Alla delar (blandade)';
                chapterSelect.appendChild(allOption);
            }
        };

        // Initialize
        signInAnonymously(auth).then(() => {
            console.log('Connected to Firebase');
        }).catch(e => {
            console.error('Firebase error:', e);
        });

        // Mode selection
        window.setMode = function(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('settingsPanel').classList.remove('hidden');
            document.getElementById('modeTitle').textContent = mode === 'campaigns' ? 'üöÄ Kapiteltr√§ning' : 'üéØ Typuppgifter NP';
            
            // Show/hide course level selector based on mode
            const courseLevelSelector = document.getElementById('courseLevelSelector');
            if (mode === 'campaigns') {
                courseLevelSelector.classList.remove('hidden');
            } else {
                courseLevelSelector.classList.add('hidden');
            }
            
            updateTopics();
            // In math_tasks mode (Typuppgifter NP), scroll will happen when selecting a part
            // So we pass scrollToTask=false here and let part selection trigger scroll
            loadTasks(false);
        };

        // Course level selection (Grund / Ma 1) - only for Kapiteltr√§ning
        window.setCourseLevel = function(level) {
            currentCourseLevel = level;
            
            // Update button styles
            const grundBtn = document.getElementById('levelGrund');
            const ma1Btn = document.getElementById('levelMa1');
            
            if (level === 'grund') {
                grundBtn.className = 'course-level-btn py-3 px-4 rounded-xl font-bold text-center transition-all border-2 border-green-500 bg-green-500 text-white';
                ma1Btn.className = 'course-level-btn py-3 px-4 rounded-xl font-bold text-center transition-all border-2 border-orange-500 bg-orange-100 text-orange-700 hover:bg-orange-200';
            } else {
                grundBtn.className = 'course-level-btn py-3 px-4 rounded-xl font-bold text-center transition-all border-2 border-green-500 bg-green-100 text-green-700 hover:bg-green-200';
                ma1Btn.className = 'course-level-btn py-3 px-4 rounded-xl font-bold text-center transition-all border-2 border-orange-500 bg-orange-500 text-white';
            }
            
            // Reload tasks with new course level - scroll to task since user made final selection
            loadTasks(true);
        };

        window.showModeSelection = function() {
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('settingsPanel').classList.add('hidden');
            document.getElementById('taskArea').classList.add('hidden');
            document.getElementById('noTasksMessage').classList.add('hidden');
        };

        // ============ GENOMG√ÖNG (Walkthrough) SYSTEM ============
        
        // Extract base part ID (remove 'grund' suffix if present)
        function getBasePartId(partId) {
            return partId.replace(/grund$/, '');
        }
        
        // Get genomg√•ng path - separate folder structure
        function getGenomgangPath(topic, partId) {
            const basePartId = getBasePartId(partId);
            if (currentMode === 'math_tasks') {
                return `artifacts/${appId}/public/data/math_tasks/${topic}/genomgang`;
            }
            return `artifacts/${appId}/public/data/campaigns/${topic}/genomgang`;
        }
        
        // Get genomg√•ng document ID
        function getGenomgangDocId(partId) {
            const basePartId = getBasePartId(partId);
            return `${basePartId}genomgang`;
        }
        
        window.showGenomgang = async function() {
            const topic = document.getElementById('topicSelect').value;
            const partId = document.getElementById('chapterSelect').value;
            
            if (!partId) {
                alert('V√§lj en specifik del f√∂r att se genomg√•ngen.');
                return;
            }
            
            const modal = document.getElementById('genomgangModal');
            const content = document.getElementById('genomgangContent');
            
            modal.classList.remove('hidden');
            content.innerHTML = '<p class="text-gray-400 text-center py-8 animate-pulse">Laddar genomg√•ng...</p>';
            
            try {
                // Use new genomg√•ng path structure
                const genomgangPath = getGenomgangPath(topic, partId);
                const genomgangDocId = getGenomgangDocId(partId);
                const genomgangRef = doc(db, genomgangPath, genomgangDocId);
                const genomgangSnap = await getDoc(genomgangRef);
                
                if (genomgangSnap.exists()) {
                    const data = genomgangSnap.data();
                    content.innerHTML = renderGenomgang(data);
                    // Re-render MathJax
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        await MathJax.typesetPromise([content]);
                    }
                } else {
                    content.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üìö</div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Finns ingen genomg√•ng h√§r √§n</h3>
                            <p class="text-gray-500">Genomg√•ngen f√∂r denna del kommer snart!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading genomg√•ng:', error);
                content.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìö</div>
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Finns ingen genomg√•ng h√§r √§n</h3>
                        <p class="text-gray-500">Genomg√•ngen f√∂r denna del kommer snart!</p>
                    </div>
                `;
            }
        };

        window.closeGenomgang = function() {
            document.getElementById('genomgangModal').classList.add('hidden');
        };

        function renderGenomgang(data) {
            // Support flexible content structure
            if (data.content) {
                // If there's a content field with blocks (old format)
                if (Array.isArray(data.content)) {
                    return data.content.map(block => {
                        if (block.type === 'text') {
                            return `<p class="problem-text-block">${block.value}</p>`;
                        } else if (block.type === 'math') {
                            return `<div class="problem-math-block">$$${block.value}$$</div>`;
                        } else if (block.type === 'step') {
                            return `<div class="step-block"><span class="step-number">${block.step || '‚Ä¢'}</span>${block.value}</div>`;
                        }
                        return `<p>${block.value || ''}</p>`;
                    }).join('');
                }
                // If content is a markdown-like string (new format from admin)
                return renderMarkdownContent(data.content);
            }
            
            // If there's a text field
            if (data.text) {
                return `<div class="prose max-w-none whitespace-pre-wrap">${data.text}</div>`;
            }
            
            // Fallback - show all data
            return `<pre class="bg-gray-100 p-4 rounded-lg overflow-x-auto">${JSON.stringify(data, null, 2)}</pre>`;
        }

        function renderMarkdownContent(content) {
            let html = content;
            
            // Process special blocks first
            html = html.replace(/:::tip\n([\s\S]*?)\n:::/g, '<div class="genomgang-tip"><strong>üí° Tips:</strong><br>$1</div>');
            html = html.replace(/:::warning\n([\s\S]*?)\n:::/g, '<div class="genomgang-warning"><strong>‚ö†Ô∏è Observera:</strong><br>$1</div>');
            html = html.replace(/:::example\n([\s\S]*?)\n:::/g, '<div class="genomgang-example"><strong>üìù Exempel:</strong><br>$1</div>');
            
            // Process headings
            html = html.replace(/^### (.+)$/gm, '<h4 class="genomgang-h4">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 class="genomgang-h3">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 class="genomgang-h2">$1</h2>');
            
            // Process bold and italic
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // Process display math ($$...$$)
            html = html.replace(/\$\$([^$]+)\$\$/g, '<div class="problem-math-block">$$$$1$$</div>');
            
            // Process inline math ($...$) - be careful not to double-process
            html = html.replace(/\$([^$\n]+)\$/g, '\\($1\\)');
            
            // Process lists
            html = html.replace(/^- (.+)$/gm, '<li class="genomgang-list-item">$1</li>');
            html = html.replace(/^(\d+)\. (.+)$/gm, '<li class="genomgang-list-item" style="list-style-type:decimal;">$2</li>');
            
            // Process line breaks
            html = html.replace(/\n\n/g, '</p><p class="genomgang-paragraph">');
            html = html.replace(/\n/g, '<br>');
            
            // Wrap in paragraph
            html = '<p class="genomgang-paragraph">' + html + '</p>';
            
            return html;
        }

        // Load tasks - now using correct Firebase path synced with admin
        // scrollToTask: if true, scroll to task area after loading (used when user made final selection)
        window.loadTasks = async function(scrollToTask = false) {
            const topic = document.getElementById('topicSelect').value;
            const partId = document.getElementById('chapterSelect').value;

            console.log('=== LOADING TASKS ===');
            console.log('Topic:', topic);
            console.log('PartId:', partId);
            console.log('Current mode:', currentMode);
            console.log('Scroll to task:', scrollToTask);

            try {
                tasks = [];

                if (partId) {
                    // Load specific part
                    const path = getFirebasePath(topic, partId);
                    console.log('Firebase path:', path);
                    const colRef = collection(db, path);
                    console.log('Collection ref created');
                    const snap = await getDocs(colRef);
                    console.log('Got snapshot, size:', snap.size);
                    snap.forEach(docSnap => {
                        console.log('Found doc:', docSnap.id);
                        tasks.push({ id: docSnap.id, ...docSnap.data() });
                    });
                } else {
                    // Load all parts for this topic
                    console.log('Loading ALL parts for topic');
                    const structure = getCurrentStructure()[topic];
                    if (structure && structure.parts) {
                        for (const part of structure.parts) {
                            const path = getFirebasePath(topic, part.id);
                            console.log('Trying path:', path);
                            try {
                                const snap = await getDocs(collection(db, path));
                                console.log('Part', part.id, 'has', snap.size, 'docs');
                                snap.forEach(docSnap => {
                                    tasks.push({ id: docSnap.id, ...docSnap.data() });
                                });
                            } catch (e) {
                                console.log('Error loading part', part.id, ':', e.message);
                            }
                        }
                    }
                }

                console.log('Total tasks loaded:', tasks.length);

                // Shuffle tasks
                tasks = tasks.sort(() => Math.random() - 0.5);

                if (tasks.length === 0) {
                    document.getElementById('taskArea').classList.add('hidden');
                    document.getElementById('noTasksMessage').classList.remove('hidden');
                } else {
                    document.getElementById('taskArea').classList.remove('hidden');
                    document.getElementById('noTasksMessage').classList.add('hidden');
                    document.getElementById('answerSection').classList.remove('hidden');

                    // Reset stats when loading new tasks
                    stats = { correct: 0, wrong: 0, streak: 0 };
                    document.getElementById('correctCount').textContent = '0';
                    document.getElementById('wrongCount').textContent = '0';
                    document.getElementById('streakCount').textContent = '0 üî•';
                    document.getElementById('streakContainer').classList.remove('streak-glow', 'streak-legendary');
                    currentTaskIndex = 0;

                    showTask();

                    // Only scroll to task if explicitly requested (final user selection)
                    if (scrollToTask) {
                        setTimeout(() => {
                            const taskArea = document.getElementById('taskArea');
                            if (taskArea) {
                                taskArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 50);
                    }
                }
            } catch (e) {
                console.error('=== ERROR LOADING TASKS ===');
                console.error('Error:', e);
                console.error('Error message:', e.message);
                const noTasksEl = document.getElementById('noTasksMessage');
                if (noTasksEl) {
                    const noTasksTextEl = noTasksEl.querySelector('p');
                    if (noTasksTextEl && e && e.message) {
                        noTasksTextEl.textContent = `Fel vid laddning av uppgifter: ${e.message}`;
                    }
                    document.getElementById('taskArea').classList.add('hidden');
                    noTasksEl.classList.remove('hidden');
                } else {
                    document.getElementById('taskArea').classList.add('hidden');
                    document.getElementById('noTasksMessage').classList.remove('hidden');
                }
            }
        };

        // Show current task
        function showTask() {
            if (currentTaskIndex >= tasks.length) {
                // Show completion - all tasks done
                document.getElementById('problemContent').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üéâ</div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Bra jobbat!</h3>
                        <p class="text-gray-500">Du har slutf√∂rt alla ${tasks.length} uppgifter i denna del.</p>
                        <p class="text-lg mt-4">
                            <span class="text-green-600 font-bold">${stats.correct}</span> r√§tt, 
                            <span class="text-red-600 font-bold">${stats.wrong}</span> fel
                        </p>
                        <button onclick="loadTasks()" class="btn-primary mt-6">Ladda fler uppgifter</button>
                    </div>
                `;
                document.getElementById('answerSection').classList.add('hidden');
                return;
            }

            const task = tasks[currentTaskIndex];
            currentScaffoldIndex = 0;

            // Update part name display
            const partId = document.getElementById('chapterSelect').value;
            const topic = document.getElementById('topicSelect').value;
            const structure = getCurrentStructure()[topic];
            const part = structure?.parts?.find(p => p.id === partId);
            const partName = part ? part.name : (partId || 'Alla delar');
            document.getElementById('currentPartName').textContent = partName;
            
            // Update daily progress display
            updateDailyProgressDisplay();

            // Render question
            const contentEl = document.getElementById('problemContent');
            contentEl.innerHTML = '';
            renderBlocks(contentEl, task.question_sv);

            // Reset UI
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').className = 'answer-input';
            document.getElementById('answerPreview').className = 'preview-content preview-empty';
            document.getElementById('answerPreview').textContent = '...';
            document.getElementById('answerInputArea').classList.remove('hidden');
            document.getElementById('resultDisplay').classList.add('hidden');
            
            // Reset hint and scaffold sections to collapsed state
            const hintSection = document.getElementById('hintDisplay');
            hintSection.classList.remove('hint-section-expanded');
            hintSection.classList.add('hint-section-collapsed');
            
            const scaffoldSection = document.getElementById('scaffoldingSection');
            scaffoldSection.classList.remove('scaffold-section-expanded');
            scaffoldSection.classList.add('scaffold-section-collapsed');
            document.getElementById('scaffoldContent').innerHTML = '';
            
            // Hide math toolbar by default
            document.getElementById('mathToolbar').classList.remove('visible');
            document.getElementById('mathToggleBtn').classList.remove('active');

            // Show/hide scaffold button
            const hasScaffolding = task.scaffolding_sv && task.scaffolding_sv.length > 0;
            document.getElementById('scaffoldBtn').classList.toggle('hidden', !hasScaffolding);

            // Show/hide hint button
            const hasHint = task.hint_sv && task.hint_sv.trim();
            document.getElementById('hintBtn').classList.toggle('hidden', !hasHint);
            
            // Show/hide help buttons row
            document.getElementById('helpButtonsRow').classList.toggle('hidden', !hasScaffolding && !hasHint);
            
            // Hide solution container
            document.getElementById('solutionContainer').classList.add('hidden');
            document.getElementById('solutionContent').innerHTML = '';

            // Typeset MathJax
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([contentEl]);
            }
        }
        
        // Toggle math toolbar visibility - exposed globally
        window.toggleMathToolbar = function() {
            const toolbar = document.getElementById('mathToolbar');
            const btn = document.getElementById('mathToggleBtn');
            toolbar.classList.toggle('visible');
            btn.classList.toggle('active');
        };

        function renderBlocks(container, blocks) {
            if (!blocks) return;
            if (typeof blocks === 'string') {
                const div = document.createElement('div');
                div.className = 'problem-text-block';
                div.innerHTML = formatInlineMath(blocks);
                container.appendChild(div);
                return;
            }

            let stepCount = 0;
            blocks.forEach(block => {
                if (!block.value) return;
                
                const div = document.createElement('div');
                
                if (block.type === 'text') {
                    div.className = 'problem-text-block';
                    div.innerHTML = formatInlineMath(block.value);
                } else if (block.type === 'math') {
                    div.className = 'problem-math-block';
                    div.innerHTML = `$$${block.value}$$`;
                } else if (block.type === 'step') {
                    stepCount++;
                    div.className = 'step-block';
                    div.innerHTML = `<span class="step-number">${stepCount}.</span><span>${formatInlineMath(block.value)}</span>`;
                } else if (block.type === 'image') {
                    // Handle graph images
                    div.className = 'flex justify-center mb-4';
                    const img = document.createElement('img');
                    img.src = block.value;
                    img.className = 'max-w-full rounded-lg border border-gray-200';
                    img.style.maxHeight = '250px';
                    img.alt = 'Graf';
                    div.appendChild(img);
                }
                
                container.appendChild(div);
            });
        }

        function formatInlineMath(text) {
            if (!text) return '';
            // Clean stray $ signs first, then convert proper $...$ to MathJax inline format
            let cleaned = text;
            
            // Protect proper inline math $...$
            const mathSegments = [];
            cleaned = cleaned.replace(/\$([^$]+)\$/g, (match, inner) => {
                const idx = mathSegments.length;
                mathSegments.push(inner);
                return `__MATH_${idx}__`;
            });
            
            // Remove any stray $ signs
            cleaned = cleaned.replace(/\$/g, '');
            
            // Restore math with MathJax inline format \(...\)
            cleaned = cleaned.replace(/__MATH_(\d+)__/g, (match, idx) => `\\(${mathSegments[parseInt(idx)]}\\)`);
            
            return cleaned;
        }

        // Show scaffolding step - smooth slide down animation
        window.showNextScaffold = function() {
            const task = tasks[currentTaskIndex];
            if (!task.scaffolding_sv || currentScaffoldIndex >= task.scaffolding_sv.length) return;

            const scaffoldSection = document.getElementById('scaffoldingSection');
            const scaffoldContent = document.getElementById('scaffoldContent');
            
            // Expand the section with smooth animation
            scaffoldSection.classList.remove('scaffold-section-collapsed');
            scaffoldSection.classList.add('scaffold-section-expanded');

            const scaffold = task.scaffolding_sv[currentScaffoldIndex];
            const div = document.createElement('div');
            div.className = 'scaffold-step animate-in';
            div.innerHTML = `<span class="scaffold-step-number">${currentScaffoldIndex + 1}.</span><span>${formatInlineMath(scaffold.value)}</span>`;
            scaffoldContent.appendChild(div);

            currentScaffoldIndex++;
            document.getElementById('scaffoldProgress').textContent = `Steg ${currentScaffoldIndex}/${task.scaffolding_sv.length}`;

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([div]);
            }

            // Hide button if no more scaffolds
            if (currentScaffoldIndex >= task.scaffolding_sv.length) {
                document.getElementById('scaffoldBtn').classList.add('hidden');
            }
        };

        // Show hint - smooth slide down animation
        window.showHint = function() {
            const task = tasks[currentTaskIndex];
            if (!task.hint_sv) return;

            const hintSection = document.getElementById('hintDisplay');
            document.getElementById('hintText').textContent = task.hint_sv;
            hintSection.classList.remove('hint-section-collapsed');
            hintSection.classList.add('hint-section-expanded');
            document.getElementById('hintBtn').classList.add('hidden');
        };

        // ============ MATH INPUT TOOLBAR FUNCTIONS ============
        window.insertMath = function(type) {
            const input = document.getElementById('answerInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const val = input.value;
            let insert = '';
            let cursorOffset = 0;
            
            switch(type) {
                case 'fraction':
                    insert = '/';
                    cursorOffset = 1;
                    break;
                case 'power':
                    insert = '^';
                    cursorOffset = 1;
                    break;
                case 'sqrt':
                    insert = 'sqrt()';
                    cursorOffset = 5; // Place cursor inside ()
                    break;
                case 'pi':
                    insert = 'œÄ';
                    cursorOffset = 1;
                    break;
                case 'plusminus':
                    insert = '¬±';
                    cursorOffset = 1;
                    break;
                case 'multiply':
                    insert = '*';
                    cursorOffset = 1;
                    break;
            }
            
            input.value = val.slice(0, start) + insert + val.slice(end);
            input.focus();
            input.setSelectionRange(start + cursorOffset, start + cursorOffset);
            updateAnswerPreview();
        };

        window.clearAnswer = function() {
            document.getElementById('answerInput').value = '';
            updateAnswerPreview();
            document.getElementById('answerInput').focus();
        };

        // Convert user input to LaTeX for preview
        function userInputToLatex(input) {
            if (!input || input.trim() === '') return '';
            let latex = input.trim();
            
            // Handle sqrt(x) -> \sqrt{x}
            latex = latex.replace(/sqrt\(([^)]+)\)/gi, '\\sqrt{$1}');
            
            // Handle x^y -> x^{y}
            latex = latex.replace(/\^(\d+)/g, '^{$1}');
            latex = latex.replace(/\^([a-zA-Z])/g, '^{$1}');
            latex = latex.replace(/\^(\([^)]+\))/g, '^{$1}');
            
            // Handle a/b -> \frac{a}{b}
            // More sophisticated: handle things like 1/100, x^2/y^3
            latex = latex.replace(/([0-9a-zA-Z\^{}\d]+)\/([0-9a-zA-Z\^{}\d]+)/g, '\\frac{$1}{$2}');
            
            // Handle pi symbol
            latex = latex.replace(/œÄ/g, '\\pi');
            latex = latex.replace(/pi(?![a-z])/gi, '\\pi');
            
            // Handle multiplication
            latex = latex.replace(/\*/g, '\\cdot ');
            latex = latex.replace(/√ó/g, '\\cdot ');
            
            return latex;
        }

        // Handle Enter key - submit answer or go to next task
        window.handleAnswerKeydown = function(event) {
            if (event.key !== 'Enter') return;

            // Prevent the global Enter listener from also firing on the same key press.
            event.preventDefault();
            event.stopPropagation();

            const resultDisplay = document.getElementById('resultDisplay');
            const answerInputArea = document.getElementById('answerInputArea');

            // If we're showing result (already answered) -> next task
            if (resultDisplay && !resultDisplay.classList.contains('hidden')) {
                nextTask();
                return;
            }

            // If we're still answering -> check answer
            if (answerInputArea && !answerInputArea.classList.contains('hidden')) {
                checkAnswer();
            }
        };

        window.updateAnswerPreview = function() {
            const input = document.getElementById('answerInput').value;
            const preview = document.getElementById('answerPreview');
            
            if (!input || input.trim() === '') {
                preview.className = 'preview-content preview-empty';
                preview.textContent = '...';
                return;
            }
            
            const latex = userInputToLatex(input);
            preview.className = 'preview-content';
            preview.innerHTML = `$$${latex}$$`;
            
            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([preview]).catch(err => {
                    preview.textContent = input; // Fallback to plain text
                });
            }
        };

        // Normalize answer for comparison - SMART normalization
        function normalizeAnswer(answer) {
            if (!answer) return '';
            let normalized = answer.toString().trim().toLowerCase();
            
            // Remove all whitespace
            normalized = normalized.replace(/\s+/g, '');
            
            // IMPORTANT: Convert decimal point to comma for consistent comparison
            // Swedish uses comma, but we normalize to point for comparison
            normalized = normalized.replace(/,/g, '.');
            
            // Remove trailing % sign
            normalized = normalized.replace(/%$/, '');
            
            // Remove trailing . (like "8." -> "8")
            normalized = normalized.replace(/\.$/, '');
            
            // Remove LaTeX wrappers if present
            normalized = normalized.replace(/^\$/, '').replace(/\$$/, '');
            normalized = normalized.replace(/^\\?\(/, '').replace(/\\?\)$/, '');
            
            // ====== SMART LaTeX to keyboard-friendly conversion ======
            
            // \frac{a}{b} -> a/b
            normalized = normalized.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '$1/$2');
            
            // x^{n} -> x^n
            normalized = normalized.replace(/\^{([^}]+)}/g, '^$1');
            
            // \sqrt{x} -> sqrt(x)
            normalized = normalized.replace(/\\sqrt\{([^}]+)\}/g, 'sqrt($1)');
            
            // \pi -> pi
            normalized = normalized.replace(/\\pi/g, 'pi');
            normalized = normalized.replace(/œÄ/g, 'pi');
            
            // \cdot -> *
            normalized = normalized.replace(/\\cdot/g, '*');
            normalized = normalized.replace(/√ó/g, '*');
            normalized = normalized.replace(/√∑/g, '/');
            
            // Remove any remaining backslashes
            normalized = normalized.replace(/\\/g, '');
            
            // Handle "x = 2" vs "x=2" vs just "2"
            // Also remove spaces around = and comparisons
            normalized = normalized.replace(/\s*=\s*/g, '=');
            
            // ====== REMOVE TRAILING ZEROS from decimals (1.50 -> 1.5, 1.500 -> 1.5) ======
            normalized = normalized.replace(/(\d+\.\d*?)0+$/g, '$1');
            normalized = normalized.replace(/\.$/g, ''); // Remove trailing dot if all zeros removed
            
            return normalized;
        }
        
        // Check if two algebraic terms are equivalent (4a = a*4 = 4*a)
        function algebraicMatch(userAns, correctAns) {
            // Direct match
            if (userAns === correctAns) return true;
            
            // Try to parse simple algebraic terms like 4a, a*4, 4*a
            function parseAlgebraicTerm(term) {
                // Remove multiplication signs
                const cleaned = term.replace(/\*/g, '');
                
                // Match patterns like "4a", "a4", "4ab", "ab4"
                const match = cleaned.match(/^(\d*\.?\d*)([a-z]+)(\d*\.?\d*)$/i);
                if (match) {
                    const coef1 = match[1] || '1';
                    const coef2 = match[3] || '1';
                    const vars = match[2].split('').sort().join('');
                    const totalCoef = (parseFloat(coef1) || 1) * (parseFloat(coef2) || 1);
                    return { coef: totalCoef, vars: vars };
                }
                
                // Try pattern like "4*a" or "a*4"
                const parts = term.split('*').filter(p => p);
                if (parts.length >= 2) {
                    let coef = 1;
                    let vars = [];
                    for (const part of parts) {
                        if (/^\d+\.?\d*$/.test(part)) {
                            coef *= parseFloat(part);
                        } else if (/^[a-z]+$/i.test(part)) {
                            vars.push(...part.split(''));
                        } else {
                            return null;
                        }
                    }
                    return { coef: coef, vars: vars.sort().join('') };
                }
                
                return null;
            }
            
            const userParsed = parseAlgebraicTerm(userAns);
            const correctParsed = parseAlgebraicTerm(correctAns);
            
            if (userParsed && correctParsed) {
                return userParsed.coef === correctParsed.coef && userParsed.vars === correctParsed.vars;
            }
            
            return false;
        }
        
        // Check numeric equivalence (50 = 50% when comparing with percentage context)
        function numericMatch(userAns, correctAns) {
            // Try to parse as numbers
            const userNum = parseFloat(userAns);
            const correctNum = parseFloat(correctAns);
            
            if (!isNaN(userNum) && !isNaN(correctNum)) {
                // Direct numeric equality (handles 1.5 = 1.50 after normalization)
                if (Math.abs(userNum - correctNum) < 0.0000001) return true;
            }
            
            return false;
        }
        
        // Check if two equations are equivalent (x=b/2 is same as b/2=x)
        function equationsMatch(userAns, correctAns) {
            // Direct match
            if (userAns === correctAns) return true;
            
            // Check for reversed equation (x=value vs value=x)
            if (userAns.includes('=') && correctAns.includes('=')) {
                const userParts = userAns.split('=');
                const correctParts = correctAns.split('=');
                
                if (userParts.length === 2 && correctParts.length === 2) {
                    // Try reversed order
                    const reversedUser = userParts[1] + '=' + userParts[0];
                    if (reversedUser === correctAns) return true;
                    
                    const reversedCorrect = correctParts[1] + '=' + correctParts[0];
                    if (userAns === reversedCorrect) return true;
                }
            }
            
            return false;
        }
        
        // Get all valid answers from a raw answer string (handles "eller" / "or")
        function getAllValidAnswers(rawAnswer) {
            if (!rawAnswer) return [];
            const raw = rawAnswer.toString();
            
            // Split by "eller" or "or" (case insensitive, with optional whitespace)
            const alternatives = raw.split(/\s+eller\s+|\s+or\s+/i);
            
            // Normalize each alternative
            return alternatives.map(alt => normalizeAnswer(alt)).filter(a => a.length > 0);
        }
        
        // Format a single answer part for nice display
        function formatSingleAnswerForDisplay(ans) {
            if (!ans) return '';
            ans = ans.toString().trim();
            
            // Clean LaTeX wrappers
            ans = ans.replace(/^\$+/, '').replace(/\$+$/, '');
            
            // If it contains LaTeX commands, process it
            if (ans.includes('\\') || ans.includes('^') || ans.includes('/') || ans.includes('sqrt')) {
                let latex = ans;
                
                // Convert keyboard-friendly to LaTeX for display
                latex = latex.replace(/sqrt\(([^)]+)\)/gi, '\\sqrt{$1}');
                latex = latex.replace(/\^(\d+)/g, '^{$1}');
                latex = latex.replace(/\^([a-zA-Z])/g, '^{$1}');
                latex = latex.replace(/([0-9a-zA-Z]+)\/([0-9a-zA-Z]+)/g, '\\frac{$1}{$2}');
                
                return `\\(${latex}\\)`;
            }
            
            return ans;
        }
        
        // Format answer for nice display - handles "eller" gracefully
        function formatAnswerForDisplay(rawAnswer) {
            if (!rawAnswer) return '';
            const raw = rawAnswer.toString();
            
            // Check if it has alternatives
            const parts = raw.split(/\s+eller\s+|\s+or\s+/i);
            
            if (parts.length > 1) {
                // Multiple alternatives - format each one nicely
                const formatted = parts.map(p => formatSingleAnswerForDisplay(p.trim()));
                return formatted.join(' <span style="color: #64748b; font-weight: normal;">eller</span> ');
            }
            
            return formatSingleAnswerForDisplay(raw);
        }

        // Check answer with EPIC celebrations!
        window.checkAnswer = function() {
            const task = tasks[currentTaskIndex];
            const userRaw = document.getElementById('answerInput').value;
            const correctRaw = (task.answer || '').toString();
            
            const userAnswer = normalizeAnswer(userRaw);
            const correctAnswer = normalizeAnswer(correctRaw);
            
            // Get all valid answers (handles "eller" / "or")
            const validAnswers = getAllValidAnswers(correctRaw);
            
            // Check if user answer matches any valid answer (including equation order)
            let isCorrect = validAnswers.some(valid => equationsMatch(userAnswer, valid));
            
            // Also check algebraic equivalence (4a = a*4 = 4*a)
            if (!isCorrect) {
                isCorrect = validAnswers.some(valid => algebraicMatch(userAnswer, valid));
            }
            
            // Also check numeric equivalence (handles decimal variations like 1.5 = 1.50)
            if (!isCorrect) {
                isCorrect = validAnswers.some(valid => numericMatch(userAnswer, valid));
            }
            
            // Also check for "x = value" variations
            if (!isCorrect) {
                for (const valid of validAnswers) {
                    // If correct answer has "=", also accept just the value
                    if (valid.includes('=')) {
                        const correctValue = valid.split('=').pop();
                        if (userAnswer === correctValue || numericMatch(userAnswer, correctValue)) {
                            isCorrect = true;
                            break;
                        }
                        // Also accept left side value
                        const leftValue = valid.split('=')[0];
                        if ((userAnswer === leftValue || numericMatch(userAnswer, leftValue)) && !leftValue.match(/^[a-z]$/)) {
                            isCorrect = true;
                            break;
                        }
                    }
                    // If user typed "x = value", extract and compare
                    if (userAnswer.includes('=')) {
                        const userValue = userAnswer.split('=').pop();
                        if (userValue === valid || numericMatch(userValue, valid)) {
                            isCorrect = true;
                            break;
                        }
                        // Also check reversed
                        const userLeft = userAnswer.split('=')[0];
                        if ((userLeft === valid || numericMatch(userLeft, valid))) {
                            isCorrect = true;
                            break;
                        }
                    }
                }
            }

            const inputEl = document.getElementById('answerInput');
            const resultEl = document.getElementById('resultMessage');
            const streakContainer = document.getElementById('streakContainer');
            const streakCountEl = document.getElementById('streakCount');

            if (isCorrect) {
                inputEl.className = 'answer-input correct';
                stats.correct++;
                stats.streak++;
                
                // Check streak quest (5 in a row)
                checkStreakQuest();
                
                // Calculate points - 1 per correct, 2x if streak >= 3
                const hasMultiplier = stats.streak >= 3;
                const pointsEarned = hasMultiplier ? 2 : 1;
                addPoints(pointsEarned);
                showPointsPopup(pointsEarned, hasMultiplier);
                
                // Update daily progress
                const progress = getDailyProgress();
                progress.correct++;
                saveDailyProgress(progress);
                updateDailyProgressDisplay();
                
                // Update session progress
                sessionCorrect++;
                updateSessionProgress();
                
                // ALWAYS launch confetti on correct answer - amount based on streak!
                const confettiAmount = Math.min(50 + (stats.streak * 30), 400);
                launchConfetti(confettiAmount);
                
                // EPIC celebration based on streak!
                let pointsText = hasMultiplier ? `<span class="multiplier-badge">üî• 2X</span> +${pointsEarned}p` : `+${pointsEarned}p`;
                
                if (stats.streak >= 7) {
                    // LEGENDARY celebration!
                    resultEl.className = 'text-center py-4 rounded-xl mb-4 bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 text-white';
                    resultEl.innerHTML = `<span class="text-4xl success-pop">üëëüî•üíéüî•üëë</span><br><span class="text-xl font-bold">LEGENDARISKT! ${stats.streak} i rad!</span><br><span class="text-sm">${pointsText}</span>`;
                    streakContainer.classList.add('streak-glow', 'streak-legendary');
                    streakCountEl.classList.add('streak-fire');
                } else if (stats.streak >= 5) {
                    // MEGA celebration
                    resultEl.className = 'text-center py-4 rounded-xl mb-4 bg-gradient-to-r from-yellow-400 via-amber-500 to-orange-500 text-white';
                    resultEl.innerHTML = `<span class="text-3xl success-pop">üî•üéâüî•</span><br><span class="text-xl font-bold">FANTASTISKT! ${stats.streak} i rad!</span><br><span class="text-sm">${pointsText}</span>`;
                    streakContainer.classList.add('streak-glow');
                    streakContainer.classList.remove('streak-legendary');
                    streakCountEl.classList.add('streak-fire');
                } else if (stats.streak >= 3) {
                    // Good streak celebration - MULTIPLIER UNLOCKED!
                    resultEl.className = 'text-center py-4 rounded-xl mb-4 bg-gradient-to-r from-green-400 to-emerald-500 text-white';
                    resultEl.innerHTML = `<span class="text-2xl success-pop">üî•‚ú®</span><br><span class="font-bold">${stats.streak} r√§tt i rad!</span><br><span class="text-sm">${pointsText} - 2X MULTIPLIKATOR!</span>`;
                    streakContainer.classList.add('streak-glow');
                    streakContainer.classList.remove('streak-legendary');
                    streakCountEl.classList.remove('streak-fire');
                } else {
                    // Normal correct - still confetti!
                    resultEl.className = 'text-center py-4 rounded-xl mb-4 bg-green-100 text-green-800';
                    resultEl.innerHTML = `<span class="text-2xl success-pop">‚úÖ</span> R√§tt svar! <span class="text-sm font-bold text-amber-600">+${pointsEarned}p</span>`;
                    streakContainer.classList.remove('streak-glow', 'streak-legendary');
                    streakCountEl.classList.remove('streak-fire');
                }
                
                // Check if part is completed (7 correct today)
                if (progress.correct >= DAILY_GOAL) {
                    checkPartCompletion();
                }
                
                // Reset consecutive wrong counter on correct answer
                consecutiveWrong = 0;
            } else {
                inputEl.className = 'answer-input incorrect';
                resultEl.className = 'text-center py-4 rounded-xl mb-4 bg-red-100 text-red-800';
                
                // SHAKE ANIMATION on wrong answer!
                const problemContainer = document.getElementById('problemContainer');
                problemContainer.classList.add('shake');
                setTimeout(() => problemContainer.classList.remove('shake'), 500);
                
                // Format the correct answer nicely
                const formattedAnswer = formatAnswerForDisplay(task.answer);
                resultEl.innerHTML = `<span class="text-2xl">‚ùå</span> Fel! R√§tt svar √§r: <strong><span id="correctAnswerDisplay">${formattedAnswer}</span></strong><br><span class="text-sm text-gray-500">Streak f√∂rlorad - b√∂rja om f√∂r 2X multiplikator!</span>`;
                
                // Render MathJax on the correct answer
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([document.getElementById('correctAnswerDisplay')]);
                }
                
                stats.wrong++;
                stats.streak = 0;
                streakContainer.classList.remove('streak-glow', 'streak-legendary');
                streakCountEl.classList.remove('streak-fire');
                
                // Track consecutive wrong answers (only in Kapiteltr√§ning mode)
                consecutiveWrong++;
                if (consecutiveWrong >= 2 && currentMode === 'campaigns') {
                    // Auto-show genomg√•ng after 2 wrong in a row
                    consecutiveWrong = 0; // Reset counter
                    setTimeout(() => {
                        showGenomgang();
                    }, 1500); // Delay to let user see the result first
                }
                
                // Update daily progress display to reset multiplier status
                updateDailyProgressDisplay();
            }

            // Update stats display
            document.getElementById('correctCount').textContent = stats.correct;
            document.getElementById('wrongCount').textContent = stats.wrong;
            
            // Epic streak display with multiplier badge
            const streakMultiplier = document.getElementById('streakMultiplier');
            if (stats.streak >= 7) {
                streakCountEl.innerHTML = `<span class="streak-fire">${stats.streak}</span> üëëüî•üî•üî•`;
                streakMultiplier.classList.remove('hidden');
            } else if (stats.streak >= 5) {
                streakCountEl.innerHTML = `<span class="streak-fire">${stats.streak}</span> üî•üî•üî•`;
                streakMultiplier.classList.remove('hidden');
            } else if (stats.streak >= 3) {
                streakCountEl.innerHTML = `${stats.streak} üî•üî•`;
                streakMultiplier.classList.remove('hidden');
            } else {
                streakCountEl.textContent = stats.streak + ' üî•';
                streakMultiplier.classList.add('hidden');
            }
            
            // Update daily quest status
            updateDailyProgressDisplay();

            // Show result and solution
            document.getElementById('answerInputArea').classList.add('hidden');
            document.getElementById('resultDisplay').classList.remove('hidden');

            // Show solution if answer is WRONG
            if (!isCorrect) {
                const solutionContainer = document.getElementById('solutionContainer');
                const solutionContent = document.getElementById('solutionContent');
                solutionContent.innerHTML = '';
                
                // Try multiple possible explanation fields
                const explanation = task.explanation_sv || task.explanation || task.solution || task.losning;
                
                if (explanation && Array.isArray(explanation) && explanation.length > 0) {
                    let stepCount = 0;
                    explanation.forEach(block => {
                        if (!block.value) return;
                        const div = document.createElement('div');
                        
                        if (block.type === 'text') {
                            div.className = 'problem-text-block';
                            div.innerHTML = formatInlineMath(block.value);
                        } else if (block.type === 'math') {
                            div.className = 'problem-math-block';
                            div.innerHTML = `$$${block.value}$$`;
                        } else if (block.type === 'step') {
                            stepCount++;
                            div.className = 'step-block';
                            div.innerHTML = `<span class="step-number">${stepCount}.</span><span>${formatInlineMath(block.value)}</span>`;
                        }
                        
                        solutionContent.appendChild(div);
                    });

                    solutionContainer.classList.remove('hidden');

                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([solutionContent]);
                    }
                } else if (typeof explanation === 'string' && explanation.trim()) {
                    // Handle string explanation
                    const div = document.createElement('div');
                    div.className = 'problem-text-block';
                    div.innerHTML = formatInlineMath(explanation);
                    solutionContent.appendChild(div);
                    solutionContainer.classList.remove('hidden');
                    
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([solutionContent]);
                    }
                } else {
                    // No explanation available - just show correct answer prominently
                    const formattedAnswer = formatAnswerForDisplay(task.answer);
                    const div = document.createElement('div');
                    div.className = 'problem-text-block text-center';
                    div.innerHTML = `<strong>R√§tt svar:</strong> <span id="solutionAnswer">${formattedAnswer}</span>`;
                    solutionContent.appendChild(div);
                    solutionContainer.classList.remove('hidden');
                    
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([solutionContent]);
                    }
                }
            } else {
                // Hide solution if answer is correct
                document.getElementById('solutionContainer').classList.add('hidden');
            }
        };

        // Next task
        window.nextTask = function() {
            currentTaskIndex++;
            showTask();
        };

        // ============ QUESTS INITIALIZATION ============

        // Update session progress bar
        function updateSessionProgress() {
            const correctEl = document.getElementById('sessionCorrect');
            const totalEl = document.getElementById('sessionTotal');
            const barEl = document.getElementById('sessionProgressBar');
            
            if (correctEl) correctEl.textContent = sessionCorrect;
            if (totalEl) totalEl.textContent = SESSION_GOAL;
            if (barEl) {
                const percent = Math.min((sessionCorrect / SESSION_GOAL) * 100, 100);
                barEl.style.width = percent + '%';
            }
        }

        // ============ FONT SIZE & DYSLEXIA SETTINGS ============
        let currentFontSize = localStorage.getItem('fontSize') || 'normal';
        let dyslexiaEnabled = localStorage.getItem('dyslexiaFont') === 'true';

        window.setFontSize = function(size) {
            currentFontSize = size;
            localStorage.setItem('fontSize', size);
            
            // Remove all font size classes
            document.body.classList.remove('font-large', 'font-xlarge');
            
            // Add appropriate class
            if (size === 'large') document.body.classList.add('font-large');
            if (size === 'xlarge') document.body.classList.add('font-xlarge');
            
            // Update button states (dark theme in profile modal)
            ['fontNormal', 'fontLarge', 'fontXLarge'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.remove('border-orange-500', 'bg-orange-500', 'text-white');
                    btn.classList.add('border-slate-500', 'bg-slate-800', 'text-gray-200');
                }
            });
            
            const activeId = size === 'normal' ? 'fontNormal' : size === 'large' ? 'fontLarge' : 'fontXLarge';
            const activeBtn = document.getElementById(activeId);
            if (activeBtn) {
                activeBtn.classList.remove('border-slate-500', 'bg-slate-800', 'text-gray-200');
                activeBtn.classList.add('border-orange-500', 'bg-orange-500', 'text-white');
            }
        };

        window.toggleDyslexiaFont = function() {
            dyslexiaEnabled = !dyslexiaEnabled;
            localStorage.setItem('dyslexiaFont', dyslexiaEnabled);
            
            const toggle = document.getElementById('dyslexiaToggle');
            const knob = document.getElementById('dyslexiaToggleKnob');
            
            if (dyslexiaEnabled) {
                document.body.classList.add('dyslexia-font');
                toggle.classList.remove('bg-gray-500');
                toggle.classList.add('bg-green-500');
                knob.style.transform = 'translateX(24px)';
            } else {
                document.body.classList.remove('dyslexia-font');
                toggle.classList.remove('bg-green-500');
                toggle.classList.add('bg-gray-500');
                knob.style.transform = 'translateX(0)';
            }
        };

        // Apply saved settings on load
        function applyAccessibilitySettings() {
            setFontSize(currentFontSize);
            if (dyslexiaEnabled) {
                document.body.classList.add('dyslexia-font');
                const toggle = document.getElementById('dyslexiaToggle');
                const knob = document.getElementById('dyslexiaToggleKnob');
                if (toggle) {
                    toggle.classList.remove('bg-gray-500');
                    toggle.classList.add('bg-green-500');
                }
                if (knob) knob.style.transform = 'translateX(24px)';
            }
        }

        // ============ SHOW SOLUTION ANIMATED ============
        window.showSolutionAnimated = function() {
            const task = tasks[currentTaskIndex];
            if (!task.explanation_sv || task.explanation_sv.length === 0) {
                // No solution available, just show correct answer
                alert('R√§tt svar: ' + task.answer);
                return;
            }
            
            // Disable the button
            const btn = document.getElementById('showSolutionBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Visar...';
            btn.classList.add('opacity-50');
            
            // Show solution container
            const solutionContainer = document.getElementById('solutionContainer');
            const solutionContent = document.getElementById('solutionContent');
            solutionContainer.classList.remove('hidden');
            solutionContent.innerHTML = '';
            
            // Animate steps one by one
            let stepCount = 0;
            let currentStepIndex = 0;
            
            function showNextStep() {
                if (currentStepIndex >= task.explanation_sv.length) {
                    // All steps shown - now show correct answer
                    const answerDiv = document.createElement('div');
                    answerDiv.className = 'mt-4 p-3 bg-green-100 rounded-lg border-2 border-green-300 solution-step-reveal';
                    answerDiv.style.animationDelay = '0.2s';
                    answerDiv.innerHTML = `<strong class="text-green-700">‚úì Svar:</strong> <span id="animatedAnswer">${formatAnswerForDisplay(task.answer)}</span>`;
                    solutionContent.appendChild(answerDiv);
                    
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        MathJax.typesetPromise([answerDiv]);
                    }
                    
                    btn.textContent = 'üëÅÔ∏è Visa mig hur';
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    return;
                }
                
                const block = task.explanation_sv[currentStepIndex];
                if (!block.value) {
                    currentStepIndex++;
                    showNextStep();
                    return;
                }
                
                const div = document.createElement('div');
                div.className = 'solution-step-reveal';
                div.style.animationDelay = '0.1s';
                
                if (block.type === 'text') {
                    div.className += ' problem-text-block';
                    div.innerHTML = formatInlineMath(block.value);
                } else if (block.type === 'math') {
                    div.className += ' problem-math-block';
                    div.innerHTML = `$$${block.value}$$`;
                } else if (block.type === 'step') {
                    stepCount++;
                    div.className += ' step-block';
                    div.innerHTML = `<span class="step-number">${stepCount}.</span><span>${formatInlineMath(block.value)}</span>`;
                }
                
                solutionContent.appendChild(div);
                
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([div]);
                }
                
                currentStepIndex++;
                setTimeout(showNextStep, 800); // 800ms delay between steps
            }
            
            showNextStep();
        };

        // ============ SKIP TASK ============
        window.skipTask = function() {
            const task = tasks[currentTaskIndex];
            
            // Add to skipped tasks to revisit later
            skippedTasks.push({
                index: currentTaskIndex,
                task: task
            });
            
            // Move to next task
            currentTaskIndex++;
            
            // If we've gone through all tasks but have skipped some, offer them again
            if (currentTaskIndex >= tasks.length && skippedTasks.length > 0) {
                // Re-add skipped tasks to the end
                skippedTasks.forEach(skipped => {
                    tasks.push(skipped.task);
                });
                skippedTasks = [];
            }
            
            showTask();
        };

        // Load points on page load
        (function initApp() {
            // Always use light mode
            document.body.classList.add('light-mode');
            
            // Initialize displays
            updateUsernameDisplay();
            updatePointsDisplay();
            updateDailyProgressDisplay();
            updateSessionProgress();
            
            // Apply accessibility settings after a small delay to ensure DOM is ready
            setTimeout(applyAccessibilitySettings, 100);
            
            // Global Enter key listener for navigating after answer
            document.addEventListener('keydown', function(event) {
                if (event.key !== 'Enter') return;
                if (event.defaultPrevented) return;

                const resultDisplay = document.getElementById('resultDisplay');
                const taskArea = document.getElementById('taskArea');

                // Only handle if task area is visible and result is showing
                if (taskArea && !taskArea.classList.contains('hidden') &&
                    resultDisplay && !resultDisplay.classList.contains('hidden')) {
                    event.preventDefault();
                    nextTask();
                }
            });
        })();
    </script>
</body>
</html>
