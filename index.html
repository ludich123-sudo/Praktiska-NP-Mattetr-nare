<!DOCTYPE html>
<html lang="sv" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatematiktrÃ¤nare - Praktiska Gymnasiet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?v=3" async></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        praktiska: {
                            red: '#E3004F',
                            dark: '#1F2937',
                            light: '#F9FAFB',
                            hover: '#C10042',
                            gray: '#b9b9b9',
                            orange: '#f66909'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      },
      startup: {
        typeset: false
      }
    };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        .font-praktiska-stencil {
            font-family: "PF DIN Stencil B Light", "Inter", sans-serif;
        }

        /* MathJax container styles */
        mjx-container[jax="CHTML"][display="true"] {
            display: block !important;
            text-align: center;
            margin: 1em 0 !important;
            font-size: 1.3em; 
            color: #1f2937; 
        }
        .dark mjx-container[jax="CHTML"][display="true"] {
            color: #e5e7eb; 
        }
        mjx-container { 
            display: inline-block !important; 
            margin: 0 2px !important; 
            vertical-align: middle !important;
            position: relative;
            top: -1px;
        }
        
        body { font-family: 'Inter', sans-serif; }
        #progressBar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        #dailyProgressBar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Eld-effekter */
        @keyframes burn-low { 0% { box-shadow: 0 0 5px #f66909; } 50% { box-shadow: 0 0 15px #f66909; } 100% { box-shadow: 0 0 5px #f66909; } }
        @keyframes burn-med { 0% { box-shadow: 0 0 10px #f66909; transform: scale(1); } 50% { box-shadow: 0 0 25px #f66909; transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes burn-high { 0% { box-shadow: 0 0 20px #fcd34d; transform: rotate(0deg); } 50% { box-shadow: 0 0 40px #fcd34d; transform: rotate(1deg); } 100% { transform: rotate(0deg); } }
        .fire-low { animation: burn-low 2s infinite; background-color: #fff7ed !important; }
        .fire-med { animation: burn-med 1s infinite; background-color: #fff7ed !important; }
        .fire-high { animation: burn-high 0.5s infinite; background-color: #fff1f2 !important; border: 2px solid #E3004F !important; }

        .dark .fire-low { background-color: #371b1b !important; }
        .dark .fire-med { background-color: #371b1b !important; }
        .dark .fire-high { background-color: #371b1b !important; }

        /* Kalkylator */
        .calculator-wrapper { position: fixed; top: 120px; right: 20px; z-index: 40; width: 300px; touch-action: none; }
        .calculator { width: 100%; background-color: #1f2937; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .calc-handle { background-color: #111827; color: #9CA3AF; padding: 8px 15px; cursor: grab; display: flex; justify-content: space-between; align-items: center; user-select: none; font-size: 0.8rem; letter-spacing: 1px; }
        .calc-handle:active { cursor: grabbing; }
        .calc-close { cursor: pointer; font-size: 1.2rem; line-height: 1; }
        .calc-close:hover { color: white; }
        .calc-display { color: white; font-size: 3.5rem; font-weight: 300; text-align: right; padding: 10px 20px 10px; overflow: hidden; white-space: nowrap; }
        .calc-button { display: flex; align-items: center; justify-content: center; height: 60px; width: 60px; border-radius: 50%; font-size: 1.5rem; font-weight: 500; cursor: pointer; user-select: none; transition: all 0.1s; margin: 5px; color: white; }
        .calc-button:active { transform: scale(0.95); }
        .calc-func { background-color: #9CA3AF; color: black; }
        .calc-op { background-color: #E3004F; }
        .calc-op-active { background-color: #ffffff !important; color: #E3004F !important; }
        .calc-num { background-color: #374151; }
        .calc-zero { width: 130px; border-radius: 35px; justify-content: start; padding-left: 25px; }

        /* Layout */
        #mainContainer { display: flex; justify-content: center; width: 100%; max-width: 1400px; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #b9b9b9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999999; }
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Partiklar */
        .particle { position: absolute; pointer-events: none; z-index: 100; animation: fly 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes fly {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0) rotate(var(--rot)); opacity: 0; }
        }
        
        .highlight-text { background-color: #fef08a; padding: 0 4px; border-radius: 4px; font-weight: bold; color: #000; }
        .dark .highlight-text { background-color: #854d0e; color: #fff; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col transition-colors duration-300">

    <!-- STOR Inaktivitets-indikator (Startar Dold) -->
    <div id="inactivityOverlay" style="display: none;" class="hidden fixed inset-0 bg-black bg-opacity-90 z-[100] flex flex-col items-center justify-center text-center cursor-pointer backdrop-blur-sm transition-opacity duration-500">
        <div class="text-9xl mb-6 animate-bounce-slow">ðŸ˜´</div>
        <h2 class="text-5xl md:text-7xl font-bold text-white mb-6 drop-shadow-lg">HallÃ¥ dÃ¤r!</h2>
        <p class="text-2xl md:text-3xl text-praktiska-orange font-bold animate-pulse">Klicka var som helst fÃ¶r att fortsÃ¤tta rÃ¤kna!</p>
        <p class="text-gray-400 mt-12 text-sm">Pausar du? Ingen fara, vi vÃ¤ntar.</p>
    </div>

    <!-- Header -->
    <nav class="bg-white dark:bg-gray-800 shadow-md w-full z-10 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-24">
                <div class="flex-shrink-0 flex items-center gap-4">
                    <img src="image_57d296.png" alt="HjÃ¤rna" class="h-12 w-auto animate-pulse-slow hidden md:block" onerror="this.style.display='none'">
                    <img src="https://praktiska.se/wp-content/uploads/2025/11/praktiskalogorgb.svg" alt="Praktiska Gymnasiet" class="h-12 w-auto">
                </div>
                <div class="flex items-center gap-4">
                     <!-- Dark Mode Toggle -->
                     <button id="toggleDarkModeBtn" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 font-medium p-3 rounded-full transition" title="Byt fÃ¤rgtema">
                        <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    </button>

                     <!-- Kalkylatorknapp -->
                     <button id="toggleCalculatorBtn" class="bg-gray-100 dark:bg-gray-700 text-[#f66909] hover:bg-gray-200 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-full transition flex items-center gap-2 border border-transparent hover:border-[#f66909]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        <span class="hidden sm:inline">Kalkylator</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Kalkylatorn -->
    <div id="calculatorWrapper" class="calculator-wrapper" style="display: none;">
        <div class="calculator">
            <div id="calcHandle" class="calc-handle">
                <span>::: DRA HÃ„R</span>
                <span id="closeCalculator" class="calc-close">&times;</span>
            </div>
            <div id="calcDisplay" class="calc-display">0</div>
            <div id="calcButtons" class="grid grid-cols-4 p-3 gap-1">
                <div class="calc-button calc-func" data-value="AC">AC</div><div class="calc-button calc-func" data-value="Â±">Â±</div><div class="calc-button calc-func" data-value="%">%</div><div class="calc-button calc-op" data-value="Ã·">Ã·</div>
                <div class="calc-button calc-num" data-value="7">7</div><div class="calc-button calc-num" data-value="8">8</div><div class="calc-button calc-num" data-value="9">9</div><div class="calc-button calc-op" data-value="Ã—">Ã—</div>
                <div class="calc-button calc-num" data-value="4">4</div><div class="calc-button calc-num" data-value="5">5</div><div class="calc-button calc-num" data-value="6">6</div><div class="calc-button calc-op" data-value="-">-</div>
                <div class="calc-button calc-num" data-value="1">1</div><div class="calc-button calc-num" data-value="2">2</div><div class="calc-button calc-num" data-value="3">3</div><div class="calc-button calc-op" data-value="+">+</div>
                <div class="calc-button calc-num calc-zero col-span-2" data-value="0">0</div><div class="calc-button calc-num" data-value=".">.</div><div class="calc-button calc-op" data-value="=">=</div>
            </div>
        </div>
    </div>

    <!-- HuvudinnehÃ¥ll -->
    <div class="flex-grow flex justify-center p-4 pt-8">
        
        <!-- Applikationskort (Minskad Padding i Toppen) -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 w-full max-w-6xl overflow-hidden h-fit transition-colors duration-300">
            
            <div class="bg-white dark:bg-gray-800 p-4 pb-2 border-b border-gray-100 dark:border-gray-700 flex flex-col md:flex-row items-center justify-between gap-4 transition-colors duration-300">
                <div>
                    <div class="flex items-center gap-4">
                        <h1 class="text-3xl md:text-5xl font-bold text-[#f66909] mb-1 font-praktiska-stencil">MatematiktrÃ¤nare</h1>
                        <img src="image_57d296.png" alt="HjÃ¤rna" class="h-12 w-auto animate-pulse-slow hidden md:block" onerror="this.style.display='none'">
                        <svg class="h-10 w-10 text-gray-300 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 text-left text-lg">TrÃ¤na pÃ¥ typiska uppgifter fÃ¶r Nationella proven</p>
                </div>
            </div>

            <div class="p-6 md:p-10">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <!-- VÃ„NSTERKOLLUMN -->
                    <div class="lg:col-span-4 space-y-6">
                        <div id="modeSelector" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 transition-colors duration-300">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wide mb-2">VÃ¤lj LÃ¤ge</label>
                            <div class="relative">
                                <select id="trainingMode" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange sm:text-sm rounded-lg bg-white dark:bg-gray-800 dark:text-white transition-colors">
                                    <option value="campaign">ðŸš€ KapiteltrÃ¤ning</option>
                                    <option value="free">ðŸŽ¯ Typuppgifter NP</option>
                                </select>
                            </div>
                            <p id="modeDescription" class="text-sm text-gray-500 dark:text-gray-400 mt-3 italic">VÃ¤lj ett kapitel och trÃ¤na strukturerat.</p>
                        </div>

                        <!-- Filter -->
                        <div id="filtersContainer">
                            <div id="freeTrainingFilters" class="space-y-4 hidden">
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">NivÃ¥</label>
                                    <select id="levelFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"><option value="Alla">Alla NivÃ¥er</option><option value="Ã…k 9">Ã…k 9</option><option value="Ma 1">Ma 1</option><option value="Ma 2">Ma 2</option></select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Ã„mne</label>
                                    <select id="topicFilter" disabled class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 dark:text-gray-400"><option value="Alla">Alla Ã„mnen</option></select>
                                </div>
                            </div>
                            <div id="campaignFilters" class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Kampanj</label>
                                    <select id="campaignNameFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                                        <option value="Procent">Procent</option><option value="Sannolikhet">Sannolikhet</option><option value="FunktionerSamband">Funktioner</option><option value="Geometri">Geometri</option><option value="Algebra">Algebra</option><option value="Taluppfattning">Taluppfattning</option><option value="Statistik">Statistik</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Ã…rskurs</label>
                                    <select id="campaignLevelFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"><option value="Ã…k 9">Ã…k 9</option><option value="Ma 1">Ma 1</option><option value="Ma 2">Ma 2</option></select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Kapitel Del</label>
                                    <select id="chapterPartFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"></select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm transition-colors">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-300">Dina framsteg</div>
                                <div class="flex gap-4 text-sm font-bold">
                                    <span class="text-green-600 dark:text-green-400">RÃ¤tt: <span id="scoreDisplay">0</span></span>
                                    <span class="text-gray-400 dark:text-gray-300">Totalt: <span id="totalDisplay">0</span></span>
                                </div>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-600 rounded-full h-3 overflow-hidden"><div id="progressBar" class="bg-green-600 h-3 rounded-full" style="width: 0%"></div></div>
                        </div>

                        <div class="bg-white dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm mt-6">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-300 flex items-center gap-2"><span>Dagens MÃ¥l</span><span class="text-xs text-gray-400">(10 st)</span></div>
                                <div class="flex gap-2 text-sm font-bold"><span id="dailyCountDisplay" class="text-praktiska-orange">0/10</span></div>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-600 rounded-full h-3 overflow-hidden"><div id="dailyProgressBar" class="bg-praktiska-orange h-3 rounded-full" style="width: 0%"></div></div>
                        </div>

                        <div id="streakSection" class="hidden animate-fade-in transition-all duration-500 mt-6">
                            <div id="streakContainer" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 flex flex-col items-center justify-center gap-1 transition-all duration-300">
                                <div class="flex items-center gap-3">
                                    <span class="text-yellow-600 dark:text-yellow-500 font-semibold">Kapitel Streak:</span>
                                    <span id="streakDisplay" class="text-2xl font-black text-praktiska-orange">0/7 ðŸ”¥</span>
                                    <span id="trophyDisplay" class="text-2xl"></span>
                                </div>
                                <div id="dailyStreakDisplay" class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-1">Dagar i rad: 0 ðŸ“…</div>
                            </div>
                        </div>
                    </div>

                    <!-- HÃ–GERKOLLUMN -->
                    <div class="lg:col-span-8">
                        <div id="statusMessage" class="text-center py-12 hidden">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-praktiska-orange mb-4"></div>
                            <p class="text-gray-500 dark:text-gray-400 text-lg">Laddar uppgifter...</p>
                        </div>

                        <div id="problemCard" class="hidden animate-fade-in h-full flex flex-col justify-between">
                            
                            <div>
                                <div class="mb-8 flex justify-center">
                                    <img id="problemImage" src="" alt="Uppgift" class="max-w-full max-h-96 rounded-lg shadow-sm" style="display: none;" onerror="this.style.display='none'; this.src='';">
                                    <canvas id="problemCanvas" class="max-w-full h-auto mx-auto rounded-lg shadow-sm" width="800" height="500" style="display: none;"></canvas>
                                </div>
                                <div id="problemText" class="text-2xl md:text-3xl font-medium text-gray-800 dark:text-gray-100 text-center leading-relaxed mb-8 min-h-[100px]"></div>
                                
                                <!-- SCAFFOLDING -->
                                <div id="scaffoldingContainer" class="hidden mb-6 bg-blue-50 dark:bg-gray-700 p-6 rounded-xl border border-blue-200 dark:border-gray-600">
                                    <h3 class="text-lg font-bold text-blue-800 dark:text-blue-300 mb-4">ðŸ§© LedtrÃ¥dstrappan</h3>
                                    <div id="scaffoldingContent" class="text-gray-800 dark:text-gray-200 text-lg mb-4"></div>
                                    <div id="scaffoldingActions" class="flex gap-2 justify-center"></div>
                                </div>

                                <div id="answerContainer" class="mb-10 max-w-md mx-auto"></div>
                            </div>

                            <div class="mt-auto">
                                <div class="flex flex-col sm:flex-row gap-4 justify-center relative">
                                    <button id="checkAnswerBtn" class="w-full sm:w-2/3 bg-[#f66909] text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg hover:bg-opacity-90 transform hover:-translate-y-1 transition duration-200">RÃ¤tta Svar</button>
                                    <button id="helpBtn" class="hidden w-full sm:w-2/3 bg-blue-600 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg hover:bg-blue-700 transform hover:-translate-y-1 transition duration-200">Jag kÃ¶r fast - FÃ¥ hjÃ¤lp ðŸ’¡</button>
                                    <button id="nextProblemBtn" class="w-full sm:w-2/3 bg-gray-800 dark:bg-gray-600 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg hover:bg-gray-900 dark:hover:bg-gray-500 transform hover:-translate-y-1 transition duration-200" style="display: none;">NÃ¤sta Uppgift</button>
                                </div>

                                <div id="feedback" class="mt-8 text-center font-medium p-6 rounded-xl text-lg hidden border-2"></div>
                            
                                <div class="text-center mt-8">
                                    <button id="showSolutionBtn" class="text-gray-500 dark:text-gray-400 hover:text-[#f66909] dark:hover:text-[#f66909] font-semibold border-b-2 border-transparent hover:border-[#f66909] transition pb-1" style="display: none;">Visa hur man gÃ¶r</button>
                                </div>

                                <div id="solutionInline" class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-8 border border-blue-100 dark:border-blue-800 hidden">
                                    <h3 class="text-xl font-bold text-blue-900 dark:text-blue-300 mb-4 flex items-center gap-2">ðŸ’¡ LÃ¶sning & FÃ¶rklaring</h3>
                                    <div id="solutionText" class="text-blue-800 dark:text-blue-200 prose prose-lg max-w-none"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="text-center text-xs text-gray-300 dark:text-gray-600 mt-12 pt-6 border-t border-gray-100 dark:border-gray-700">ID: <span id="userIdDisplay" class="font-mono">...</span></div>
            </div>
        </div>
    </div>

    <script type="module">
        console.log("Laddar math_trainer.html (Final Stabilization + Math Fix)...");
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD9wbtUB4MUFq1BF00upHxIS6DQK9aS0vQ",
            authDomain: "praktiska-np.firebaseapp.com",
            projectId: "praktiska-np",
            storageBucket: "praktiska-np.firebasestorage.app",
            messagingSenderId: "239785866823",
            appId: "1:239785866823:web:55ffb3a3485d32984ca362"
        };
        
        // FIX: Korrekt init av Firebase (samma app instans fÃ¶r db + auth)
        const firebaseAppInstance = initializeApp(firebaseConfig);
        let db = getFirestore(firebaseAppInstance);
        let auth = getAuth(firebaseAppInstance);
        // ---------------------------------------------------------------

        const appId = 'default-app-id'; 
        const COLLECTION_PATHS = { FREE_TRAINING: `artifacts/${appId}/public/data/math_tasks`, CAMPAIGN_ROOT: `artifacts/${appId}/public/data/campaigns`, USER_SCORE: `artifacts/${appId}/users/` };
        const CAMPAIGN_LEVELS = { "Procent": [{value:1,label:"1. GrundlÃ¤ggande procent"},{value:2,label:"2. FÃ¶rÃ¤ndring & fÃ¶rÃ¤ndringsfaktor"},{value:3,label:"3. Procentenheter & jÃ¤mfÃ¶relser"},{value:4,label:"4. Promille & ppm"},{value:5,label:"5. RÃ¤nta & rÃ¤nta pÃ¥ rÃ¤nta"},{value:6,label:"6. Flera procentuella fÃ¶rÃ¤ndringar i rad"},{value:7,label:"7. Blandad nivÃ¥ â€“ Nationella provet-stil"}], "Sannolikhet": [{value:1,label:"1. GrundlÃ¤ggande begrepp"},{value:2,label:"2. Enkla sannolikheter"},{value:3,label:"3. Flera utfall & kombinatorik"},{value:4,label:"4. MedelvÃ¤rde, median & typvÃ¤rde"},{value:5,label:"5. Frekvenstabeller & diagram"},{value:6,label:"6. Sammansatta sannolikheter"},{value:7,label:"7. KomplementhÃ¤ndelser"},{value:8,label:"8. Blandad nivÃ¥"}], "FunktionerSamband": [{value:1,label:"1. Proportionalitet"},{value:2,label:"2. Tolka grafer"},{value:3,label:"3. RÃ¤t linje"},{value:4,label:"4. SÃ¤tta in och rÃ¤kna"},{value:5,label:"5. SkÃ¤rningspunkter"},{value:6,label:"6. FÃ¶rÃ¤ndring"},{value:7,label:"7. f(x)-uppgifter"},{value:8,label:"8. TillÃ¤mpningar"},{value:9,label:"9. GeoGebra & NP-nivÃ¥"}], "Geometri": [{value:1,label:"1. Area och omkrets"},{value:2,label:"2. Cirkelns area"},{value:3,label:"3. Volym & rymd"},{value:4,label:"4. Enhetsomvandlingar"},{value:5,label:"5. Skala & likformighet"},{value:6,label:"6. Vinklar & Pythagoras"},{value:7,label:"7. Blandad nivÃ¥"}], "Algebra": [{value:1,label:"1. Ekvationer med + och -"},{value:2,label:"2. Multiplikation & division"},{value:3,label:"3. x pÃ¥ bÃ¥da sidor"},{value:4,label:"4. Parenteser"},{value:5,label:"5. BrÃ¥k och decimaler"},{value:6,label:"6. LÃ¶sa ut variabler"},{value:7,label:"7. Faktorisering"},{value:8,label:"8. Kombinerade ekvationer"},{value:9,label:"9. Blandad nivÃ¥"}], "Taluppfattning": [{value:1,label:"1. GrundlÃ¤ggande tal"},{value:2,label:"2. Negativa tal"},{value:3,label:"3. BrÃ¥k och decimaler"},{value:4,label:"4. Procent, promille"},{value:5,label:"5. Potenser & rÃ¶tter"},{value:6,label:"6. Prefix & Ã¶verslag"},{value:7,label:"7. Primtal & delbarhet"},{value:8,label:"8. Reella tal"},{value:9,label:"9. Blandad nivÃ¥"}], "Statistik": [{value:1,label:"1. Diagram"},{value:2,label:"2. Boxplot & spridning"}] };

        // GLOBALA VARIABLER
        let userId;
        let allProblems=[], currentProblem=null, filteredProblems=[], currentScore=0, currentTotal=0, seenProblemIndices=[], currentMode='campaign';
        let campaignStreak=0, chaptersCleared={}, STREAK_TO_PASS=7, dailyTasks=0, dailyStreak=0, lastStudyDate="";
        let isCheckingAnswer=false, inactivityTimer;
        let attempts=0, currentScaffoldStep=0;
        
        // Drag variables
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        const calcHandle = document.getElementById('calcHandle');

        // --- FUNKTIONER ---

        // FIX: Flyttat upp markChapterCleared sÃ¥ den finns nÃ¤r checkAnswer anropar den
        function markChapterCleared() {
            const campaign = document.getElementById('campaignNameFilter').value;
            const chapter = parseInt(document.getElementById('chapterPartFilter').value);
            if (!chaptersCleared[campaign]) { chaptersCleared[campaign] = {}; }
            chaptersCleared[campaign][chapter] = true;
            campaignStreak = 0; 
            saveScore(); 
            updateStreakDisplay();
            
            let label = "OkÃ¤nt kapitel";
            if (CAMPAIGN_LEVELS[campaign]) {
                const found = CAMPAIGN_LEVELS[campaign].find(p => p.value === chapter);
                if (found) label = found.label;
            }
            
            alert(`GRATTIS! Du har klarat ${campaign} - Del ${label}!`);
        }

        function getNiceStep(range){if(range===0)return 1;const t=8,r=range/t,m=Math.pow(10,Math.floor(Math.log10(r))),b=r/m;return b<1.5?1*m:b<3.5?2*m:5*m}
        function renderDrawData(canvas,d){
             const ctx = canvas.getContext('2d'); const w=canvas.width,h=canvas.height;
             ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);
             if(d.type==='table'){const cellW=120,cellH=50,startX=(w-cellW*2)/2,startY=(h-cellH*(d.rows.length+1))/2;ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.font='bold 20px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='#f3f4f6';ctx.fillRect(startX,startY,cellW,cellH);ctx.fillRect(startX+cellW,startY,cellW,cellH);ctx.strokeRect(startX,startY,cellW,cellH);ctx.strokeRect(startX+cellW,startY,cellW,cellH);ctx.fillStyle='#000';ctx.fillText(d.headers[0],startX+cellW/2,startY+cellH/2);ctx.fillText(d.headers[1],startX+cellW+cellW/2,startY+cellH/2);ctx.font='20px Arial';d.rows.forEach((r,i)=>{const y=startY+(i+1)*cellH;ctx.strokeRect(startX,y,cellW,cellH);ctx.strokeRect(startX+cellW,y,cellW,cellH);ctx.fillStyle='#000';ctx.fillText(r[0],startX+cellW/2,y+cellH/2);if(r[1]==='?') {ctx.fillStyle='#e11d48';ctx.font='bold 24px Arial';} else {ctx.fillStyle='#000';ctx.font='20px Arial';}ctx.fillText(r[1],startX+cellW+cellW/2,y+cellH/2);});
             }else if(d.type==='graph'){const range=d.range,margin=60,plotW=w-2*margin,plotH=h-2*margin,xR=range.xMax-range.xMin,yR=range.yMax-range.yMin,sX=d.forceStepX||getNiceStep(xR),sY=d.forceStepY||getNiceStep(yR),toX=(v)=>margin+((v-range.xMin)/xR)*plotW,toY=(v)=>h-margin-((v-range.yMin)/yR)*plotH;ctx.strokeStyle='#e5e7eb';ctx.lineWidth=1;ctx.beginPath();for(let x=Math.ceil(range.xMin/sX)*sX;x<=range.xMax;x+=sX){if(d.gridOnlyPositive&&x<0)continue;const px=toX(x);ctx.moveTo(px,margin);ctx.lineTo(px,h-margin);}for(let y=Math.ceil(range.yMin/sY)*sY;y<=range.yMax;y+=sY){if(d.gridOnlyPositive&&y<0)continue;const py=toY(y);ctx.moveTo(margin,py);ctx.lineTo(w-margin,py);}ctx.stroke();ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.beginPath();const y0=toY(0);if(y0>=margin&&y0<=h-margin){ctx.moveTo(margin,y0);ctx.lineTo(w-margin,y0);}else if(d.gridOnlyPositive){ctx.moveTo(margin,h-margin);ctx.lineTo(w-margin,h-margin);}const x0=toX(0);if(x0>=margin&&x0<=w-margin){ctx.moveTo(x0,margin);ctx.lineTo(x0,h-margin);}else if(d.gridOnlyPositive){ctx.moveTo(margin,margin);ctx.lineTo(margin,h-margin);}ctx.stroke();ctx.fillStyle='#374151';ctx.font='12px Arial';ctx.textAlign='center';ctx.textBaseline='top';for(let x=Math.ceil(range.xMin/sX)*sX;x<=range.xMax;x+=sX){if(Math.abs(x)<0.0001&&!d.gridOnlyPositive)continue;const px=toX(x);let py=toY(0)+8;if(d.gridOnlyPositive)py=h-margin+8;ctx.fillText(parseFloat(x.toFixed(2)),px,py);}ctx.textAlign='right';ctx.textBaseline='middle';for(let y=Math.ceil(range.yMin/sY)*sY;y<=range.yMax;y+=sY){if(Math.abs(y)<0.0001&&!d.gridOnlyPositive)continue;let px=toX(0)-8;if(d.gridOnlyPositive)px=margin-8;const py=toY(y);ctx.fillText(parseFloat(y.toFixed(2)),px,py);}d.funcs.forEach(f=>{ctx.strokeStyle=f.color;ctx.lineWidth=3;ctx.beginPath();let first=true;for(let px=margin;px<=w-margin;px+=2){const valX=range.xMin+((px-margin)/plotW)*xR;try{const y=Function('x',`return ${f.expression}`)(valX);const py=toY(y);if(py>=margin&&py<=h-margin){if(first){ctx.moveTo(px,py);first=false;}else{ctx.lineTo(px,py);}}else{first=true;}}catch(e){}}ctx.stroke();});if(d.points){d.points.forEach(p=>{const px=toX(p.x),py=toY(p.y);if(p.showLine){ctx.strokeStyle=p.color||'#000';ctx.setLineDash([5,5]);ctx.lineWidth=1;ctx.beginPath();const ya=d.gridOnlyPositive?h-margin:toY(0);const xa=d.gridOnlyPositive?margin:toX(0);ctx.moveTo(px,ya);ctx.lineTo(px,py);ctx.lineTo(xa,py);ctx.stroke();ctx.setLineDash([]);}ctx.fillStyle=p.color||'#000';ctx.beginPath();ctx.arc(px,py,5,0,2*Math.PI);ctx.fill();if(p.label){ctx.font='bold 14px Arial';ctx.fillStyle='#fff';ctx.strokeStyle=p.color;ctx.lineWidth=3;ctx.strokeText(p.label,px+10,py-10);ctx.fillText(p.label,px+10,py-10);}});}}
        }

        function getTopicIcon(t){return "ðŸ“š"} 
        function formatMathText(t){
            if(!t)return"";
            if(t.includes("\\frac"))return t;
            let s = t.replace(/\s*\*\s*/g, " \\cdot ");
            s = s.replace(/(\b[a-zA-Z0-9]+\b)\s*\/\s*(\b[a-zA-Z0-9]+\b)/g, "\\frac{$1}{$2}");
            s = s.replace(/([0-9]*[a-zA-Z])\^([0-9a-zA-Z\-]+)/g, "$1^{$2}");
            
            // Kapsla in matematiska uttryck i $$...$$ (Block Math) fÃ¶r "ny rad" och snygghet
            // Men undvik att kapsla in vanliga ord!
            const mathRegex = /([0-9a-zA-Z\(\)\.\,\-]*\s*(\^\{[^\}]+\}|\\frac\{[^\}]+\}\{[^\}]+\}|\\cdot)\s*[0-9a-zA-Z\(\)\.\,\+\-\=\s]*)/g;
            s = s.replace(mathRegex, "$$$1$$");

            return s;
        }
        
        function updateDailyUI() { 
            const dCD = document.getElementById('dailyCountDisplay');
            const dPB = document.getElementById('dailyProgressBar');
            const dSD = document.getElementById('dailyStreakDisplay');
            dCD.textContent = `${dailyTasks}/10`;
            const pct = Math.min((dailyTasks / 10) * 100, 100);
            if (dPB) dPB.style.width = `${pct}%`;
            if(dSD) dSD.textContent = `Dagar i rad: ${dailyStreak} ðŸ“…`;
            if (dailyTasks >= 10) { dCD.classList.add('text-green-600', 'font-black'); dCD.textContent = "MÃ…L NÃ…TT! ðŸŽ‰"; }
        }

        function updateScoreDisplay() {
            document.getElementById('scoreDisplay').textContent = currentScore;
            document.getElementById('totalDisplay').textContent = currentTotal;
            updateProgressBar();
        }

        function updateProgressBar() {
            let percent;
            if (currentMode === 'campaign') { percent = (campaignStreak / STREAK_TO_PASS) * 100; if (percent > 100) percent = 100; }
            else { percent = (currentTotal === 0) ? 0 : (currentScore / currentTotal) * 100; }
            document.getElementById('progressBar').style.width = `${percent}%`;
        }

        function updateStreakDisplay() {
            const streakContainer = document.getElementById('streakContainer');
            const streakSection = document.getElementById('streakSection');
            const streakDisplay = document.getElementById('streakDisplay');
            const trophyDisplay = document.getElementById('trophyDisplay');
            const campaignNameFilter = document.getElementById('campaignNameFilter');
            const chapterPartFilter = document.getElementById('chapterPartFilter');

            streakContainer.className = "bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 flex flex-col items-center justify-center gap-1 transition-all duration-300";
            if (campaignStreak >= 3) streakContainer.classList.add('fire-low');
            if (campaignStreak >= 5) { streakContainer.classList.remove('fire-low'); streakContainer.classList.add('fire-med'); }
            if (campaignStreak >= 6) { streakContainer.classList.remove('fire-med'); streakContainer.classList.add('fire-high'); }
            if (currentMode === 'campaign') {
                streakSection.classList.remove('hidden');
                streakDisplay.textContent = `${campaignStreak}/${STREAK_TO_PASS} ðŸ”¥`;
                const campaign = document.getElementById('campaignNameFilter').value;
                const chapter = parseInt(document.getElementById('chapterPartFilter').value);
                const isCleared = chaptersCleared[campaign] && chaptersCleared[campaign][chapter];
                if (isCleared) { trophyDisplay.innerHTML = 'ðŸ†'; streakDisplay.classList.remove('text-praktiska-red'); streakDisplay.classList.add('text-green-600'); }
                else { trophyDisplay.innerHTML = ''; streakDisplay.classList.add('text-praktiska-red'); streakDisplay.classList.remove('text-green-600'); }
            } else {
                streakSection.classList.add('hidden');
            }
        }
        
        async function loadScore() {
            if (!userId || !db) return;
            const scoreDocPath = `${COLLECTION_PATHS.USER_SCORE}${userId}/progress/score_data`;
            try {
                const docRef = doc(db, scoreDocPath);
                getDoc(docRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentScore = data.score || 0; currentTotal = data.total || 0; campaignStreak = data.streak || 0; chaptersCleared = data.cleared || {};
                        dailyTasks = data.dailyTasks || 0; dailyStreak = data.dailyStreak || 0; lastStudyDate = data.lastStudyDate || "";
                        const today = new Date().toISOString().split('T')[0];
                        if (lastStudyDate !== today) dailyTasks = 0;
                    }
                    updateScoreDisplay(); updateStreakDisplay(); updateDailyUI();
                });
            } catch (error) { console.error("Fel vid laddning av poÃ¤ng:", error); }
        }

        async function saveScore() {
            if (!userId || !db) return;
            const scoreDocPath = `${COLLECTION_PATHS.USER_SCORE}${userId}/progress/score_data`;
            try {
                setDoc(doc(db, scoreDocPath), { 
                    score: currentScore, total: currentTotal, streak: campaignStreak, cleared: chaptersCleared,
                    dailyTasks: dailyTasks, dailyStreak: dailyStreak, lastStudyDate: lastStudyDate
                }, { merge: true });
            } catch (error) { console.error("Fel vid sparning av poÃ¤ng:", error); }
        }

        function resetScore(full) {
            if (full) { currentScore = 0; currentTotal = 0; updateScoreDisplay(); saveScore(); }
            seenProblemIndices = []; campaignStreak = 0; updateStreakDisplay();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            const ol = document.getElementById('inactivityOverlay');
            if (ol) ol.style.display = 'none';
            inactivityTimer = setTimeout(() => { if (ol) ol.style.display = 'flex'; }, 120000); 
        }

        function triggerConfetti(element) {
            const colors = ['#E3004F', '#f66909', '#FCD34D', '#10B981', '#3B82F6'];
            const rect = element.getBoundingClientRect();
            const center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };
            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.width = Math.random() * 12 + 6 + 'px'; particle.style.height = particle.style.width;
                particle.style.left = center.x + 'px'; particle.style.top = center.y + 'px'; particle.style.borderRadius = '50%'; 
                const angle = Math.random() * Math.PI * 2; const velocity = Math.random() * 400 + 100; 
                const tx = Math.cos(angle) * velocity; const ty = Math.sin(angle) * velocity;
                particle.style.setProperty('--tx', `${tx}px`); particle.style.setProperty('--ty', `${ty}px`);
                particle.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`);
                document.body.appendChild(particle);
                setTimeout(() => { particle.remove(); }, 1500);
            }
        }

        function loadAllProblems() {
            if(!db) return;
            const status = document.getElementById('statusMessage');
            status.style.display = "block";
            
            if(currentMode === 'free') {
                const topics = Object.keys(CAMPAIGN_LEVELS);
                allProblems = []; 
                const promises = topics.map(async t => {
                    try {
                        const s = await getDocs(collection(db, `${COLLECTION_PATHS.FREE_TRAINING}/${t}/tasks`));
                        const temp = [];
                        s.forEach(d => temp.push({id:d.id, ...d.data(), topic:t}));
                        return temp;
                    } catch(e) { return []; }
                });
                Promise.all(promises).then(results => {
                    allProblems = results.flat();
                    if(allProblems.length === 0) status.textContent = "Hittade inga typuppgifter.";
                    else { status.style.display = "none"; document.getElementById('problemCard').style.display = 'flex'; populateFilters(); applyFiltersAndRender(); }
                });
            } else {
                const camp = document.getElementById('campaignNameFilter').value;
                try {
                    getDocs(collection(db, `${COLLECTION_PATHS.CAMPAIGN_ROOT}/${camp}/tasks`)).then(s => {
                        allProblems = []; s.forEach(d => allProblems.push({id:d.id, ...d.data()}));
                        if(allProblems.length === 0) status.textContent = "Inga uppgifter i detta kapitel.";
                        else { document.getElementById('statusMessage').style.display = "none"; document.getElementById('problemCard').style.display = 'flex'; populateChapterPartsFilter(); }
                    });
                } catch(e) { console.error(e); }
            }
        }
        
        function populateFilters() {
            const lvlFilter = document.getElementById('levelFilter').value;
            let filtered = (lvlFilter === 'Alla') ? allProblems : allProblems.filter(p => p.level === lvlFilter);
            const topics = [...new Set(filtered.map(p => p.topic || p.campaignName || 'OkÃ¤nt'))].sort();
            const el = document.getElementById('topicFilter');
            el.innerHTML = '<option value="Alla">Alla Ã„mnen</option>';
            topics.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; el.appendChild(o); });
            el.disabled = false; el.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }

        function applyFiltersAndRender() {
            let temp = allProblems;
            if(currentMode === 'free') {
                const lvl = document.getElementById('levelFilter').value;
                const top = document.getElementById('topicFilter').value;
                if(lvl !== 'Alla') {
                    if(lvl === 'Ã…k 9' || lvl === 'Ma 1') temp = temp.filter(p => { const l = p.campaignLevel||p.level; return l==='Ã…k 9'||l==='Ma 1'; });
                    else temp = temp.filter(p => (p.campaignLevel||p.level) === lvl);
                }
                if(top !== 'Alla') temp = temp.filter(p => p.topic === top || p.campaignName === top);
            } else {
                const cLvl = document.getElementById('campaignLevelFilter').value;
                const cPart = parseInt(document.getElementById('chapterPartFilter').value);
                temp = temp.filter(p => {
                    const l = p.campaignLevel||p.level;
                    const match = (cLvl==='Ã…k 9'||cLvl==='Ma 1') ? (l==='Ã…k 9'||l==='Ma 1') : l===cLvl;
                    return match && p.chapterLevel === cPart;
                });
            }
            filteredProblems = temp;
            if(filteredProblems.length > 0) {
                seenProblemIndices = [];
                let idx = Math.floor(Math.random() * filteredProblems.length);
                currentProblem = filteredProblems[idx];
                renderProblem(currentProblem);
            } else {
                document.getElementById('problemCard').style.display = 'none';
                document.getElementById('statusMessage').style.display = 'block';
                document.getElementById('statusMessage').textContent = "Inga uppgifter matchade filtret.";
            }
        }

        function switchMode() {
            currentMode = document.getElementById('trainingMode').value;

            if (currentMode === 'free') {
                document.getElementById('freeTrainingFilters').classList.remove('hidden');
                document.getElementById('campaignFilters').classList.add('hidden');
                document.getElementById('modeDescription').textContent = "VÃ¤lj nivÃ¥ och Ã¤mne fÃ¶r typuppgifter.";
            } else {
                document.getElementById('campaignFilters').classList.remove('hidden');
                document.getElementById('freeTrainingFilters').classList.add('hidden');
                document.getElementById('modeDescription').textContent = "VÃ¤lj ett kapitel och trÃ¤na strukturerat.";
            }

            resetScore(true);
            loadAllProblems();
        }

        function populateChapterPartsFilter() {
            const s = document.getElementById('campaignNameFilter').value;
            const p = CAMPAIGN_LEVELS[s] || [];
            const el = document.getElementById('chapterPartFilter');
            el.innerHTML = '';
            p.forEach(part => {
                const o = document.createElement('option');
                o.value = part.value; o.textContent = part.label;
                el.appendChild(o);
            });
            applyFiltersAndRender();
        }

        function renderProblem(p) {
            if(!p) return;
            // VIKTIGT: Uppdatera den globala variabeln currentProblem
            currentProblem = p;

            document.getElementById('problemCard').style.display = 'flex';
            document.getElementById('statusMessage').style.display = 'none';
            
            document.getElementById('problemText').innerHTML = formatMathText(p.question_sv||'');
            document.getElementById('feedback').style.display = "none";
            
            const chk = document.getElementById('checkAnswerBtn'); 
            chk.disabled = false; 
            chk.style.display = "block";
            chk.textContent = "RÃ¤tta Svar"; // FIX: Ã…terstÃ¤ll texten!

            document.getElementById('helpBtn').style.display = "none";
            document.getElementById('nextProblemBtn').style.display = "none"; 
            document.getElementById('showSolutionBtn').style.display = "none";
            document.getElementById('solutionInline').style.display = "none";
            document.getElementById('scaffoldingContainer').classList.add('hidden');
            
            // RESET ANSWER CONTAINER & VISIBILITY
            const ac = document.getElementById('answerContainer');
            ac.classList.remove('hidden'); 
            
            const img = document.getElementById('problemImage');
            const cvs = document.getElementById('problemCanvas');
            img.style.display = 'none'; cvs.style.display = 'none';

            if(p.drawData) { cvs.style.display = 'block'; renderDrawData(cvs, p.drawData); } 
            else if(p.imageUrl) { img.src = p.imageUrl; img.style.display = 'block'; }

            // SCAFFOLDING CHECK: If problem has scaffolding, start it immediately
            if (p.scaffolding && p.scaffolding.length > 0) {
                startScaffolding(); 
                // DO NOT hide input or check button anymore
            } 
            
            // Always render the input field now
            const type = p.answerType || 'text';
            ac.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar:</label><input type="${type==='number'?'number':'text'}" id="answerInput" class="w-full p-3.5 border rounded-lg text-lg dark:bg-gray-700 dark:text-white" placeholder="Skriv ditt svar...">`;

            if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([document.getElementById('problemText')]);
            attempts = 0; currentScaffoldStep = 0;
        }

        function checkAnswer() {
            try {
                if (isCheckingAnswer) return;
                isCheckingAnswer = true; 
                
                const inp = document.getElementById('answerInput');
                if (!inp) { return; } 
                const uAns = inp.value.trim();
                const cAns = String(currentProblem.correctAnswer).trim();
                let correct = false;
                const clean = (s) => s.replace(/,/g, '.').replace(/[^0-9.\-]/g, '');
                if(parseFloat(clean(uAns)) === parseFloat(clean(cAns)) || uAns.toLowerCase() === cAns.toLowerCase()) correct = true;

                const fb = document.getElementById('feedback');
                currentTotal++;

                if(correct) {
                    fb.innerHTML = `<div class="text-lg font-bold text-green-800 mb-1">RÃ¤tt svar!</div>`;
                    fb.className = "mt-6 text-center p-4 rounded-xl bg-green-100 text-green-800 border border-green-200";
                    
                    // Hide Scaffolding if visible to clean up
                    document.getElementById('scaffoldingContainer').classList.add('hidden');

                    if(attempts === 0) {
                        currentScore++; campaignStreak++; triggerConfetti(document.getElementById('checkAnswerBtn'));
                        const today = new Date().toISOString().split('T')[0];
                        if(lastStudyDate === today) dailyTasks++;
                        else { dailyTasks = 1; if(lastStudyDate) dailyStreak = (new Date(lastStudyDate).getTime() === new Date().getTime() - 86400000) ? dailyStreak+1 : 1; else dailyStreak=1; }
                        lastStudyDate = today;
                        updateDailyUI();
                        saveScore();
                    }
                    if(currentMode === 'campaign' && campaignStreak >= STREAK_TO_PASS) markChapterCleared();
                    document.getElementById('checkAnswerBtn').style.display = "none"; document.getElementById('helpBtn').style.display = "none"; document.getElementById('nextProblemBtn').style.display = "block";
                } else {
                    attempts++;
                    fb.style.display = "block";
                    if(attempts === 1) {
                        // FIRST FAIL: Show Hint
                        let hint = currentProblem.hint_sv ? formatMathText(currentProblem.hint_sv) : "FÃ¶rsÃ¶k igen! Kontrollera dina berÃ¤kningar.";
                        fb.innerHTML = `
                            <div class="mb-2 text-lg font-bold text-yellow-800">Inte riktigt rÃ¤tt Ã¤n...</div>
                            <div class="text-gray-700 mb-3">${hint}</div>
                            <div class="text-sm font-semibold text-yellow-700">Prova en gÃ¥ng till!</div>
                        `;
                        fb.className = "mt-6 text-center p-6 rounded-xl bg-yellow-50 border-2 border-yellow-200 shadow-sm";
                        if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([fb]);

                        // Re-enable button for retry
                        const btn = document.getElementById('checkAnswerBtn');
                        btn.disabled = false;
                        btn.textContent = "FÃ¶rsÃ¶k igen";
                        
                        document.getElementById('helpBtn').style.display = "none";
                        isCheckingAnswer = false; // Allow new click immediately
                        return; // Exit early so we don't disable button below

                    } else {
                        // SECOND FAIL
                        fb.innerHTML = `<div class="font-bold text-red-800 mb-2">TyvÃ¤rr, det blev fel igen.</div><div>RÃ¤tt svar var: ${formatMathText(cAns)}</div>`;
                        fb.className = "mt-6 text-center font-medium p-6 rounded-xl bg-red-50 border-2 border-red-200";
                        if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([fb]);

                        campaignStreak = 0;
                        document.getElementById('checkAnswerBtn').style.display = "none"; document.getElementById('helpBtn').style.display = "none"; document.getElementById('nextProblemBtn').style.display = "block"; 
                        
                        // Show full solution if available
                        if (currentProblem.explanation_sv) {
                            document.getElementById('solutionText').innerHTML = formatMathText(currentProblem.explanation_sv);
                            document.getElementById('solutionInline').style.display = "block";
                             if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([document.getElementById('solutionText')]);
                        }
                    }
                }
                updateScoreDisplay(); updateStreakDisplay();
                isCheckingAnswer = false;
            } catch (e) {
                console.error("Check Answer Error:", e);
            } finally {
                isCheckingAnswer = false;
            }
        }

        function startScaffolding() {
            document.getElementById('helpBtn').style.display = "none";
            document.getElementById('scaffoldingContainer').classList.remove('hidden');
            currentScaffoldStep = 0; renderScaffoldStep();
        }

        function renderScaffoldStep() {
            const steps = currentProblem.scaffolding;
            const container = document.getElementById('scaffoldingContainer');
            const content = document.getElementById('scaffoldingContent');
            const actions = document.getElementById('scaffoldingActions');
            
            if (!currentProblem.scaffolding || currentScaffoldStep >= steps.length) { 
                container.classList.add('hidden');
                // SCAFFOLDING DONE -> Show Answer Input
                const ac = document.getElementById('answerContainer');
                ac.classList.remove('hidden');
                const type = currentProblem.answerType || 'text';
                ac.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar (endast siffror):</label><input type="${type==='number'?'number':'text'}" id="answerInput" class="w-full p-3.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange focus:outline-none text-lg placeholder-gray-400 dark:bg-gray-700 dark:text-white" placeholder="Skriv ditt svar...">`;
                
                const fb = document.getElementById('feedback');
                fb.innerHTML = `<div class="text-lg font-bold text-green-800 mb-1">Snyggt! Nu fixar du resten.</div>`;
                fb.className = "mt-6 text-center p-4 rounded-xl bg-green-50 text-green-800 border border-green-100 mb-4";
                fb.style.display = 'block';

                const chk = document.getElementById('checkAnswerBtn');
                chk.style.display = "block"; 
                chk.disabled = false;
                return;
            }
            const step = steps[currentScaffoldStep];
            content.innerHTML = ''; actions.innerHTML = '';
            
            if(step.type === 'highlight') {
                content.innerHTML = `<p class="mb-2 font-medium">LedtrÃ¥d ${currentScaffoldStep+1}</p><p>${step.text.replace(/\*\*(.*?)\*\*/g, '<span class="highlight-text">$1</span>')}</p>`;
                const b = document.createElement('button'); b.className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"; b.textContent="NÃ¤sta";
                b.onclick = () => { currentScaffoldStep++; renderScaffoldStep(); };
                actions.appendChild(b);
            } else if(step.type === 'info') {
                content.innerHTML = `<p class="mb-2 font-medium">LedtrÃ¥d ${currentScaffoldStep+1}</p><p>${formatMathText(step.text)}</p>`;
                if(window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([content]);
                const b = document.createElement('button'); b.className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"; b.textContent="Okej!";
                b.onclick = () => { 
                     container.classList.add('hidden'); 
                     const ac = document.getElementById('answerContainer');
                     ac.classList.remove('hidden');
                     const type = currentProblem.answerType || 'text';
                     ac.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar:</label><input type="${type==='number'?'number':'text'}" id="answerInput" class="w-full p-3.5 border rounded-lg text-lg dark:bg-gray-700 dark:text-white">`;
                     document.getElementById('checkAnswerBtn').style.display = "block"; 
                     document.getElementById('checkAnswerBtn').disabled = false; 
                };
                actions.appendChild(b);
            } else if(step.type === 'choice') {
                content.innerHTML = `<p class="mb-4 font-medium">LedtrÃ¥d ${currentScaffoldStep+1}: ${step.question}</p>`;
                const grid = document.createElement('div'); grid.className = "grid grid-cols-1 gap-2";
                
                step.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white border-2 border-gray-200 p-3 rounded-lg hover:border-blue-500 text-left dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200";
                    // FIX: Use innerHTML to allow math rendering in choices
                    btn.innerHTML = formatMathText(opt); 
                    btn.onclick = () => {
                        if(idx === step.correctIndex) {
                            btn.classList.add('bg-green-100', 'border-green-500', 'dark:bg-green-900');
                            setTimeout(() => { currentScaffoldStep++; renderScaffoldStep(); }, 600);
                        } else {
                            btn.classList.add('bg-red-100', 'border-red-500', 'dark:bg-red-900');
                        }
                    };
                    grid.appendChild(btn);
                });
                content.appendChild(grid);
                if(window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([content]);
            }
        }

        // Drag and Drop
        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if (e.target === calcHandle || calcHandle.contains(e.target)) {
                isDragging = true;
            }
        }
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, calculatorWrapper);
            }
        }
        function setTranslate(xPos, yPos, el) {
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
        }

        function showSolution() {
            if (!currentProblem || !currentProblem.explanation_sv) { document.getElementById('solutionText').textContent = "Det finns tyvÃ¤rr ingen fÃ¶rklaring till den hÃ¤r uppgiften."; }
            else { document.getElementById('solutionText').innerHTML = formatMathText(currentProblem.explanation_sv); }
            document.getElementById('solutionInline').style.display = "block"; 
            document.getElementById('showSolutionBtn').style.display = "none"; 
            if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([document.getElementById('solutionText')]);
        }

        // Kalkylator Logic
        const calcButtons = document.getElementById('calcButtons');
        const calcDisplay = document.getElementById('calcDisplay'); 
        let currentInput = '0', operator = null, firstOperand = null, awaitingSecondOperand = false;
        
        function clearOperatorHighlight() { document.querySelectorAll('.calc-op').forEach(btn => { btn.classList.remove('calc-op-active'); }); }
        calcButtons.addEventListener('click', (e) => {
            if (!e.target.classList.contains('calc-button')) return;
            const value = e.target.dataset.value;
            if (e.target.classList.contains('calc-num') || value === '.') {
                clearOperatorHighlight(); 
                if (awaitingSecondOperand) { currentInput = value === '.' ? '0.' : value; awaitingSecondOperand = false; } 
                else if (currentInput === '0' && value !== '.') { currentInput = value; } 
                else if (value === '.' && currentInput.includes('.')) { } 
                else { currentInput += value; }
            } else if (e.target.classList.contains('calc-op')) {
                if (value === '=') {
                    if (operator && firstOperand !== null) { currentInput = calculate(firstOperand, operator, parseFloat(currentInput)); operator = null; firstOperand = null; awaitingSecondOperand = true; }
                    clearOperatorHighlight();
                } else {
                    clearOperatorHighlight(); e.target.classList.add('calc-op-active');
                    if (firstOperand === null) { firstOperand = parseFloat(currentInput); } 
                    else if (operator) { const result = calculate(firstOperand, operator, parseFloat(currentInput)); firstOperand = result; currentInput = result; }
                    operator = value; awaitingSecondOperand = true;
                }
            } else if (e.target.classList.contains('calc-func')) {
                clearOperatorHighlight();
                if (value === 'AC') { currentInput = '0'; operator = null; firstOperand = null; awaitingSecondOperand = false; } 
                else if (value === 'Â±') { currentInput = String(parseFloat(currentInput) * -1); } 
                else if (value === '%') { currentInput = String(parseFloat(currentInput) / 100); }
            }
            calcDisplay.textContent = currentInput.substring(0, 10);
        });
        function calculate(n1, op, n2) { switch (op) { case '+': return String(n1 + n2); case '-': return String(n1 - n2); case 'Ã—': return String(n1 * n2); case 'Ã·': return String(n1 / n2); default: return n2; } }


        // --- START AV APPEN ---
        document.addEventListener('DOMContentLoaded', () => {
            // FIREBASE INITIALISERING
            const firebaseAppInstance = initializeApp(firebaseConfig);
            db = getFirestore(firebaseAppInstance);
            auth = getAuth(firebaseAppInstance);

            // KOPPLA HÃ„NDELSELYSSNARE
            trainingMode.addEventListener('change', switchMode);
            campaignNameFilter.addEventListener('change', () => { resetScore(true); loadAllProblems(); });
            campaignLevelFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
            chapterPartFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
            levelFilter.addEventListener('change', () => { resetScore(true); populateFilters(); applyFiltersAndRender(); });
            topicFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
            checkAnswerBtn.addEventListener('click', checkAnswer);
            nextProblemBtn.addEventListener('click', applyFiltersAndRender);
            document.getElementById('helpBtn').addEventListener('click', startScaffolding);
            document.getElementById('showSolutionBtn').addEventListener('click', showSolution);
            
            // Drag-hÃ¤ndelser
            if (calcHandle) {
                calcHandle.addEventListener("mousedown", dragStart);
                calcHandle.addEventListener("touchstart", dragStart, {passive: false});
                document.addEventListener("mouseup", dragEnd);
                document.addEventListener("touchend", dragEnd);
                document.addEventListener("mousemove", drag);
                document.addEventListener("touchmove", drag, {passive: false});
            }

            // Kalkylator hÃ¤ndelser
            if (closeCalculator) {
                 closeCalculator.addEventListener('click', () => { calculatorWrapper.style.display = 'none'; toggleCalculatorBtn.querySelector('span').textContent = 'Visa Kalkylator'; });
            }
            if (toggleCalculatorBtn) {
                 toggleCalculatorBtn.addEventListener('click', () => {
                     const isVisible = calculatorWrapper.style.display !== 'none';
                     calculatorWrapper.style.display = isVisible ? 'none' : 'block';
                     toggleCalculatorBtn.querySelector('span').textContent = isVisible ? 'DÃ¶lj Kalkylator' : 'Visa Kalkylator';
                 });
            }
            
            document.getElementById('inactivityOverlay').addEventListener('click', resetInactivityTimer);


            // START INLOGGNING OCH DATAHÃ„MTNING
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('userIdDisplay').textContent = userId;
                    loadScore(); 
                    loadAllProblems();
                    resetInactivityTimer(); 
                } else {
                    signInAnonymously(auth); 
                }
            });
        }); // END DOMContentLoaded
    </script>
</body>
</html>
