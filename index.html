<!DOCTYPE html>
<html lang="sv" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematiktr√§nare - Praktiska Gymnasiet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?v=3" async></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Aktiverar manuellt dark mode
            theme: {
                extend: {
                    colors: {
                        praktiska: {
                            red: '#E3004F',
                            dark: '#1F2937',
                            light: '#F9FAFB',
                            hover: '#C10042',
                            gray: '#b9b9b9',
                            orange: '#f66909'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        .font-praktiska-stencil {
            font-family: "PF DIN Stencil B Light", "Inter", sans-serif;
        }

        mjx-container { display: inline-block; margin: 0; padding: 0; font-size: 1.1rem; text-align: left; }
        body { font-family: 'Inter', sans-serif; }
        #progressBar { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Eld-effekter f√∂r Streak */
        @keyframes burn-low {
            0% { box-shadow: 0 0 5px #f66909; border-color: #f66909; }
            50% { box-shadow: 0 0 15px #f66909, 0 0 5px #E3004F; border-color: #E3004F; }
            100% { box-shadow: 0 0 5px #f66909; border-color: #f66909; }
        }
        @keyframes burn-med {
            0% { box-shadow: 0 0 10px #f66909, 0 0 20px #E3004F; transform: scale(1); }
            50% { box-shadow: 0 0 25px #f66909, 0 0 50px #E3004F; transform: scale(1.02); }
            100% { box-shadow: 0 0 10px #f66909, 0 0 20px #E3004F; transform: scale(1); }
        }
        @keyframes burn-high {
            0% { box-shadow: 0 0 20px #fcd34d, 0 0 40px #f66909, 0 0 60px #E3004F; transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(-1deg); }
            50% { box-shadow: 0 0 40px #fcd34d, 0 0 80px #f66909, 0 0 100px #E3004F; transform: scale(1.05) rotate(1deg); }
            75% { transform: scale(1.05) rotate(-1deg); }
            100% { box-shadow: 0 0 20px #fcd34d, 0 0 40px #f66909, 0 0 60px #E3004F; transform: scale(1) rotate(0deg); }
        }

        .fire-low { animation: burn-low 2s infinite; background-color: #fff7ed !important; }
        .fire-med { animation: burn-med 1s infinite; background-color: #fff7ed !important; }
        .fire-high { animation: burn-high 0.5s infinite; background-color: #fff1f2 !important; border: 2px solid #E3004F !important; }

        /* Dark mode adjustments for fire */
        .dark .fire-low { background-color: #371b1b !important; }
        .dark .fire-med { background-color: #371b1b !important; }
        .dark .fire-high { background-color: #371b1b !important; }


        /* Kalkylator */
        .calculator-wrapper {
            position: fixed;
            top: 120px;
            right: 20px;
            z-index: 40;
            width: 300px;
            touch-action: none;
        }
        .calculator {
            width: 100%;
            background-color: #1f2937;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .calc-handle {
            background-color: #111827;
            color: #9CA3AF;
            padding: 8px 15px;
            cursor: grab;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        .calc-handle:active { cursor: grabbing; }
        .calc-close { cursor: pointer; font-size: 1.2rem; line-height: 1; }
        .calc-close:hover { color: white; }
        .calc-display { color: white; font-size: 3.5rem; font-weight: 300; text-align: right; padding: 10px 20px 10px; overflow: hidden; white-space: nowrap; }
        .calc-button { display: flex; align-items: center; justify-content: center; height: 60px; width: 60px; border-radius: 50%; font-size: 1.5rem; font-weight: 500; cursor: pointer; user-select: none; transition: all 0.1s; margin: 5px; color: white; }
        .calc-button:active { transform: scale(0.95); }
        .calc-func { background-color: #9CA3AF; color: black; }
        .calc-op { background-color: #E3004F; }
        .calc-op-active { background-color: #ffffff !important; color: #E3004F !important; }
        .calc-num { background-color: #374151; }
        .calc-zero { width: 130px; border-radius: 35px; justify-content: start; padding-left: 25px; }

        /* Layout */
        #mainContainer {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 1400px; /* Breddare layout */
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #b9b9b9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999999; }
        
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }

        /* Partiklar */
        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            animation: fly 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes fly {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0) rotate(var(--rot)); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col transition-colors duration-300">

    <!-- STOR Inaktivitets-indikator (Fullsk√§rm) -->
    <div id="inactivityOverlay" class="fixed inset-0 bg-black bg-opacity-90 z-[100] hidden flex flex-col items-center justify-center text-center cursor-pointer backdrop-blur-sm transition-opacity duration-500">
        <div class="text-9xl mb-6 animate-bounce-slow">üò¥</div>
        <h2 class="text-5xl md:text-7xl font-bold text-white mb-6 drop-shadow-lg">Hall√• d√§r!</h2>
        <p class="text-2xl md:text-3xl text-praktiska-orange font-bold animate-pulse">Klicka var som helst f√∂r att forts√§tta r√§kna!</p>
        <p class="text-gray-400 mt-12 text-sm">Pausar du? Ingen fara, vi v√§ntar.</p>
    </div>

    <!-- Header -->
    <nav class="bg-white dark:bg-gray-800 shadow-md w-full z-10 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-24">
                <div class="flex-shrink-0 flex items-center gap-4">
                    <!-- Praktiska Logotyp -->
                    <img src="https://praktiska.se/wp-content/uploads/2025/11/praktiskalogorgb.svg" alt="Praktiska Gymnasiet" class="h-12 w-auto">
                </div>
                <div class="flex items-center gap-4">
                     <!-- Dark Mode Toggle -->
                     <button id="toggleDarkModeBtn" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 font-medium p-3 rounded-full transition" title="Byt f√§rgtema">
                        <!-- Moon Icon -->
                        <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                        <!-- Sun Icon -->
                        <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </button>

                     <!-- Kalkylatorknapp -->
                     <button id="toggleCalculatorBtn" class="bg-gray-100 dark:bg-gray-700 text-[#f66909] hover:bg-gray-200 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-full transition flex items-center gap-2 border border-transparent hover:border-[#f66909]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        <span class="hidden sm:inline">Kalkylator</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Kalkylatorn -->
    <div id="calculatorWrapper" class="calculator-wrapper" style="display: none;">
        <div class="calculator">
            <div id="calcHandle" class="calc-handle">
                <span>::: DRA H√ÑR</span>
                <span id="closeCalculator" class="calc-close">&times;</span>
            </div>
            <div id="calcDisplay" class="calc-display">0</div>
            <div id="calcButtons" class="grid grid-cols-4 p-3 gap-1">
                <div class="calc-button calc-func" data-value="AC">AC</div>
                <div class="calc-button calc-func" data-value="¬±">¬±</div>
                <div class="calc-button calc-func" data-value="%">%</div>
                <div class="calc-button calc-op" data-value="√∑">√∑</div>
                <div class="calc-button calc-num" data-value="7">7</div>
                <div class="calc-button calc-num" data-value="8">8</div>
                <div class="calc-button calc-num" data-value="9">9</div>
                <div class="calc-button calc-op" data-value="√ó">√ó</div>
                <div class="calc-button calc-num" data-value="4">4</div>
                <div class="calc-button calc-num" data-value="5">5</div>
                <div class="calc-button calc-num" data-value="6">6</div>
                <div class="calc-button calc-op" data-value="-">-</div>
                <div class="calc-button calc-num" data-value="1">1</div>
                <div class="calc-button calc-num" data-value="2">2</div>
                <div class="calc-button calc-num" data-value="3">3</div>
                <div class="calc-button calc-op" data-value="+">+</div>
                <div class="calc-button calc-num calc-zero col-span-2" data-value="0">0</div>
                <div class="calc-button calc-num" data-value=".">.</div>
                <div class="calc-button calc-op" data-value="=">=</div>
            </div>
        </div>
    </div>

    <!-- Huvudinneh√•ll -->
    <div class="flex-grow flex justify-center p-4 pt-8">
        
        <!-- Applikationskort -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 w-full max-w-6xl overflow-hidden h-fit transition-colors duration-300">
            
            <!-- Toppdel -->
            <div class="bg-white dark:bg-gray-800 p-8 pb-4 border-b border-gray-100 dark:border-gray-700 flex flex-col md:flex-row items-center justify-between gap-4 transition-colors duration-300">
                <div>
                    <div class="flex items-center gap-4">
                        <h1 class="text-3xl md:text-5xl font-bold text-[#f66909] mb-2 font-praktiska-stencil">Matematiktr√§nare</h1>
                        <!-- Hj√§rnan -->
                        <img src="image_57d296.png" alt="Hj√§rna" class="h-12 w-auto animate-pulse-slow hidden md:block" onerror="this.style.display='none'">
                        <!-- Matte-ikon -->
                        <svg class="h-10 w-10 text-gray-300 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 text-left text-lg">Tr√§na p√• typiska uppgifter f√∂r Nationella proven</p>
                </div>
            </div>

            <div class="p-6 md:p-10">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <!-- V√ÑNSTERKOLUMN -->
                    <div class="lg:col-span-4 space-y-6">
                        
                        <!-- L√§gesv√§ljare -->
                        <div id="modeSelector" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 transition-colors duration-300">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wide mb-2">V√§lj L√§ge</label>
                            <div class="relative">
                                <select id="trainingMode" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange sm:text-sm rounded-lg bg-white dark:bg-gray-800 dark:text-white transition-colors">
                                    <option value="campaign">üöÄ Kapiteltr√§ning</option>
                                    <option value="free">üéØ Typuppgifter NP</option>
                                </select>
                            </div>
                            <p id="modeDescription" class="text-sm text-gray-500 dark:text-gray-400 mt-3 italic">
                                V√§lj ett kapitel och tr√§na strukturerat.
                            </p>
                        </div>

                        <!-- Filter -->
                        <div id="filtersContainer">
                            <div id="freeTrainingFilters" class="space-y-4 hidden">
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Niv√•</label>
                                    <select id="levelFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"><option value="Alla">Alla Niv√•er</option><option value="√Ök 9">√Ök 9</option><option value="Ma 1">Ma 1</option><option value="Ma 2">Ma 2</option></select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">√Ñmne</label>
                                    <select id="topicFilter" disabled class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 dark:text-gray-400"><option value="Alla">Alla √Ñmnen</option></select>
                                </div>
                            </div>

                            <div id="campaignFilters" class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Kampanj</label>
                                    <select id="campaignNameFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white" onchange="loadAllProblems()">
                                        <option value="Procent">Procent</option>
                                        <option value="Sannolikhet">Sannolikhet</option>
                                        <option value="FunktionerSamband">Funktioner</option>
                                        <option value="Geometri">Geometri</option>
                                        <option value="Algebra">Algebra</option>
                                        <option value="Taluppfattning">Taluppfattning</option>
                                        <option value="Statistik">Statistik</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">√Örskurs</label>
                                    <select id="campaignLevelFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white" onchange="applyFiltersAndRender()">
                                        <option value="√Ök 9">√Ök 9</option>
                                        <option value="Ma 1">Ma 1</option>
                                        <option value="Ma 2">Ma 2</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Kapitel Del</label>
                                    <select id="chapterPartFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white" onchange="applyFiltersAndRender()"></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Po√§ng & Progress -->
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm transition-colors">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-300">Dina framsteg</div>
                                <div class="flex gap-4 text-sm font-bold">
                                    <span class="text-green-600 dark:text-green-400">R√§tt: <span id="scoreDisplay">0</span></span>
                                    <span class="text-gray-400 dark:text-gray-300">Totalt: <span id="totalDisplay">0</span></span>
                                </div>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-600 rounded-full h-3 overflow-hidden">
                                <div id="progressBar" class="bg-green-600 h-3 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Streak-box (Gamification) -->
                        <div id="streakSection" class="hidden animate-fade-in transition-all duration-500">
                            <div id="streakContainer" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 flex items-center justify-center gap-3 transition-all duration-300">
                                <span class="text-yellow-600 dark:text-yellow-500 font-semibold">Streak:</span>
                                <span id="streakDisplay" class="text-2xl font-black text-praktiska-orange">0/7 üî•</span>
                                <span id="trophyDisplay" class="text-2xl"></span>
                            </div>
                        </div>

                    </div>

                    <!-- H√ñGERKOLUMN: Uppgiftsomr√•det -->
                    <div class="lg:col-span-8">
                        
                        <div id="statusMessage" class="text-center py-12 hidden">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-praktiska-orange mb-4"></div>
                            <p class="text-gray-500 dark:text-gray-400 text-lg">Laddar uppgifter...</p>
                        </div>

                        <div id="problemCard" class="hidden animate-fade-in h-full flex flex-col justify-between">
                            
                            <div>
                                <div class="mb-8 flex justify-center">
                                    <img id="problemImage" src="" alt="Uppgift" class="max-w-full max-h-64 rounded-lg shadow-sm" style="display: none;" onerror="this.style.display='none'; this.src='';">
                                </div>
                                
                                <div id="problemText" class="text-2xl md:text-3xl font-medium text-gray-800 dark:text-gray-100 text-center leading-relaxed mb-8 min-h-[100px] flex items-center justify-center"></div>
                                
                                <div id="answerContainer" class="mb-10 max-w-md mx-auto"></div>
                            </div>

                            <div class="mt-auto">
                                <div class="flex flex-col sm:flex-row gap-4 justify-center relative">
                                    <button id="checkAnswerBtn" class="w-full sm:w-2/3 bg-[#f66909] text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg hover:bg-opacity-90 transform hover:-translate-y-1 transition duration-200 relative overflow-hidden">
                                        R√§tta Svar
                                    </button>
                                    <button id="nextProblemBtn" class="w-full sm:w-2/3 bg-gray-800 dark:bg-gray-600 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg hover:bg-gray-900 dark:hover:bg-gray-500 transform hover:-translate-y-1 transition duration-200" style="display: none;">
                                        N√§sta Uppgift
                                    </button>
                                </div>

                                <div id="feedback" class="mt-8 text-center font-medium p-6 rounded-xl text-lg hidden border-2"></div>
                            
                                <div class="text-center mt-8">
                                    <button id="showSolutionBtn" class="text-gray-500 dark:text-gray-400 hover:text-[#f66909] dark:hover:text-[#f66909] font-semibold border-b-2 border-transparent hover:border-[#f66909] transition pb-1" style="display: none;">
                                        Visa hur man g√∂r
                                    </button>
                                </div>

                                <div id="solutionInline" class="mt-6 bg-blue-50 dark:bg-blue-900/20 rounded-xl p-8 border border-blue-100 dark:border-blue-800 hidden">
                                    <h3 class="text-xl font-bold text-blue-900 dark:text-blue-300 mb-4 flex items-center gap-2">
                                        üí° L√∂sning & F√∂rklaring
                                    </h3>
                                    <div id="solutionText" class="text-blue-800 dark:text-blue-200 prose prose-lg max-w-none"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                
                <div class="text-center text-xs text-gray-300 dark:text-gray-600 mt-12 pt-6 border-t border-gray-100 dark:border-gray-700">
                    Elev-ID: <span id="userIdDisplay" class="font-mono">...</span>
                </div>

            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script type="module">
        console.log("Laddar math_trainer.html (Fixes + Brain + Layout + Total)");
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD9wbtUB4MUFq1BF00upHxIS6DQK9aS0vQ",
            authDomain: "praktiska-np.firebaseapp.com",
            projectId: "praktiska-np",
            storageBucket: "praktiska-np.firebasestorage.app",
            messagingSenderId: "239785866823",
            appId: "1:239785866823:web:55ffb3a3485d32984ca362"
        };
        
        const appId = 'default-app-id'; 
        
        const COLLECTION_PATHS = {
            FREE_TRAINING: `artifacts/${appId}/public/data/math_tasks`,
            CAMPAIGN_ROOT: `artifacts/${appId}/public/data/campaigns`,
            USER_SCORE: `artifacts/${appId}/users/`
        };
        
        const CAMPAIGN_LEVELS = {
            "Procent": [
                { value: 1, label: "1. Grundl√§ggande procent" },
                { value: 2, label: "2. F√∂r√§ndring & f√∂r√§ndringsfaktor" },
                { value: 3, label: "3. Procentenheter & j√§mf√∂relser" },
                { value: 4, label: "4. Promille & ppm" },
                { value: 5, label: "5. R√§nta & r√§nta p√• r√§nta" },
                { value: 6, label: "6. Flera procentuella f√∂r√§ndringar i rad" },
                { value: 7, label: "7. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Sannolikhet": [
                { value: 1, label: "1. Grundl√§ggande begrepp: utfall, h√§ndelse, chans" },
                { value: 2, label: "2. Enkla sannolikheter" },
                { value: 3, label: "3. Flera utfall & kombinatorik" },
                { value: 4, label: "4. Medelv√§rde, median & typv√§rde" },
                { value: 5, label: "5. Frekvenstabeller & diagram" },
                { value: 6, label: "6. Sammansatta sannolikheter" },
                { value: 7, label: "7. Komplementh√§ndelser" },
                { value: 8, label: "8. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "FunktionerSamband": [
                { value: 1, label: "1. Proportionalitet & grundl√§ggande funktioner" },
                { value: 2, label: "2. Tolka grafer & samband" },
                { value: 3, label: "3. R√§t linje: lutning & m-v√§rde" },
                { value: 4, label: "4. S√§tta in och r√§kna med funktioner" },
                { value: 5, label: "5. Sk√§rningspunkter & j√§mf√∂relser mellan grafer" },
                { value: 6, label: "6. Funktioners f√∂r√§ndring (√∂kning/minskning)" },
                { value: 7, label: "7. f(x)-uppgifter av olika karakt√§r" },
                { value: 8, label: "8. Till√§mpningar & textuppgifter" },
                { value: 9, label: "9. GeoGebra & Nationella provet-niv√• (linj√§ra)" }
            ],
            "Geometri": [
                { value: 1, label: "1. Area och omkrets (kvadrat, rektangel, triangel)" },
                { value: 2, label: "2. Cirkelns area och omkrets" },
                { value: 3, label: "3. Volym & rymdgeometri" },
                { value: 4, label: "4. Enhetsomvandlingar (l√§ngd, area, volym)" },
                { value: 5, label: "5. Skala & likformighet" },
                { value: 6, label: "6. Vinklar & Pythagoras sats" },
                { value: 7, label: "7. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Algebra": [
                { value: 1, label: "1. Ekvationer med + och ‚àí" },
                { value: 2, label: "2. Multiplikation & division" },
                { value: 3, label: "3. x p√• b√•da sidor" },
                { value: 4, label: "4. Parenteser och f√∂renklingar" },
                { value: 5, label: "5. Br√•k och decimaler" },
                { value: 6, label: "6. L√∂sa ut variabler ur formler" },
                { value: 7, label: "7. Faktorisering av uttryck" },
                { value: 8, label: "8. Kombinerade ekvationer och probleml√∂sning" },
                { value: 9, label: "9. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Taluppfattning": [
                { value: 1, label: "1. Grundl√§ggande tal och positionssystem" },
                { value: 2, label: "2. Negativa tal och tallinjen" },
                { value: 3, label: "3. Br√•k och decimaler" },
                { value: 4, label: "4. Procent, promille och andelar" },
                { value: 5, label: "5. Potenser & kvadratr√∂tter" },
                { value: 6, label: "6. Prefix, avrundning och √∂verslagsr√§kning" },
                { value: 7, label: "7. Primtal, faktorisering och delbarhet" },
                { value: 8, label: "8. Reella tal & j√§mf√∂relser" },
                { value: 9, label: "9. Blandad niv√• ‚Äì Nationella provet-stil" }
            ],
            "Statistik": [
                { value: 1, label: "1. Stolp-, cirkel- & linjediagram" },
                { value: 2, label: "2. Boxplot & spridningsm√•tt" }
            ]
        };

        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = appId;
        
        let allProblems = []; 
        let currentProblem = null;
        let filteredProblems = [];
        let currentScore = 0;
        let currentTotal = 0;
        let seenProblemIndices = [];
        let currentMode = 'campaign'; 

        let campaignStreak = 0; 
        let chaptersCleared = {}; 
        const STREAK_TO_PASS = 7; 

        let isCheckingAnswer = false; 
        let inactivityTimer;

        // DOM Elements
        const problemCard = document.getElementById('problemCard');
        const problemText = document.getElementById('problemText');
        const answerContainer = document.getElementById('answerContainer');
        const checkAnswerBtn = document.getElementById('checkAnswerBtn');
        const statusMessage = document.getElementById('statusMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const totalDisplay = document.getElementById('totalDisplay');
        const progressBar = document.getElementById('progressBar');

        const streakSection = document.getElementById('streakSection');
        const streakContainer = document.getElementById('streakContainer');
        const streakDisplay = document.getElementById('streakDisplay'); 
        const trophyDisplay = document.getElementById('trophyDisplay'); 
        
        const trainingMode = document.getElementById('trainingMode'); 
        const freeTrainingFilters = document.getElementById('freeTrainingFilters');
        const campaignFilters = document.getElementById('campaignFilters');
        const modeDescription = document.getElementById('modeDescription');
        
        const levelFilter = document.getElementById('levelFilter');
        const topicFilter = document.getElementById('topicFilter');
        
        const campaignNameFilter = document.getElementById('campaignNameFilter');
        const campaignLevelFilter = document.getElementById('campaignLevelFilter');
        const chapterPartFilter = document.getElementById('chapterPartFilter');
        
        const solutionInline = document.getElementById('solutionInline');
        const solutionText = document.getElementById('solutionText');
        const showSolutionBtn = document.getElementById('showSolutionBtn');
        
        const toggleCalculatorBtn = document.getElementById('toggleCalculatorBtn'); 
        const calculatorWrapper = document.getElementById('calculatorWrapper'); 
        
        const calcDisplay = document.getElementById('calcDisplay'); 
        const calcHandle = document.getElementById('calcHandle');
        const closeCalculator = document.getElementById('closeCalculator');

        // Dark Mode Toggle
        const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');
        toggleDarkModeBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });

        
        function getTopicIcon(topic) {
            switch (topic) {
                case "Algebra": return "üßÆ";
                case "Procent": return "üìà";
                case "Geometri": return "üìê";
                case "Tal": return "üî¢";
                case "Samband": return "üìä";
                case "Sannolikhet": return "üé≤";
                case "Statistik": return "üìâ";
                case "FunktionerSamband": return "üìà";
                case "Taluppfattning": return "üî¢";
                default: return "üìö";
            }
        }
        
        function formatMathText(text) {
            if (!text) return "";
            if (text.includes("\\frac")) return text;
            return text.replace(/([a-zA-Z0-9]+)\s*\/\s*([a-zA-Z0-9]+)/g, (match, t√§ljare, n√§mnare) => {
                return `$\\frac{${t√§ljare}}{${n√§mnare}}$`;
            });
        }

        function switchMode() {
            currentMode = trainingMode.value;
            resetScore();
            seenProblemIndices = [];
            problemCard.style.display = 'none';
            statusMessage.style.display = 'none';
            
            if (currentMode === 'free') {
                freeTrainingFilters.classList.remove('hidden');
                campaignFilters.classList.add('hidden');
                modeDescription.textContent = "I detta l√§ge tr√§nar du p√• klassiska typuppgifter som ofta kommer p√• nationella proven";
            } else {
                freeTrainingFilters.classList.add('hidden');
                campaignFilters.classList.remove('hidden');
                modeDescription.textContent = "Tr√§na strukturerat kapitel f√∂r kapitel. Klara 7 uppgifter i rad f√∂r att f√• en pokal! üèÜ";
            }
            loadAllProblems();
        }

        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                
                window.getDoc = getDoc;
                window.doc = doc;
                window.setDoc = setDoc;
                window.collection = collection;
                window.getDocs = getDocs;
                window.query = query;
                window.where = where;

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        userIdDisplay.textContent = user.uid;
                        populateChapterPartsFilter(); 
                        loadScore(); 
                        loadAllProblems();
                    } else {
                        signInAnonymously(window.auth).catch((error) => {
                            console.error("Anonym inloggning misslyckades:", error);
                            statusMessage.textContent = "Kunde inte ansluta till servern (Auth).";
                            statusMessage.style.display = "block";
                        });
                    }
                });

            } catch (error) {
                console.error("Firebase Initiering Misslyckades:", error);
                statusMessage.textContent = `Fel vid initiering: ${error.message}`;
                statusMessage.style.display = "block";
            }
        }
        
        function populateChapterPartsFilter() {
            const selectedCampaign = campaignNameFilter.value; 
            const parts = CAMPAIGN_LEVELS[selectedCampaign] || []; 
             
            chapterPartFilter.innerHTML = '';
             parts.forEach(part => {
                const option = document.createElement('option');
                option.value = part.value; 
                option.textContent = part.label;
                chapterPartFilter.appendChild(option);
            });
            applyFiltersAndRender();
        }


        async function loadAllProblems() {
            if (!window.db) return;
            
            let targetPath;
            if (currentMode === 'free') {
                targetPath = COLLECTION_PATHS.FREE_TRAINING;
            } else {
                const campaign = campaignNameFilter.value; 
                targetPath = `${COLLECTION_PATHS.CAMPAIGN_ROOT}/${campaign}/tasks`; 
            }
            
            statusMessage.textContent = `Laddar uppgifter...`;
            statusMessage.style.display = "block";
            
            try {
                const problemsCollection = collection(window.db, targetPath);
                const querySnapshot = await getDocs(problemsCollection);
                
                allProblems = [];
                querySnapshot.forEach((doc) => {
                    allProblems.push({ id: doc.id, ...doc.data() });
                });
                
                if (allProblems.length === 0) {
                    statusMessage.textContent = `Hittade inga uppgifter i mappen '${targetPath.split('/').pop()}'. Kontrollera adminverktyget.`;
                    statusMessage.style.display = "block";
                } else {
                    statusMessage.style.display = "none";
                    problemCard.style.display = "flex";
                    problemCard.classList.remove('hidden'); 
                    problemCard.classList.add('flex', 'flex-col', 'justify-between'); 

                    if(currentMode === 'free') populateFilters();
                    
                    if (currentMode === 'campaign') {
                         populateChapterPartsFilter(); 
                    } else {
                        applyFiltersAndRender();
                    }
                }

            } catch (error) {
                console.error("Fel vid laddning av uppgifter: ", error);
                statusMessage.textContent = `Fel vid laddning. Kontrollera samlingen '${targetPath.split('/').pop()}' existerar. F√∂rv√§ntad s√∂kv√§g: ${targetPath}`;
                statusMessage.style.display = "block";
                problemCard.style.display = "none";
            }
        }
        
        function populateFilters() {
            const problemsToFilter = allProblems.filter(p => !p.campaignName); 

            const selectedLevel = levelFilter.value;
            let problemsByLevel = (selectedLevel === 'Alla') ? problemsToFilter : problemsToFilter.filter(p => p.level === selectedLevel);
            
            const topics = [...new Set(problemsByLevel.map(p => p.topic || 'Ok√§nt'))];
            topics.sort();
            
            topicFilter.innerHTML = '<option value="Alla">Alla √Ñmnen</option>';
            
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = `${getTopicIcon(topic)} ${topic}`;
                topicFilter.appendChild(option);
            });
            
            topicFilter.disabled = false;
            topicFilter.classList.remove('bg-gray-100', 'cursor-not-allowed');
        }


        function applyFiltersAndRender() {
            let tempFiltered = allProblems;

            if (currentMode === 'free') {
                const selectedLevel = levelFilter.value;
                const selectedTopic = topicFilter.value;
                
                if (selectedLevel !== 'Alla') {
                    tempFiltered = tempFiltered.filter(p => p.level === selectedLevel);
                }
                if (selectedTopic !== 'Alla') {
                    tempFiltered = tempFiltered.filter(p => p.topic === selectedTopic);
                }
            } else {
                const selectedCampaignLevel = campaignLevelFilter.value; 
                const selectedChapterPart = parseInt(chapterPartFilter.value); 
                
                tempFiltered = tempFiltered.filter(p => 
                    p.campaignLevel === selectedCampaignLevel && 
                    p.chapterLevel === selectedChapterPart
                );
            }
            
            filteredProblems = tempFiltered;
            
            if (filteredProblems.length === 0) {
                statusMessage.textContent = "Inga uppgifter matchade ditt val.";
                statusMessage.style.display = "block";
                problemCard.style.display = "none";
                return;
            }
            
            statusMessage.style.display = "none";
            problemCard.style.display = "flex"; 
            
            if (seenProblemIndices.length >= filteredProblems.length) {
                seenProblemIndices = [];
            }

            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * filteredProblems.length);
            } while (seenProblemIndices.includes(newIndex));

            seenProblemIndices.push(newIndex);
            let currentProblemIndexLocal = newIndex;
            currentProblem = filteredProblems[currentProblemIndexLocal];
            
            if (!currentProblem.question_sv || currentProblem.question_sv.trim() === '') {
                 problemText.textContent = "(Uppgiftstext saknas i databasen!)";
            }

            renderProblem(currentProblem);
        }

        function renderProblem(problem) {
            if (!problem) return;

            let question = problem.question_sv || '';
            question = formatMathText(question);

            if (question.trim() === '') {
                problemText.textContent = "(Uppgiftstext saknas i databasen!)";
            } else {
                problemText.innerHTML = question;
            }

            feedback.style.display = "none";
            checkAnswerBtn.disabled = false;
            checkAnswerBtn.style.display = "block";
            nextProblemBtn.style.display = "none";
            showSolutionBtn.style.display = "none";
            solutionInline.style.display = "none"; 
            answerContainer.innerHTML = ''; 

            const problemImage = document.getElementById('problemImage');
            if (problem.imageUrl) {
                problemImage.src = problem.imageUrl;
                problemImage.style.display = "block";
            } else {
                problemImage.style.display = "none";
            }

            const type = problem.answerType || 'text';
            if (type === 'number') {
                answerContainer.innerHTML = `
                    <label for="answerInput" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar (endast siffror):</label>
                    <input type="number" id="answerInput" class="w-full p-3.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange focus:outline-none text-lg placeholder-gray-400 dark:bg-gray-700 dark:text-white" placeholder="Skriv ditt svar...">
                `;
            } else if (type === 'text') {
                answerContainer.innerHTML = `
                    <label for="answerInput" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar:</label>
                    <input type="text" id="answerInput" class="w-full p-3.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange focus:outline-none text-lg placeholder-gray-400 dark:bg-gray-700 dark:text-white" placeholder="Skriv ditt svar...">
                `;
            }

            if (window.MathJax) {
                MathJax.typesetPromise([problemText]);
            }
        }
        
        function checkAnswer() {
            if (isCheckingAnswer) {
                return; 
            }
            isCheckingAnswer = true;
            checkAnswerBtn.disabled = true; 

            const answerInput = document.getElementById('answerInput');
            if (!answerInput) {
                isCheckingAnswer = false;
                return;
            }

            const userAnswer = answerInput.value.trim();
            const correctAnswer = String(currentProblem.correctAnswer).trim();
            
            let isCorrect = false;

            function stripUnits(str) {
                let cleaned = str.replace(/,/g, '.');
                cleaned = cleaned.replace(/[^0-9.\-]/g, ''); 
                return cleaned;
            }

            const userClean = stripUnits(userAnswer);
            const correctClean = stripUnits(correctAnswer);
            
            const userNum = parseFloat(userClean);
            const correctNum = parseFloat(correctClean);

            if (!isNaN(userNum) && !isNaN(correctNum)) {
                if (Math.abs(userNum - correctNum) < 0.000001) {
                    isCorrect = true;
                }
            }

            if (!isCorrect) {
                if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
                    isCorrect = true;
                }
            }
            
            // FIX: Increment total here
            currentTotal++; 

            if (isCorrect) {
                feedback.textContent = "R√§tt svar!";
                feedback.className = "mt-6 text-center font-semibold p-4 rounded-xl bg-green-100 text-green-800 border border-green-200 dark:bg-green-900 dark:text-green-100 dark:border-green-700";
                currentScore++; 
                campaignStreak++; 
                triggerConfetti(checkAnswerBtn); 
            } else {
                feedback.textContent = `Inte riktigt! R√§tt svar var: ${correctAnswer}.`;
                feedback.className = "mt-6 text-center font-semibold p-4 rounded-xl bg-red-100 text-red-800 border border-red-200 dark:bg-red-900 dark:text-red-100 dark:border-red-700";
                campaignStreak = 0; 
            }
            
            if (currentMode === 'campaign' && isCorrect && campaignStreak >= STREAK_TO_PASS) {
                markChapterCleared();
            }

            updateScoreDisplay();
            updateStreakDisplay(); 
            saveScore(); 
            
            isCheckingAnswer = false; 

            feedback.style.display = "block";
            checkAnswerBtn.style.display = "none";
            nextProblemBtn.style.display = "block";
            showSolutionBtn.style.display = "inline"; 
        }

        function markChapterCleared() {
            const campaign = campaignNameFilter.value;
            const chapter = parseInt(chapterPartFilter.value);
            
            if (!chaptersCleared[campaign]) {
                chaptersCleared[campaign] = {};
            }
            chaptersCleared[campaign][chapter] = true;
            campaignStreak = 0; 
            saveScore();
            updateStreakDisplay();
            
            alert(`GRATTIS! Du har klarat ${campaign} - Del ${CAMPAIGN_LEVELS[campaign].find(p => p.value === chapter).label}!`);
        }


        function showSolution() {
            if (!currentProblem || !currentProblem.explanation_sv) {
                solutionText.textContent = "Det finns tyv√§rr ingen f√∂rklaring till den h√§r uppgiften.";
            } else {
                solutionText.innerHTML = formatMathText(currentProblem.explanation_sv);
            }
            
            solutionInline.style.display = "block"; 
            showSolutionBtn.style.display = "none"; 
            
            if (window.MathJax) {
                MathJax.typesetPromise([solutionText]);
            }
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = currentScore;
            totalDisplay.textContent = currentTotal;
            updateProgressBar();
        }

        function updateProgressBar() {
            let percent;
             if (currentMode === 'campaign') {
                percent = (campaignStreak / STREAK_TO_PASS) * 100;
                if (percent > 100) percent = 100; 
            } else {
                percent = (currentTotal === 0) ? 0 : (currentScore / currentTotal) * 100;
            }
            progressBar.style.width = `${percent}%`;
        }

        function updateStreakDisplay() {
            // Fire effect logic
            streakContainer.className = "bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 flex items-center justify-center gap-3 transition-all duration-300";
            
            if (campaignStreak >= 3) streakContainer.classList.add('fire-low');
            if (campaignStreak >= 5) { streakContainer.classList.remove('fire-low'); streakContainer.classList.add('fire-med'); }
            if (campaignStreak >= 6) { streakContainer.classList.remove('fire-med'); streakContainer.classList.add('fire-high'); }
            
            if (currentMode === 'campaign') {
                streakSection.classList.remove('hidden');
                streakDisplay.textContent = `${campaignStreak}/${STREAK_TO_PASS} üî•`;
                
                const campaign = campaignNameFilter.value;
                const chapter = parseInt(chapterPartFilter.value);

                const isCleared = chaptersCleared[campaign] && chaptersCleared[campaign][chapter];

                if (isCleared) {
                    trophyDisplay.innerHTML = 'üèÜ';
                    streakDisplay.classList.remove('text-praktiska-red');
                    streakDisplay.classList.add('text-green-600');
                } else {
                    trophyDisplay.innerHTML = '';
                    streakDisplay.classList.add('text-praktiska-red');
                    streakDisplay.classList.remove('text-green-600');
                }
                
            } else {
                streakSection.classList.add('hidden');
            }
        }
        
        async function loadScore() {
            if (!window.userId || !window.db) return;
            const scoreDocPath = `${COLLECTION_PATHS.USER_SCORE}${window.userId}/progress/score_data`;
            try {
                const docRef = doc(window.db, scoreDocPath);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentScore = data.score || 0;
                    currentTotal = data.total || 0;
                    campaignStreak = data.streak || 0; 
                    chaptersCleared = data.cleared || {}; 
                }
            } catch (error) { console.error("Fel vid laddning av po√§ng:", error); }
            updateScoreDisplay();
            updateStreakDisplay(); 
        }
        
        async function saveScore() {
            if (!window.userId || !window.db) return;
            const scoreDocPath = `${COLLECTION_PATHS.USER_SCORE}${window.userId}/progress/score_data`;
            try {
                const docRef = doc(window.db, scoreDocPath);
                await setDoc(docRef, { 
                    score: currentScore, 
                    total: currentTotal,
                    streak: campaignStreak, 
                    cleared: chaptersCleared 
                }, { merge: true });
            } catch (error) { console.error("Fel vid sparning av po√§ng:", error); }
        }

        function resetScore(fullReset = true) {
            if (fullReset) {
                currentScore = 0;
                currentTotal = 0;
                updateScoreDisplay();
                saveScore(); 
            }
            seenProblemIndices = []; 
            campaignStreak = 0; 
            updateStreakDisplay();
        }

        // --- INAKTIVITETS LOGIK (FIXED) ---
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            
            // Use variables to access elements safely inside the function
            const msg = document.getElementById('inactivityMessage');
            const overlay = document.getElementById('inactivityOverlay');
            
            if (msg) msg.classList.add('hidden');
            if (overlay) overlay.classList.add('hidden');
            
            inactivityTimer = setTimeout(() => {
                if (msg) msg.classList.remove('hidden');
                if (overlay) overlay.classList.remove('hidden');
            }, 30000); 
        }
        
        window.addEventListener('mousemove', resetInactivityTimer);
        window.addEventListener('keydown', resetInactivityTimer);
        window.addEventListener('click', resetInactivityTimer);
        resetInactivityTimer(); 

        // --- KONFETTI LOGIK (ENORM EXPLOSION) ---
        function triggerConfetti(element) {
            const colors = ['#E3004F', '#f66909', '#FCD34D', '#10B981', '#3B82F6'];
            const rect = element.getBoundingClientRect();
            const center = { x: rect.left + rect.width / 2, y: rect.top + rect.height / 2 };

            for (let i = 0; i < 100; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                particle.style.width = Math.random() * 12 + 6 + 'px';
                particle.style.height = particle.style.width;
                
                particle.style.left = center.x + 'px';
                particle.style.top = center.y + 'px';
                particle.style.borderRadius = '50%'; 
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 400 + 100; 
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                
                particle.style.setProperty('--rot', `${Math.random() * 720 - 360}deg`);
                
                document.body.appendChild(particle);
                
                setTimeout(() => { particle.remove(); }, 1500);
            }
        }


        // --- EVENT LISTENERS ---
        
        trainingMode.addEventListener('change', switchMode);
        
        campaignNameFilter.addEventListener('change', () => { resetScore(true); loadAllProblems(); });
        campaignLevelFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
        chapterPartFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });

        levelFilter.addEventListener('change', () => { resetScore(true); populateFilters(); applyFiltersAndRender(); });
        topicFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });

        checkAnswerBtn.addEventListener('click', checkAnswer);
        nextProblemBtn.addEventListener('click', applyFiltersAndRender);
        showSolutionBtn.addEventListener('click', showSolution);
        
        toggleCalculatorBtn.addEventListener('click', () => {
            const isVisible = calculatorWrapper.style.display !== 'none';
            calculatorWrapper.style.display = isVisible ? 'none' : 'block';
            toggleCalculatorBtn.textContent = isVisible ? 'D√∂lj Kalkylator' : 'Visa Kalkylator';
        });
        
        // ST√ÑNG-KNAPP F√ñR KALYKULATOR
        document.getElementById('closeCalculator').addEventListener('click', () => {
             calculatorWrapper.style.display = 'none';
             toggleCalculatorBtn.textContent = 'Visa Kalkylator';
        });
        
        // Kalkylator-drag-logik
        let isDragging = false;
        let currentX, currentY, initialX, initialY;
        let xOffset = 0, yOffset = 0;
        // calcHandle √§r redan definierad ovan

        calcHandle.addEventListener("mousedown", dragStart);
        calcHandle.addEventListener("touchstart", dragStart, {passive: false});
        document.addEventListener("mouseup", dragEnd);
        document.addEventListener("touchend", dragEnd);
        document.addEventListener("mousemove", drag);
        document.addEventListener("touchmove", drag, {passive: false});

        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if (e.target === calcHandle || calcHandle.contains(e.target)) {
                isDragging = true;
            }
        }
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, calculatorWrapper);
            }
        }
        function setTranslate(xPos, yPos, el) {
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
        }

        // Kalkylator-logik
        const calcButtons = document.getElementById('calcButtons');
        // calcDisplay redan definierad ovan
        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        let awaitingSecondOperand = false;
        
        function clearOperatorHighlight() {
            document.querySelectorAll('.calc-op').forEach(btn => {
                btn.classList.remove('calc-op-active');
            });
        }

        calcButtons.addEventListener('click', (event) => {
            if (!event.target.classList.contains('calc-button')) return;

            const value = event.target.dataset.value;
            
            if (event.target.classList.contains('calc-num') || value === '.') {
                clearOperatorHighlight(); 
                if (awaitingSecondOperand) {
                    currentInput = value === '.' ? '0.' : value;
                    awaitingSecondOperand = false;
                } else if (currentInput === '0' && value !== '.') {
                    currentInput = value;
                } else if (value === '.' && currentInput.includes('.')) { } else {
                    currentInput += value;
                }
            } else if (event.target.classList.contains('calc-op')) {
                if (value === '=') {
                    if (operator && firstOperand !== null) {
                        currentInput = calculate(firstOperand, operator, parseFloat(currentInput));
                        operator = null;
                        firstOperand = null;
                        awaitingSecondOperand = true;
                    }
                    clearOperatorHighlight();
                } else {
                    clearOperatorHighlight();
                    event.target.classList.add('calc-op-active');
                    if (firstOperand === null) {
                        firstOperand = parseFloat(currentInput);
                    } else if (operator) {
                        const result = calculate(firstOperand, operator, parseFloat(currentInput));
                        firstOperand = result;
                        currentInput = result;
                    }
                    operator = value;
                    awaitingSecondOperand = true;
                }
            } else if (event.target.classList.contains('calc-func')) {
                clearOperatorHighlight();
                if (value === 'AC') {
                    currentInput = '0';
                    operator = null;
                    firstOperand = null;
                    awaitingSecondOperand = false;
                } else if (value === '¬±') {
                    currentInput = String(parseFloat(currentInput) * -1);
                } else if (value === '%') {
                    currentInput = String(parseFloat(currentInput) / 100);
                }
            }
            calcDisplay.textContent = currentInput.substring(0, 10);
        });

        function calculate(num1, op, num2) {
            switch (op) {
                case '+': return String(num1 + num2);
                case '-': return String(num1 - num2);
                case '√ó': return String(num1 * num2);
                case '√∑': return String(num1 / num2);
                default: return num2;
            }
        }
        
        // --- EXPOSING FUNCTIONS GLOBALLY (Fixat) ---
        window.switchMode = switchMode;
        window.loadAllProblems = loadAllProblems;
        window.applyFiltersAndRender = applyFiltersAndRender;
        window.checkAnswer = checkAnswer;
        window.showSolution = showSolution;
        
        // --- STARTA APPEN ---
        initializeFirebase();
        
    </script>
</body>
</html>
