<!DOCTYPE html>
<html lang="sv" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MatematiktrÃ¤nare - Praktiska Gymnasiet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?v=3" async></script>
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        praktiska: {
                            red: '#E3004F',
                            dark: '#1F2937',
                            light: '#F9FAFB',
                            hover: '#C10042',
                            gray: '#b9b9b9',
                            orange: '#f66909'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- Importera typsnitt -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: {
        fontCache: 'global'
      },
      startup: {
        typeset: false
      }
    };
    </script>

    <style>
        /* --- TYPOGRAFI OCH LAYOUT --- */
        
        /* Vanlig text */
        .problem-text-block {
            font-family: 'Merriweather', serif;
            font-size: 1.2rem;
            line-height: 1.6;
            color: #1f2937; 
            margin-bottom: 0.5rem;
            text-align: left;
            display: block;
        }
        .dark .problem-text-block {
            color: #e5e7eb;
        }

        /* Matte-block (Centrerad, stor) */
        .problem-math-block {
            margin: 0.5rem 0 1rem 0;
            text-align: center;
            font-size: 1.5rem;
            overflow-x: auto;
            font-family: 'Inter', sans-serif;
            width: 100%;
            display: block;
        }

        /* Svarsalternativ i Scaffolding - Flex fÃ¶r att hantera matte snyggt */
        .choice-btn-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-wrap: wrap;
            width: 100%;
            font-family: 'Merriweather', serif;
        }
        /* Justera MathJax-marginaler inuti knappar */
        .choice-btn-content mjx-container {
            margin: 0 0.3rem !important;
        }

        /* MathJax justeringar */
        mjx-container[jax="CHTML"][display="true"] {
            display: block !important;
            text-align: center;
            margin: 0 !important;
            padding: 0.1em 0;
        }
        mjx-container { 
            margin: 0 2px !important; 
        }

        /* Kalkylator */
        .calculator-wrapper { position: fixed; top: 120px; right: 20px; z-index: 40; width: 300px; touch-action: none; }
        .calculator { width: 100%; background-color: #1f2937; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2); overflow: hidden; }
        .calc-handle { background-color: #111827; color: #9CA3AF; padding: 8px 15px; cursor: grab; display: flex; justify-content: space-between; align-items: center; user-select: none; font-size: 0.8rem; letter-spacing: 1px; }
        .calc-handle:active { cursor: grabbing; }
        .calc-close { cursor: pointer; font-size: 1.2rem; line-height: 1; }
        .calc-close:hover { color: white; }
        .calc-display { color: white; font-size: 3.5rem; font-weight: 300; text-align: right; padding: 10px 20px 10px; overflow: hidden; white-space: nowrap; }
        .calc-button { display: flex; align-items: center; justify-content: center; height: 60px; width: 60px; border-radius: 50%; font-size: 1.5rem; font-weight: 500; cursor: pointer; user-select: none; transition: all 0.1s; margin: 5px; color: white; }
        .calc-button:active { transform: scale(0.95); }
        .calc-func { background-color: #9CA3AF; color: black; }
        .calc-op { background-color: #E3004F; }
        .calc-op-active { background-color: #ffffff !important; color: #E3004F !important; }
        .calc-num { background-color: #374151; }
        .calc-zero { width: 130px; border-radius: 35px; justify-content: start; padding-left: 25px; }

        /* Partiklar */
        .particle { position: absolute; pointer-events: none; z-index: 100; animation: fly 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes fly {
            0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0) rotate(var(--rot)); opacity: 0; }
        }
        .fire-low { animation: burn-low 2s infinite; background-color: #fff7ed !important; }
        .fire-med { animation: burn-med 1s infinite; background-color: #fff7ed !important; }
        .fire-high { animation: burn-high 0.5s infinite; background-color: #fff1f2 !important; border: 2px solid #E3004F !important; }
        .dark .fire-low { background-color: #371b1b !important; }
        .dark .fire-med { background-color: #371b1b !important; }
        .dark .fire-high { background-color: #371b1b !important; }
        @keyframes burn-low { 0% { box-shadow: 0 0 5px #f66909; } 50% { box-shadow: 0 0 15px #f66909; } 100% { box-shadow: 0 0 5px #f66909; } }
        @keyframes burn-med { 0% { box-shadow: 0 0 10px #f66909; transform: scale(1); } 50% { box-shadow: 0 0 25px #f66909; transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes burn-high { 0% { box-shadow: 0 0 20px #fcd34d; transform: rotate(0deg); } 50% { box-shadow: 0 0 40px #fcd34d; transform: rotate(1deg); } 100% { transform: rotate(0deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col transition-colors duration-300">

    <!-- Header -->
    <nav class="bg-white dark:bg-gray-800 shadow-md w-full z-10 transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-24">
                <div class="flex-shrink-0 flex items-center gap-4">
                    <img src="https://praktiska.se/wp-content/uploads/2025/11/praktiskalogorgb.svg" alt="Praktiska Gymnasiet" class="h-12 w-auto">
                </div>
                <div class="flex items-center gap-4">
                     <!-- Dark Mode Toggle -->
                     <button id="toggleDarkModeBtn" class="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 font-medium p-3 rounded-full transition" title="Byt fÃ¤rgtema">
                        <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 block dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    </button>

                     <!-- Kalkylatorknapp -->
                     <button id="toggleCalculatorBtn" class="bg-gray-100 dark:bg-gray-700 text-[#f66909] hover:bg-gray-200 dark:hover:bg-gray-600 font-medium py-2 px-4 rounded-full transition flex items-center gap-2 border border-transparent hover:border-[#f66909]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                        <span class="hidden sm:inline">Kalkylator</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <div id="calculatorWrapper" class="calculator-wrapper" style="display: none;">
        <div class="calculator">
            <div id="calcHandle" class="calc-handle"><span>::: DRA HÃ„R</span><span id="closeCalculator" class="calc-close">&times;</span></div>
            <div id="calcDisplay" class="calc-display">0</div>
            <div id="calcButtons" class="grid grid-cols-4 p-3 gap-1">
                <div class="calc-button calc-func" data-value="AC">AC</div><div class="calc-button calc-func" data-value="Â±">Â±</div><div class="calc-button calc-func" data-value="%">%</div><div class="calc-button calc-op" data-value="Ã·">Ã·</div>
                <div class="calc-button calc-num" data-value="7">7</div><div class="calc-button calc-num" data-value="8">8</div><div class="calc-button calc-num" data-value="9">9</div><div class="calc-button calc-op" data-value="Ã—">Ã—</div>
                <div class="calc-button calc-num" data-value="4">4</div><div class="calc-button calc-num" data-value="5">5</div><div class="calc-button calc-num" data-value="6">6</div><div class="calc-button calc-op" data-value="-">-</div>
                <div class="calc-button calc-num" data-value="1">1</div><div class="calc-button calc-num" data-value="2">2</div><div class="calc-button calc-num" data-value="3">3</div><div class="calc-button calc-op" data-value="+">+</div>
                <div class="calc-button calc-num calc-zero col-span-2" data-value="0">0</div><div class="calc-button calc-num" data-value=".">.</div><div class="calc-button calc-op" data-value="=">=</div>
            </div>
        </div>
    </div>

    <!-- HuvudinnehÃ¥ll -->
    <div class="flex-grow flex justify-center p-4 pt-8">
        
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 w-full max-w-6xl overflow-hidden h-fit transition-colors duration-300 relative">
            
            <!-- ID DISPLAY -->
            <div id="problemIdDisplay" class="absolute top-2 right-2 text-xs text-gray-300 dark:text-gray-600 select-all cursor-pointer" title="Kopiera ID"></div>

            <div class="bg-white dark:bg-gray-800 p-4 pb-2 border-b border-gray-100 dark:border-gray-700 flex flex-col md:flex-row items-center justify-between gap-4 transition-colors duration-300">
                <div>
                    <div class="flex items-center gap-4">
                        <h1 class="text-3xl md:text-5xl font-bold text-[#f66909] mb-1 font-praktiska-stencil">MatematiktrÃ¤nare</h1>
                        <img src="https://praktiska.se/wp-content/uploads/2025/11/praktiskalogorgb.svg" alt="Praktiska Gymnasiet">
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 text-left text-lg">TrÃ¤na pÃ¥ typiska uppgifter fÃ¶r Nationella proven</p>
                </div>
            </div>

            <div class="p-6 md:p-10">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <!-- VÃ„NSTERKOLLUMN -->
                    <div class="lg:col-span-4 space-y-6">
                        <div id="modeSelector" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 transition-colors duration-300">
                            <label class="block text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-wide mb-2">VÃ¤lj LÃ¤ge</label>
                            <div class="relative">
                                <select id="trainingMode" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange sm:text-sm rounded-lg bg-white dark:bg-gray-800 dark:text-white transition-colors">
                                    <option value="campaign">ðŸš€ KapiteltrÃ¤ning</option>
                                    <option value="free">ðŸŽ¯ Typuppgifter NP</option>
                                </select>
                            </div>
                            <p id="modeDescription" class="text-sm text-gray-500 dark:text-gray-400 mt-3 italic">VÃ¤lj ett kapitel och trÃ¤na strukturerat.</p>
                        </div>

                        <!-- Filter -->
                        <div id="filtersContainer">
                            <div id="freeTrainingFilters" class="space-y-4 hidden">
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">NivÃ¥</label>
                                    <select id="levelFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"><option value="Alla">Alla NivÃ¥er</option><option value="Ã…k 9">Ã…k 9</option><option value="Ma 1">Ma 1</option><option value="Ma 2">Ma 2</option></select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Ã„mne</label>
                                    <select id="topicFilter" disabled class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-600 dark:text-gray-400"><option value="Alla">Alla Ã„mnen</option></select>
                                </div>
                            </div>
                            <div id="campaignFilters" class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Kampanj</label>
                                    <select id="campaignNameFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                                        <option value="Procent">Procent</option><option value="Sannolikhet">Sannolikhet</option><option value="FunktionerSamband">Funktioner</option><option value="Geometri">Geometri</option><option value="Algebra">Algebra</option><option value="Taluppfattning">Taluppfattning</option><option value="Statistik">Statistik</option>
                                    </select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Ã…rskurs</label>
                                    <select id="campaignLevelFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"><option value="Ã…k 9">Ã…k 9</option><option value="Ma 1">Ma 1</option><option value="Ma 2">Ma 2</option></select>
                                </div>
                                <div><label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1">Kapitel Del</label>
                                    <select id="chapterPartFilter" class="w-full p-2.5 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"></select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm transition-colors">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-300">Dina framsteg</div>
                                <div class="flex gap-4 text-sm font-bold">
                                    <span class="text-green-600 dark:text-green-400">RÃ¤tt: <span id="scoreDisplay">0</span></span>
                                    <span class="text-gray-400 dark:text-gray-300">Totalt: <span id="totalDisplay">0</span></span>
                                </div>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-600 rounded-full h-3 overflow-hidden"><div id="progressBar" class="bg-green-600 h-3 rounded-full" style="width: 0%"></div></div>
                        </div>

                        <div class="bg-white dark:bg-gray-700 p-4 rounded-xl border border-gray-200 dark:border-gray-600 shadow-sm mt-6">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-300 flex items-center gap-2"><span>Dagens MÃ¥l</span><span class="text-xs text-gray-400">(10 st)</span></div>
                                <div class="flex gap-2 text-sm font-bold"><span id="dailyCountDisplay" class="text-praktiska-orange">0/10</span></div>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-600 rounded-full h-3 overflow-hidden"><div id="dailyProgressBar" class="bg-praktiska-orange h-3 rounded-full" style="width: 0%"></div></div>
                        </div>

                        <div id="streakSection" class="hidden animate-fade-in transition-all duration-500 mt-6">
                            <div id="streakContainer" class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 flex flex-col items-center justify-center gap-1 transition-all duration-300">
                                <div class="flex items-center gap-3">
                                    <span class="text-yellow-600 dark:text-yellow-500 font-semibold">Kapitel Streak:</span>
                                    <span id="streakDisplay" class="2xl font-black text-praktiska-orange">0/7 ðŸ”¥</span>
                                    <span id="trophyDisplay" class="2xl"></span>
                                </div>
                                <div id="dailyStreakDisplay" class="text-xs text-gray-500 dark:text-gray-400 font-medium mt-1">Dagar i rad: 0 ðŸ“…</div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-8">
                        <div id="statusMessage" class="text-center py-12 hidden">
                            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-gray-200 border-t-praktiska-orange mb-4"></div>
                            <p class="text-gray-500 dark:text-gray-400 text-lg">Laddar uppgifter...</p>
                        </div>

                        <div id="problemCard" class="hidden animate-fade-in h-full flex flex-col justify-between">
                            <div>
                                <div class="mb-8 flex justify-center">
                                    <img id="problemImage" src="" alt="Uppgift" class="max-w-full max-h-96 rounded-lg shadow-sm" style="display: none;" onerror="this.style.display='none'; this.src='';">
                                    <canvas id="problemCanvas" class="max-w-full h-auto mx-auto rounded-lg shadow-sm" width="800" height="500" style="display: none;"></canvas>
                                </div>
                                
                                <!-- PROBLEM TEXT CONTAINER - New Renderer -->
                                <div id="problemText" class="mb-8 min-h-[50px] flex flex-col items-center justify-center problem-content-centered"></div>
                                
                                <!-- SCAFFOLDING CONTAINER -->
                                <div id="scaffoldingContainer" class="hidden mb-6 bg-blue-50 dark:bg-gray-700 p-6 rounded-xl border border-blue-200 dark:border-gray-600">
                                    <h3 class="text-lg font-bold text-blue-800 dark:text-blue-300 mb-4 font-sans">ðŸ§© LedtrÃ¥dstrappan</h3>
                                    <div id="scaffoldingContent" class="text-gray-800 dark:text-gray-200 text-lg mb-4 problem-content-flow"></div>
                                    <div id="scaffoldingActions" class="flex gap-2 justify-center"></div>
                                </div>

                                <div id="answerContainer" class="mb-10 max-w-md mx-auto"></div>
                            </div>

                            <div class="mt-auto">
                                <div class="flex flex-col sm:flex-row gap-4 justify-center relative">
                                    <button id="helpBtn" class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 font-semibold py-3 px-6 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition" style="display: none;">ðŸ§© FÃ¥ hjÃ¤lp</button>
                                    <button id="checkAnswerBtn" class="bg-praktiska-orange text-white font-bold py-3 px-8 rounded-lg hover:bg-orange-600 transition shadow-md">RÃ¤tta Svar</button>
                                    <button id="nextProblemBtn" class="bg-gray-800 dark:bg-gray-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-700 dark:hover:bg-gray-500 transition" style="display: none;">NÃ¤sta Uppgift â†’</button>
                                </div>

                                <div id="feedback" class="mt-6 text-center font-medium p-4 rounded-xl" style="display: none;"></div>

                                <div class="mt-6">
                                    <button id="showSolutionBtn" class="text-sm text-gray-500 dark:text-gray-400 underline hover:text-gray-700 dark:hover:text-gray-200" style="display: none;">Visa lÃ¶sning</button>
                                    <div id="solutionInline" class="mt-4 p-6 bg-green-50 dark:bg-green-900/30 rounded-xl text-left text-gray-800 dark:text-gray-200 border border-green-200 dark:border-green-700" style="display:none;">
                                        <h4 class="font-bold text-lg mb-3 text-green-800 dark:text-green-300">ðŸ’¡ LÃ¶sning</h4>
                                        <div id="solutionText" class="problem-content-flow"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD9wbtUB4MUFq1BF00upHxIS6DQK9aS0vQ",
            authDomain: "praktiska-np.firebaseapp.com",
            projectId: "praktiska-np",
            storageBucket: "praktiska-np.firebasestorage.app",
            messagingSenderId: "239785866823",
            appId: "1:239785866823:web:55ffb3a3485d32984ca362"
        };
        
        const firebaseAppInstance = initializeApp(firebaseConfig);
        let db = getFirestore(firebaseAppInstance);
        let auth = getAuth(firebaseAppInstance);
        
        const appId = 'default-app-id'; 
        const COLLECTION_PATHS = { FREE_TRAINING: `artifacts/${appId}/public/data/math_tasks`, CAMPAIGN_ROOT: `artifacts/${appId}/public/data/campaigns`, USER_SCORE: `artifacts/${appId}/users/` };
        const CAMPAIGN_LEVELS = { "Procent": [{value:1,label:"1. Decimal/BrÃ¥k/Procentform"},{value:2,label:"2. BerÃ¤kna andelen"},{value:3,label:"3. BerÃ¤kna delen"},{value:4,label:"4. FÃ¶rÃ¤ndringsfaktorn"},{value:5,label:"5. Flera fÃ¶rÃ¤ndringar i rad"},{value:6,label:"6. BaklÃ¤ngesrÃ¤kning"},{value:7,label:"7. Blandad uppgifter"}], "Sannolikhet": [{value:1,label:"1. GrundlÃ¤ggande begrepp"},{value:2,label:"2. Enkla sannolikheter"},{value:3,label:"3. Flera utfall & kombinatorik"},{value:4,label:"4. MedelvÃ¤rde, median & typvÃ¤rde"},{value:5,label:"5. Frekvenstabeller & diagram"},{value:6,label:"6. Sammansatta sannolikheter"},{value:7,label:"7. KomplementhÃ¤ndelser"},{value:8,label:"8. Blandad nivÃ¥"}], "FunktionerSamband": [{value:1,label:"1. Proportionalitet"},{value:2,label:"2. Tolka grafer"},{value:3,label:"3. RÃ¤t linje"},{value:4,label:"4. SÃ¤tta in och rÃ¤kna"},{value:5,label:"5. SkÃ¤rningspunkter"},{value:6,label:"6. FÃ¶rÃ¤ndring"},{value:7,label:"7. f(x)-uppgifter"},{value:8,label:"8. TillÃ¤mpningar"},{value:9,label:"9. GeoGebra & NP-nivÃ¥"}], "Geometri": [{value:1,label:"1. Area och omkrets"},{value:2,label:"2. Cirkelns area"},{value:3,label:"3. Volym & rymd"},{value:4,label:"4. Enhetsomvandlingar"},{value:5,label:"5. Skala & likformighet"},{value:6,label:"6. Vinklar & Pythagoras"},{value:7,label:"7. Blandad nivÃ¥"}], "Algebra": [{value:1,label:"1. Ekvationer med + och -"},{value:2,label:"2. Multiplikation & division"},{value:3,label:"3. x pÃ¥ bÃ¥da sidor"},{value:4,label:"4. Parenteser"},{value:5,label:"5. BrÃ¥k och decimaler"},{value:6,label:"6. LÃ¶sa ut variabler"},{value:7,label:"7. Faktorisering"},{value:8,label:"8. Kombinerade ekvationer"},{value:9,label:"9. Blandad nivÃ¥"}], "Taluppfattning": [{value:1,label:"1. Prioriteringsregeln"},{value:2,label:"2. Negativa tal"},{value:3,label:"3. Potenser"},{value:4,label:"4. BrÃ¥ktal"},{value:5,label:"5. FÃ¶rlÃ¤ngning/FÃ¶rkortning"},{value:6,label:"6. Ã¶verslag"},{value:7,label:"7. Primtal & delbarhet"},{value:8,label:"8. Reella tal"},{value:9,label:"9. Blandad nivÃ¥"}], "Statistik": [{value:1,label:"1. Diagram"},{value:2,label:"2. Boxplot & spridning"}] };

        let userId;
        let allProblems=[], currentProblem=null, filteredProblems=[], currentScore=0, currentTotal=0, seenProblemIndices=[], currentMode='campaign';
        let campaignStreak=0, chaptersCleared={}, STREAK_TO_PASS=7, dailyTasks=0, dailyStreak=0, lastStudyDate="";
        let isCheckingAnswer=false, inactivityTimer;
        let attempts=0, currentScaffoldStep=0;
        
        let isDragging = false;
        let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;
        const calcHandle = document.getElementById('calcHandle');
        const calculatorWrapper = document.getElementById('calculatorWrapper');

        // --- CENTRAL RENDERING FUNCTION (BLOCK MODEL) ---
        function renderComplexContent(container, content) {
            container.innerHTML = ''; 

            if (Array.isArray(content)) {
                content.forEach(block => {
                    const div = document.createElement('div');
                    
                    if (block.type === 'text') {
                        div.className = "problem-text-block"; // Serif font
                        div.innerHTML = formatInlineMath(block.value);
                    } else if (block.type === 'math') {
                        div.className = "problem-math-block"; // Centered, large math
                        div.innerHTML = `$$${block.value}$$`;
                    }
                    
                    container.appendChild(div);
                });
            } else if (typeof content === 'object' && content !== null) {
                 // Fallback
                 const blocks = [];
                 if (content.text) blocks.push({type: 'text', value: content.text});
                 if (content.math) blocks.push({type: 'math', value: content.math});
                 if (content.textPost) blocks.push({type: 'text', value: content.textPost});
                 if (content.question) blocks.push({type: 'text', value: content.question}); 
                 
                 renderComplexContent(container, blocks);
                 return;
            } else {
                // Fallback for old strings - Treat as text block with enhanced formatting
                const div = document.createElement('div');
                div.className = "problem-text-block";
                div.innerHTML = formatStringFallback(content);
                container.appendChild(div);
            }

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetPromise([container]);
            }
        }

        function formatInlineMath(text) {
            // Allow inline math using single $
            let s = text.replace(/\$([^$]+)\$/g, "\\($1\\)");
            
            // Hantera MathJax-koder som inte var omslutna av $ (typiska strÃ¤ngar frÃ¥n gamla options)
            if (s.includes("\\cdot") || s.includes("\\frac") || s.includes("=")) {
                return formatStringFallback(s); 
            }
            
            return s;
        }

        // Enhanced fallback for strings: detects commands like \cdot and wraps them if missing delimiters
        function formatStringFallback(text) {
            if (!text) return "";
            let s = text;
            
            // 1. ErsÃ¤tt fula tecken
            s = s.replace(/\*/g, " \\cdot ").replace(/\^/g, "^");
            
            // 2. Hantera decimaltal i brÃ¥k (x/0,1) -> \frac{x}{0,1}
            s = s.replace(/([0-9a-zA-Z,]+)\s*\/\s*([0-9a-zA-Z,]+)/g, (match, p1, p2) => {
                 return `\\frac{${p1.replace(/,/g, '{,}')}}{${p2.replace(/,/g, '{,}')}}`;
            });
            
            // 3. Hitta MathJax-koder och wrappa dem om de inte redan Ã¤r det
            const mathPatterns = /(\\cdot|\\frac\{[^\}]+\}\{[^\}]+\}|[a-z]+\^\{?[0-9a-z]+\}?|[0-9a-z]+\s*=\s*[0-9a-z]+|\([0-9a-z]+\s*[\+\-\*\/]\s*[0-9a-z]+\))/gi; 
            
            if (s.match(mathPatterns)) {
                 return `\\(${s}\\)`;
            }
            
            // 4. Hantera kommatecken i Ã¶vrig text/tal (eftersom vi anvÃ¤nder Merriweather som standard)
            s = s.replace(/([0-9])\s*,/g, '$1{,}'); 

            return s;
        }

        function showSolution() {
            if (!currentProblem || !currentProblem.explanation_sv) { 
                document.getElementById('solutionText').textContent = "Det finns tyvÃ¤rr ingen fÃ¶rklaring till den hÃ¤r uppgiften."; 
            } else { 
                const container = document.getElementById('solutionText');
                renderComplexContent(container, currentProblem.explanation_sv);
            }
            
            document.getElementById('solutionInline').style.display = "block"; 
            const btn = document.getElementById('showSolutionBtn');
            if(btn) btn.style.display = "none"; 
        }

        // --- STANDARD FUNCTIONS ---

        function switchMode() {
            currentMode = document.getElementById('trainingMode').value;

            if (currentMode === 'free') {
                document.getElementById('freeTrainingFilters').classList.remove('hidden');
                document.getElementById('campaignFilters').classList.add('hidden');
                document.getElementById('modeDescription').textContent = "VÃ¤lj nivÃ¥ och Ã¤mne fÃ¶r typuppgifter.";
            } else {
                document.getElementById('campaignFilters').classList.remove('hidden');
                document.getElementById('freeTrainingFilters').classList.add('hidden');
                document.getElementById('modeDescription').textContent = "VÃ¤lj ett kapitel och trÃ¤na strukturerat.";
            }

            resetScore(true);
            loadAllProblems();
        }

        function markChapterCleared() {
            const campaign = document.getElementById('campaignNameFilter').value;
            const chapter = parseInt(document.getElementById('chapterPartFilter').value);
            if (!chaptersCleared[campaign]) { chaptersCleared[campaign] = {}; }
            chaptersCleared[campaign][chapter] = true;
            campaignStreak = 0; 
            saveScore(); 
            updateStreakDisplay();
            
            let label = "OkÃ¤nt kapitel";
            if (CAMPAIGN_LEVELS[campaign]) {
                const found = CAMPAIGN_LEVELS[campaign].find(p => p.value === chapter);
                if (found) label = found.label;
            }
            
            alert(`GRATTIS! Du har klarat ${campaign} - Del ${label}!`);
        }

        function getNiceStep(range){if(range===0)return 1;const t=8,r=range/t,m=Math.pow(10,Math.floor(Math.log10(r))),b=r/m;return b<1.5?1*m:b<3.5?2*m:5*m}
        function renderDrawData(canvas,d){
             const ctx = canvas.getContext('2d'); const w=canvas.width,h=canvas.height;
             ctx.fillStyle='#fff';ctx.fillRect(0,0,w,h);
             if(d.type==='table'){const cellW=120,cellH=50,startX=(w-cellW*2)/2,startY=(h-cellH*(d.rows.length+1))/2;ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.font='bold 20px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillStyle='#f3f4f6';ctx.fillRect(startX,startY,cellW,cellH);ctx.fillRect(startX+cellW,startY,cellW,cellH);ctx.strokeRect(startX,startY,cellW,cellH);ctx.strokeRect(startX+cellW,startY,cellW,cellH);ctx.fillStyle='#000';ctx.fillText(d.headers[0],startX+cellW/2,startY+cellH/2);ctx.fillText(d.headers[1],startX+cellW+cellW/2,startY+cellH/2);ctx.font='20px Arial';d.rows.forEach((r,i)=>{const y=startY+(i+1)*cellH;ctx.strokeRect(startX,y,cellW,cellH);ctx.strokeRect(startX+cellW,y,cellW,cellH);ctx.fillStyle='#000';ctx.fillText(r[0],startX+cellW/2,y+cellH/2);if(r[1]==='?') {ctx.fillStyle='#e11d48';ctx.font='bold 24px Arial';} else {ctx.fillStyle='#000';ctx.font='20px Arial';}ctx.fillText(r[1],startX+cellW+cellW/2,y+cellH/2);});
             } else if(d.type==='graph'){const pad=60,gW=w-2*pad,gH=h-2*pad,xMin=d.xRange[0],xMax=d.xRange[1],yMin=d.yRange[0],yMax=d.yRange[1];ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,h-pad);ctx.lineTo(w-pad,h-pad);ctx.stroke();const toCanvasX=x=>pad+(x-xMin)/(xMax-xMin)*gW,toCanvasY=y=>h-pad-(y-yMin)/(yMax-yMin)*gH;const xStep=getNiceStep(xMax-xMin),yStep=getNiceStep(yMax-yMin);ctx.font='14px Arial';ctx.textAlign='center';ctx.textBaseline='top';for(let i=Math.ceil(xMin/xStep)*xStep;i<=xMax;i+=xStep){const cx=toCanvasX(i);ctx.fillText(i,cx,h-pad+5);ctx.beginPath();ctx.moveTo(cx,h-pad);ctx.lineTo(cx,h-pad+5);ctx.stroke();}ctx.textAlign='right';ctx.textBaseline='middle';for(let i=Math.ceil(yMin/yStep)*yStep;i<=yMax;i+=yStep){const cy=toCanvasY(i);ctx.fillText(i,pad-10,cy);ctx.beginPath();ctx.moveTo(pad-5,cy);ctx.lineTo(pad,cy);ctx.stroke();}if(d.lines)d.lines.forEach((l,idx)=>{ctx.strokeStyle=['#E3004F','#2563eb','#16a34a'][idx%3];ctx.lineWidth=3;ctx.beginPath();let first=true;for(let x=xMin;x<=xMax;x+=0.1){const y=l.k*x+l.m;if(y>=yMin&&y<=yMax){const cx=toCanvasX(x),cy=toCanvasY(y);if(first){ctx.moveTo(cx,cy);first=false;}else{ctx.lineTo(cx,cy);}}}ctx.stroke();if(l.label){ctx.font='bold 16px Arial';ctx.fillStyle=ctx.strokeStyle;const lx=toCanvasX(xMax*0.8),ly=toCanvasY(l.k*xMax*0.8+l.m);ctx.fillText(l.label,lx+5,ly);}});if(d.points)d.points.forEach(p=>{ctx.fillStyle='#E3004F';ctx.beginPath();ctx.arc(toCanvasX(p.x),toCanvasY(p.y),8,0,2*Math.PI);ctx.fill();if(p.label){ctx.font='bold 14px Arial';ctx.fillStyle='#000';ctx.fillText(p.label,toCanvasX(p.x)+12,toCanvasY(p.y)-5);}});if(d.axisLabels){ctx.font='bold 16px Arial';ctx.fillStyle='#000';ctx.textAlign='center';ctx.fillText(d.axisLabels.x,w/2,h-15);ctx.save();ctx.translate(15,h/2);ctx.rotate(-Math.PI/2);ctx.fillText(d.axisLabels.y,0,0);ctx.restore();}
             } else if(d.type==='barChart'){const pad=70,gW=w-2*pad,gH=h-2*pad-20,numBars=d.data.length,barW=gW/numBars*0.6,gap=gW/numBars*0.4,maxVal=Math.max(...d.data.map(item=>item.value))*1.1;ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(pad,pad);ctx.lineTo(pad,h-pad);ctx.lineTo(w-pad,h-pad);ctx.stroke();d.data.forEach((item,i)=>{const barH=(item.value/maxVal)*gH,x=pad+i*(barW+gap)+gap/2,y=h-pad-barH;ctx.fillStyle='#f66909';ctx.fillRect(x,y,barW,barH);ctx.font='bold 16px Arial';ctx.fillStyle='#000';ctx.textAlign='center';ctx.fillText(item.value,x+barW/2,y-10);ctx.font='14px Arial';ctx.fillText(item.label,x+barW/2,h-pad+15);});if(d.yLabel){ctx.save();ctx.font='bold 16px Arial';ctx.translate(20,h/2);ctx.rotate(-Math.PI/2);ctx.textAlign='center';ctx.fillText(d.yLabel,0,0);ctx.restore();}}
        }
        
        function displayProblem(problem) {
            currentProblem = problem; attempts = 0; currentScaffoldStep = 0;
            document.getElementById('problemIdDisplay').textContent = problem.id || '';
            document.getElementById('problemCard').classList.remove('hidden');
            document.getElementById('statusMessage').classList.add('hidden');
            document.getElementById('solutionInline').style.display = 'none';
            document.getElementById('showSolutionBtn').style.display = 'none';
            document.getElementById('checkAnswerBtn').style.display = 'block';
            document.getElementById('checkAnswerBtn').disabled = false;
            document.getElementById('checkAnswerBtn').textContent = 'RÃ¤tta Svar';
            document.getElementById('nextProblemBtn').style.display = 'none';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('scaffoldingContainer').classList.add('hidden');

            // FIX: Use question_sv instead of problem_sv (matching Firebase data structure)
            const problemTextContainer = document.getElementById('problemText');
            const questionData = problem.question_sv || problem.problem_sv;
            renderComplexContent(problemTextContainer, questionData);

            const hasScaffolding = problem.scaffolding && problem.scaffolding.length > 0;
            const helpBtn = document.getElementById('helpBtn');
            if(hasScaffolding) helpBtn.style.display = 'block'; else helpBtn.style.display = 'none';

            const imgEl = document.getElementById('problemImage');
            const canvasEl = document.getElementById('problemCanvas');
            imgEl.style.display = 'none'; canvasEl.style.display = 'none';
            if (problem.imageUrl) { imgEl.src = problem.imageUrl; imgEl.style.display = 'block'; }
            if (problem.drawData) { canvasEl.style.display = 'block'; renderDrawData(canvasEl, problem.drawData); }

            const ac = document.getElementById('answerContainer');
            const type = problem.answerType || 'text';
            if (type === 'choice' && problem.options) {
                let optionsHtml = '<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">';
                problem.options.forEach((opt, i) => {
                    const optDisplay = (typeof opt === 'string') ? formatStringFallback(opt) : opt;
                    optionsHtml += `<button class="option-btn bg-white dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 p-4 rounded-lg text-lg font-medium text-gray-800 dark:text-gray-200 hover:border-praktiska-orange hover:bg-orange-50 dark:hover:bg-gray-600 transition" data-value="${i}">${optDisplay}</button>`;
                });
                optionsHtml += '</div><input type="hidden" id="answerInput" value="">';
                ac.innerHTML = optionsHtml;
                ac.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        ac.querySelectorAll('.option-btn').forEach(b => b.classList.remove('border-praktiska-orange', 'bg-orange-100', 'dark:bg-orange-900'));
                        e.target.classList.add('border-praktiska-orange', 'bg-orange-100', 'dark:bg-orange-900');
                        document.getElementById('answerInput').value = e.target.dataset.value;
                    });
                });
                if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([ac]);
            } else {
                ac.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Ditt Svar:</label><input type="${type==='number'?'number':'text'}" id="answerInput" class="w-full p-3.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange focus:outline-none text-lg placeholder-gray-400 dark:bg-gray-700 dark:text-white" placeholder="Skriv ditt svar...">`;
            }
            
            updateStreakDisplay();
        }

        function resetScore(clearTotal = false) {
            if (clearTotal) { currentScore = 0; currentTotal = 0; campaignStreak = 0; }
            seenProblemIndices = [];
            updateScoreDisplay();
            updateStreakDisplay();
        }
        function updateScoreDisplay() {
            document.getElementById('scoreDisplay').textContent = currentScore;
            document.getElementById('totalDisplay').textContent = currentTotal;
            document.getElementById('progressBar').style.width = currentTotal > 0 ? `${(currentScore / currentTotal) * 100}%` : '0%';
        }
        function updateStreakDisplay() {
            const container = document.getElementById('streakContainer');
            const section = document.getElementById('streakSection');
            if (currentMode !== 'campaign') { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            document.getElementById('streakDisplay').textContent = `${campaignStreak}/${STREAK_TO_PASS} ðŸ”¥`;
            const campaign = document.getElementById('campaignNameFilter').value;
            const chapter = parseInt(document.getElementById('chapterPartFilter').value);
            const cleared = chaptersCleared[campaign] && chaptersCleared[campaign][chapter];
            document.getElementById('trophyDisplay').textContent = cleared ? 'ðŸ†' : '';
            container.classList.remove('fire-low', 'fire-med', 'fire-high');
            if (campaignStreak >= 5) container.classList.add('fire-high');
            else if (campaignStreak >= 3) container.classList.add('fire-med');
            else if (campaignStreak >= 1) container.classList.add('fire-low');
        }
        function updateDailyUI() {
            document.getElementById('dailyCountDisplay').textContent = `${dailyTasks}/10`;
            document.getElementById('dailyProgressBar').style.width = `${Math.min(dailyTasks, 10) * 10}%`;
            document.getElementById('dailyStreakDisplay').textContent = `Dagar i rad: ${dailyStreak} ðŸ“…`;
        }
        function triggerConfetti(origin) {
            const colors = ['#f66909', '#fcd34d', '#10b981', '#3b82f6'];
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.innerHTML = ['ðŸŽ‰', 'â­', 'âœ¨', 'ðŸ”¥'][Math.floor(Math.random()*4)];
                p.style.left = `${origin.offsetLeft + origin.offsetWidth / 2}px`;
                p.style.top = `${origin.offsetTop}px`;
                p.style.setProperty('--tx', `${(Math.random() - 0.5) * 200}px`);
                p.style.setProperty('--ty', `${-Math.random() * 150 - 50}px`);
                p.style.setProperty('--rot', `${Math.random() * 360}deg`);
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1500);
            }
        }

        async function loadScore() {
            if (!userId) return;
            try {
                const docRef = doc(db, COLLECTION_PATHS.USER_SCORE + userId, 'progress');
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const d = snap.data();
                    currentScore = d.score || 0; currentTotal = d.total || 0;
                    chaptersCleared = d.chaptersCleared || {};
                    dailyTasks = d.dailyTasks || 0; dailyStreak = d.dailyStreak || 0; lastStudyDate = d.lastStudyDate || "";
                    updateScoreDisplay(); updateDailyUI();
                }
            } catch(e) { console.error("Load Score Error", e); }
        }
        async function saveScore() {
            if (!userId) return;
            try {
                const docRef = doc(db, COLLECTION_PATHS.USER_SCORE + userId, 'progress');
                await setDoc(docRef, { score: currentScore, total: currentTotal, chaptersCleared: chaptersCleared, dailyTasks: dailyTasks, dailyStreak: dailyStreak, lastStudyDate: lastStudyDate }, { merge: true });
            } catch(e) { console.error("Save Score Error", e); }
        }

        function populateChapterFilter() {
            const campaignName = document.getElementById('campaignNameFilter').value;
            const select = document.getElementById('chapterPartFilter');
            select.innerHTML = '';
            if (CAMPAIGN_LEVELS[campaignName]) {
                CAMPAIGN_LEVELS[campaignName].forEach(part => {
                    const opt = document.createElement('option');
                    opt.value = part.value;
                    opt.textContent = part.label;
                    select.appendChild(opt);
                });
            }
        }

        async function loadAllProblems() {
            document.getElementById('statusMessage').classList.remove('hidden');
            document.getElementById('problemCard').classList.add('hidden');
            allProblems = [];
            try {
                if (currentMode === 'free') {
                    const q = collection(db, COLLECTION_PATHS.FREE_TRAINING);
                    const snap = await getDocs(q);
                    snap.forEach(d => allProblems.push({ id: d.id, ...d.data() }));
                } else {
                    populateChapterFilter();
                    const campaignName = document.getElementById('campaignNameFilter').value;
                    const tasksPath = `${COLLECTION_PATHS.CAMPAIGN_ROOT}/${campaignName}/tasks`;
                    const q = collection(db, tasksPath);
                    const snap = await getDocs(q);
                    snap.forEach(d => allProblems.push({ id: d.id, ...d.data() }));
                    
                    // Debug: Log loaded problems
                    console.log("Loaded problems:", allProblems.length);
                    if (allProblems.length > 0) {
                        console.log("Sample problem fields:", Object.keys(allProblems[0]));
                    }
                }
                populateFilters();
                applyFiltersAndRender();
            } catch (e) {
                console.error("Error loading problems:", e);
                document.getElementById('statusMessage').innerHTML = `<p class="text-red-500">Kunde inte ladda uppgifter. FÃ¶rsÃ¶k igen.</p>`;
            }
        }

        function populateFilters() {
            if (currentMode === 'free') {
                const level = document.getElementById('levelFilter').value;
                const topicSelect = document.getElementById('topicFilter');
                topicSelect.innerHTML = '<option value="Alla">Alla Ã„mnen</option>';
                const topics = [...new Set(allProblems.filter(p => level === 'Alla' || p.level === level).map(p => p.topic))].filter(Boolean);
                topics.forEach(t => { const opt = document.createElement('option'); opt.value = t; opt.textContent = t; topicSelect.appendChild(opt); });
                topicSelect.disabled = topics.length === 0;
            }
        }
        
        function applyFiltersAndRender() {
            if (currentMode === 'free') {
                const level = document.getElementById('levelFilter').value;
                const topic = document.getElementById('topicFilter').value;
                filteredProblems = allProblems.filter(p => (level === 'Alla' || p.level === level) && (topic === 'Alla' || p.topic === topic));
            } else {
                const campaignLevel = document.getElementById('campaignLevelFilter').value;
                const chapterPart = parseInt(document.getElementById('chapterPartFilter').value);
                
                // FIX: Use campaignLevel and chapterLevel instead of level and chapterPart
                filteredProblems = allProblems.filter(p => {
                    const matchLevel = p.campaignLevel === campaignLevel || p.level === campaignLevel;
                    const matchChapter = p.chapterLevel === chapterPart || p.chapterPart === chapterPart;
                    return matchLevel && matchChapter;
                });
                
                // Debug logging
                console.log("Filter values - campaignLevel:", campaignLevel, "chapterPart:", chapterPart);
                console.log("Filtered problems count:", filteredProblems.length);
            }
            
            if (filteredProblems.length === 0) {
                document.getElementById('statusMessage').classList.remove('hidden');
                document.getElementById('statusMessage').innerHTML = `<p class="text-gray-500">Inga uppgifter hittades fÃ¶r dina filter.</p>`;
                document.getElementById('problemCard').classList.add('hidden');
            } else {
                if (seenProblemIndices.length >= filteredProblems.length) seenProblemIndices = [];
                let randomIndex;
                do { randomIndex = Math.floor(Math.random() * filteredProblems.length); } while (seenProblemIndices.includes(randomIndex) && seenProblemIndices.length < filteredProblems.length);
                seenProblemIndices.push(randomIndex);
                displayProblem(filteredProblems[randomIndex]);
            }
        }

        function checkAnswer() {
            try {
                if (isCheckingAnswer) return;
                isCheckingAnswer = true; 
                
                const inp = document.getElementById('answerInput');
                if (!inp) { return; } 
                const uAns = inp.value.trim();
                const cAns = String(currentProblem.correctAnswer).trim();
                let correct = false;
                const clean = (s) => s.replace(/,/g, '.').replace(/[^0-9.\-]/g, '');
                if(parseFloat(clean(uAns)) === parseFloat(clean(cAns)) || uAns.toLowerCase() === cAns.toLowerCase()) correct = true;

                const fb = document.getElementById('feedback');
                currentTotal++;

                if(correct) {
                    fb.innerHTML = `<div class="text-lg font-bold text-green-800 mb-1">RÃ¤tt svar!</div>`;
                    fb.className = "mt-6 text-center p-4 rounded-xl bg-green-100 text-green-800 border border-green-200";
                    
                    document.getElementById('scaffoldingContainer').classList.add('hidden');

                    if(attempts === 0) {
                        currentScore++; campaignStreak++; triggerConfetti(document.getElementById('checkAnswerBtn'));
                        const today = new Date().toISOString().split('T')[0];
                        if(lastStudyDate === today) dailyTasks++;
                        else { dailyTasks = 1; if(lastStudyDate) dailyStreak = (new Date(lastStudyDate).getTime() === new Date().getTime() - 86400000) ? dailyStreak+1 : 1; else dailyStreak=1; }
                        lastStudyDate = today;
                        updateDailyUI();
                        saveScore();
                    }
                    if(currentMode === 'campaign' && campaignStreak >= STREAK_TO_PASS) markChapterCleared();
                    document.getElementById('checkAnswerBtn').style.display = "none"; document.getElementById('helpBtn').style.display = "none"; document.getElementById('nextProblemBtn').style.display = "block";
                } else {
                    attempts++;
                    fb.style.display = "block";
                    if(attempts === 1) {
                        // USE NEW RENDERER FOR HINT
                        fb.className = "mt-6 text-center p-6 rounded-xl bg-yellow-50 border-2 border-yellow-200 shadow-sm";
                        fb.innerHTML = `<div class="mb-2 text-lg font-bold text-yellow-800">Inte riktigt rÃ¤tt Ã¤n...</div>`;
                        
                        const hintContentDiv = document.createElement('div');
                        hintContentDiv.className = "text-gray-700 mb-3";
                        
                        // Check if hint_sv is object or string
                        if(currentProblem.hint_sv) {
                             renderComplexContent(hintContentDiv, currentProblem.hint_sv);
                        } else {
                             hintContentDiv.textContent = "FÃ¶rsÃ¶k igen! Kontrollera dina berÃ¤kningar.";
                        }
                        fb.appendChild(hintContentDiv);
                        fb.innerHTML += `<div class="text-sm font-semibold text-yellow-700">Prova en gÃ¥ng till!</div>`;

                        const btn = document.getElementById('checkAnswerBtn');
                        btn.disabled = false;
                        btn.textContent = "FÃ¶rsÃ¶k igen";
                        
                        document.getElementById('helpBtn').style.display = "none";
                        isCheckingAnswer = false; 
                        return; 

                    } else {
                        // SECOND FAIL
                        fb.innerHTML = `<div class="font-bold text-red-800 mb-2">TyvÃ¤rr, det blev fel igen.</div><div>RÃ¤tt svar var: ${formatStringFallback(cAns)}</div>`;
                        fb.className = "mt-6 text-center font-medium p-6 rounded-xl bg-red-50 border-2 border-red-200";
                        if (window.MathJax && window.MathJax.typesetPromise) MathJax.typesetPromise([fb]);

                        campaignStreak = 0;
                        document.getElementById('checkAnswerBtn').style.display = "none"; document.getElementById('helpBtn').style.display = "none"; document.getElementById('nextProblemBtn').style.display = "block"; 
                        
                        if (currentProblem.explanation_sv) {
                             // Show button if solution exists
                             const solBtn = document.getElementById('showSolutionBtn');
                             if(solBtn) solBtn.style.display = "inline-block";
                        }
                    }
                }
                updateScoreDisplay(); updateStreakDisplay();
                isCheckingAnswer = false;
            } catch (e) {
                console.error("Check Answer Error:", e);
            } finally {
                isCheckingAnswer = false;
            }
        }

        function startScaffolding() {
            document.getElementById('helpBtn').style.display = "none";
            document.getElementById('scaffoldingContainer').classList.remove('hidden');
            currentScaffoldStep = 0; renderScaffoldStep();
        }

        function renderScaffoldStep() {
            const steps = currentProblem.scaffolding;
            const container = document.getElementById('scaffoldingContainer');
            const content = document.getElementById('scaffoldingContent');
            const actions = document.getElementById('scaffoldingActions');
            
            if (!currentProblem.scaffolding || currentScaffoldStep >= steps.length) { 
                container.classList.add('hidden');
                // SCAFFOLDING DONE -> Show Answer Input
                const ac = document.getElementById('answerContainer');
                ac.classList.remove('hidden');
                const type = currentProblem.answerType || 'text';
                ac.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar (endast siffror):</label><input type="${type==='number'?'number':'text'}" id="answerInput" class="w-full p-3.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-praktiska-orange focus:border-praktiska-orange focus:outline-none text-lg placeholder-gray-400 dark:bg-gray-700 dark:text-white" placeholder="Skriv ditt svar...">`;
                
                const fb = document.getElementById('feedback');
                fb.innerHTML = `<div class="text-lg font-bold text-green-800 mb-1">Snyggt! Nu fixar du resten.</div>`;
                fb.className = "mt-6 text-center p-4 rounded-xl bg-green-50 text-green-800 border border-green-100 mb-4";
                fb.style.display = 'block';

                const chk = document.getElementById('checkAnswerBtn');
                chk.style.display = "block"; 
                chk.disabled = false;
                return;
            }
            const step = steps[currentScaffoldStep];
            content.innerHTML = ''; actions.innerHTML = '';
            
            // USE NEW RENDERER FOR STEPS
            const stepWrapper = document.createElement('div');
            
            if(step.type === 'highlight' || step.type === 'info') {
                if (step.content) {
                     renderComplexContent(stepWrapper, step.content);
                } else {
                     const data = {
                        text: step.text,
                        math: step.math, 
                        textPost: step.textPost
                     };
                     renderComplexContent(stepWrapper, data);
                }
                
                const b = document.createElement('button'); 
                b.className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mt-4"; 
                b.textContent= (step.type === 'highlight') ? "NÃ¤sta" : "Okej!";
                b.onclick = () => { 
                     if (step.type === 'highlight') {
                         currentScaffoldStep++; renderScaffoldStep();
                     } else {
                         container.classList.add('hidden'); 
                         const ac = document.getElementById('answerContainer');
                         ac.classList.remove('hidden');
                         const type = currentProblem.answerType || 'text';
                         ac.innerHTML = `<label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Svar:</label><input type="${type==='number'?'number':'text'}" id="answerInput" class="w-full p-3.5 border rounded-lg text-lg dark:bg-gray-700 dark:text-white">`;
                         document.getElementById('checkAnswerBtn').style.display = "block"; 
                         document.getElementById('checkAnswerBtn').disabled = false; 
                     }
                };
                actions.appendChild(b);
            } else if(step.type === 'choice') {
                const questionDiv = document.createElement('div');
                // Support new content array or old properties
                if (step.content) {
                    renderComplexContent(questionDiv, step.content);
                } else {
                    const qData = { text: step.question, math: step.math };
                    renderComplexContent(questionDiv, qData);
                }
                stepWrapper.appendChild(questionDiv);

                const grid = document.createElement('div'); 
                grid.className = "grid grid-cols-1 gap-2 mt-4";
                
                step.options.forEach((opt, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "bg-white border-2 border-gray-200 p-3 rounded-lg hover:border-blue-500 text-left dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200 w-full"; // w-full for better look
                    
                    if (typeof opt === 'object' && Array.isArray(opt)) {
                         // Fall 1: Listan av block (det nya formatet)
                         const btnContent = document.createElement('span');
                         btnContent.className = 'choice-btn-content'; 
                         renderComplexContent(btnContent, opt); // Skicka in listan av block
                         btn.appendChild(btnContent);
                    } else if (typeof opt === 'string') {
                         // Fall 2: Gammal strÃ¤ng (anvÃ¤nd fallback formatter)
                         const btnContent = document.createElement('span');
                         btnContent.className = 'choice-btn-content';
                         btnContent.innerHTML = formatStringFallback(opt); 
                         btn.appendChild(btnContent);
                    } else if (typeof opt === 'object' && opt.type) {
                         // Fall 3: Option Ã¤r ett enda block (t.ex. {type: "math", value: "..."})
                         const btnContent = document.createElement('span');
                         btnContent.className = 'choice-btn-content';
                         renderComplexContent(btnContent, [opt]);
                         btn.appendChild(btnContent);
                    }

                    btn.onclick = () => {
                        if(idx === step.correctIndex) {
                            btn.classList.add('bg-green-100', 'border-green-500', 'dark:bg-green-900');
                            setTimeout(() => { currentScaffoldStep++; renderScaffoldStep(); }, 600);
                        } else {
                            btn.classList.add('bg-red-100', 'border-red-500', 'dark:bg-red-900');
                        }
                    };
                    grid.appendChild(btn);
                });
                stepWrapper.appendChild(grid);
            }
            content.appendChild(stepWrapper);
        }

        // Drag and Drop
        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            if (e.target === calcHandle || calcHandle.contains(e.target)) {
                isDragging = true;
            }
        }
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                setTranslate(currentX, currentY, calculatorWrapper);
            }
        }
        function setTranslate(xPos, yPos, el) {
            el.style.transform = "translate3d(" + xPos + "px, " + yPos + "px, 0)";
        }

        // Kalkylator Logic
        const calcButtons = document.getElementById('calcButtons');
        const calcDisplay = document.getElementById('calcDisplay'); 
        let currentInput = '0', operator = null, firstOperand = null, awaitingSecondOperand = false;
        
        function clearOperatorHighlight() { document.querySelectorAll('.calc-op').forEach(btn => { btn.classList.remove('calc-op-active'); }); }
        calcButtons.addEventListener('click', (e) => {
            if (!e.target.classList.contains('calc-button')) return;
            const value = e.target.dataset.value;
            if (e.target.classList.contains('calc-num') || value === '.') {
                clearOperatorHighlight(); 
                if (awaitingSecondOperand) { currentInput = value === '.' ? '0.' : value; awaitingSecondOperand = false; } 
                else if (currentInput === '0' && value !== '.') { currentInput = value; } 
                else if (value === '.' && currentInput.includes('.')) { } 
                else { currentInput += value; }
            } else if (e.target.classList.contains('calc-op')) {
                if (value === '=') {
                    if (operator && firstOperand !== null) { currentInput = calculate(firstOperand, operator, parseFloat(currentInput)); operator = null; firstOperand = null; awaitingSecondOperand = true; }
                    clearOperatorHighlight();
                } else {
                    clearOperatorHighlight(); e.target.classList.add('calc-op-active');
                    if (firstOperand === null) { firstOperand = parseFloat(currentInput); } 
                    else if (operator) { const result = calculate(firstOperand, operator, parseFloat(currentInput)); firstOperand = result; currentInput = result; }
                    operator = value; awaitingSecondOperand = true;
                }
            } else if (e.target.classList.contains('calc-func')) {
                clearOperatorHighlight();
                if (value === 'AC') { currentInput = '0'; operator = null; firstOperand = null; awaitingSecondOperand = false; } 
                else if (value === 'Â±') { currentInput = String(parseFloat(currentInput) * -1); } 
                else if (value === '%') { currentInput = String(parseFloat(currentInput) / 100); }
            }
            calcDisplay.textContent = currentInput.substring(0, 10);
        });
        function calculate(n1, op, n2) { switch (op) { case '+': return String(n1 + n2); case '-': return String(n1 - n2); case 'Ã—': return String(n1 * n2); case 'Ã·': return String(n1 / n2); default: return n2; } }


        // --- START AV APPEN ---
        document.addEventListener('DOMContentLoaded', () => {
            // DOM element references
            const trainingMode = document.getElementById('trainingMode');
            const campaignNameFilter = document.getElementById('campaignNameFilter');
            const campaignLevelFilter = document.getElementById('campaignLevelFilter');
            const chapterPartFilter = document.getElementById('chapterPartFilter');
            const levelFilter = document.getElementById('levelFilter');
            const topicFilter = document.getElementById('topicFilter');
            const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');
            const toggleCalculatorBtn = document.getElementById('toggleCalculatorBtn');
            const closeCalculator = document.getElementById('closeCalculator');

            // KOPPLA HÃ„NDELSELYSSNARE
            trainingMode.addEventListener('change', switchMode);
            campaignNameFilter.addEventListener('change', () => { resetScore(true); loadAllProblems(); });
            campaignLevelFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
            chapterPartFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
            levelFilter.addEventListener('change', () => { resetScore(true); populateFilters(); applyFiltersAndRender(); });
            topicFilter.addEventListener('change', () => { resetScore(true); applyFiltersAndRender(); });
            document.getElementById('checkAnswerBtn').addEventListener('click', checkAnswer);
            document.getElementById('nextProblemBtn').addEventListener('click', applyFiltersAndRender);
            document.getElementById('helpBtn').addEventListener('click', startScaffolding);
            document.getElementById('showSolutionBtn').addEventListener('click', showSolution);
            
            // Drag-hÃ¤ndelser
            if (calcHandle) {
                calcHandle.addEventListener("mousedown", dragStart);
                calcHandle.addEventListener("touchstart", dragStart, {passive: false});
                document.addEventListener("mouseup", dragEnd);
                document.addEventListener("touchend", dragEnd);
                document.addEventListener("mousemove", drag);
                document.addEventListener("touchmove", drag, {passive: false});
            }

            // Dark mode toggle
            if(toggleDarkModeBtn) {
                toggleDarkModeBtn.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                });
            }

            // Calculator toggle and close
            if (closeCalculator) {
                closeCalculator.addEventListener('click', () => {
                    calculatorWrapper.style.display = 'none';
                });
            }
            if (toggleCalculatorBtn) {
                toggleCalculatorBtn.addEventListener('click', () => {
                    calculatorWrapper.style.display = calculatorWrapper.style.display === 'none' ? 'block' : 'none';
                });
            }

            // AUTHENTICATION
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await loadScore();
                    loadAllProblems();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth error:", error);
                        loadAllProblems(); // Load anyway
                    }
                }
            });
        });
    </script>
</body>
</html>
